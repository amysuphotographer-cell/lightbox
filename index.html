<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lightbox - 专业影像甄选台</title>
    <!-- JSZip库用于导出文件夹 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap');

        :root {
            /* Midnight Blue-Purple Palette */
            --midnight-bg: #0a0a1f;
            --midnight-deep: #060612;
            --midnight-purple: #1a1a3e;
            --midnight-blue: #0d0d2b;

            /* Neon & Glow Colors */
            --neon-white: #ffffff;
            --neon-blue: #6b7fff;
            --neon-purple: #8b5cf6;
            --neon-violet: #a78bfa;

            /* Amber Accent */
            --amber-primary: #ffb84d;
            --amber-bright: #ffa500;
            --amber-glow: rgba(255, 184, 77, 0.4);

            /* Accent Colors - 紫粉蓝点缀 */
            --accent-pink: #FF6EC7;
            --accent-pink-light: #FFB3E6;
            --accent-blue: #6B9FFF;
            --accent-blue-light: #A8C7FF;
            --accent-cyan: #5DE7FF;
            --color-gray: #6b7280;
            --color-gray-light: #9ca3af;

            /* Attitude Colors - 态度评分按钮 */
            --attitude-like: #10b981;        /* 喜欢 - 绿色 */
            --attitude-like-light: #34d399;
            --attitude-like-glow: rgba(16, 185, 129, 0.4);
            --attitude-neutral: #f59e0b;     /* 一般 - 黄色 */
            --attitude-neutral-light: #fbbf24;
            --attitude-neutral-glow: rgba(245, 158, 11, 0.4);
            --attitude-dislike: #ef4444;     /* 不喜欢 - 红色 */
            --attitude-dislike-light: #f87171;
            --attitude-dislike-glow: rgba(239, 68, 68, 0.4);

            /* Dark Backgrounds */
            --bg-primary: #0a0a1f;
            --bg-secondary: #050508;
            --bg-card: #0d0d1a;
            --bg-control-panel: #0a0a0a;

            /* Light Text for Dark Theme */
            --text-primary: #e5e7eb;
            --text-secondary: #9ca3af;
            --text-muted: #6b7280;
            --text-title: #ffffff;

            /* Purple Glow Effects */
            --purple-glow: rgba(139, 92, 246, 0.3);
            --purple-glow-strong: rgba(139, 92, 246, 0.6);
            --border-color: rgba(139, 92, 246, 0.2);
            --shadow-lg: 0 20px 60px rgba(139, 92, 246, 0.4);
            --shadow-md: 0 8px 24px rgba(139, 92, 246, 0.3);
            --shadow-neon: 0 0 20px rgba(255, 255, 255, 0.5);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: radial-gradient(ellipse at top, var(--midnight-purple) 0%, var(--midnight-deep) 50%, var(--midnight-bg) 100%);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(139, 92, 246, 0.04) 0%, transparent 70%);
            pointer-events: none;
            animation: float 30s ease-in-out infinite;
        }

        body::after {
            content: '';
            position: fixed;
            bottom: -30%;
            left: -30%;
            width: 60%;
            height: 60%;
            background: radial-gradient(circle, rgba(107, 127, 255, 0.03) 0%, transparent 70%);
            pointer-events: none;
            animation: float 35s ease-in-out infinite reverse;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0); }
            50% { transform: translate(-10%, 10%); }
        }

        .container {
            max-width: 1920px;
            margin: 0 auto;
            padding: 12px 15px;
            position: relative;
            z-index: 1;
        }

        header {
            text-align: center;
            margin-bottom: 15px;
            animation: fadeInDown 0.8s ease-out;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        h1 {
            font-family: 'Rajdhani', sans-serif;
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--neon-white);
            margin-bottom: 8px;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            text-shadow: 0 2px 10px rgba(255, 255, 255, 0.3);
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 0.95rem;
            font-weight: 400;
            letter-spacing: 0.08em;
        }

        .controls {
            background: var(--bg-control-panel);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 16px 18px;
            margin-bottom: 18px;
            backdrop-filter: blur(10px);
            animation: fadeInUp 0.8s ease-out 0.2s both;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .control-group {
            display: flex;
            gap: 16px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 12px;
        }

        .control-group:last-child {
            margin-bottom: 0;
        }

        label {
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.95rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        input[type="file"] {
            display: none;
        }

        /* Button Animations */
        @keyframes quickAddPulsate {
            0%, 100% {
                box-shadow:
                    0 0 20px rgba(255, 215, 0, 0.6),
                    0 0 40px rgba(255, 215, 0, 0.4),
                    0 0 60px rgba(255, 215, 0, 0.2),
                    0 4px 16px rgba(255, 215, 0, 0.5);
            }
            50% {
                box-shadow:
                    0 0 30px rgba(255, 215, 0, 0.8),
                    0 0 60px rgba(255, 215, 0, 0.6),
                    0 0 90px rgba(255, 215, 0, 0.4),
                    0 6px 24px rgba(255, 215, 0, 0.7);
            }
        }

        @keyframes whiteNeonPulse {
            0%, 100% {
                box-shadow:
                    0 0 20px rgba(255, 255, 255, 0.6),
                    0 0 40px rgba(255, 255, 255, 0.4),
                    0 0 60px rgba(255, 255, 255, 0.2);
            }
            50% {
                box-shadow:
                    0 0 30px rgba(255, 255, 255, 0.8),
                    0 0 60px rgba(255, 255, 255, 0.6),
                    0 0 90px rgba(255, 255, 255, 0.4);
            }
        }

        @keyframes uvPulse {
            0%, 100% {
                box-shadow:
                    0 0 20px rgba(138, 43, 226, 0.6),
                    0 0 40px rgba(138, 43, 226, 0.4),
                    0 0 60px rgba(138, 43, 226, 0.2);
            }
            50% {
                box-shadow:
                    0 0 30px rgba(138, 43, 226, 0.8),
                    0 0 60px rgba(138, 43, 226, 0.6),
                    0 0 90px rgba(138, 43, 226, 0.4);
            }
        }

        /* Base Button Styles */
        .file-upload-btn, .load-btn {
            border: none;
            padding: 14px 32px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 700;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        /* Purple - Add Folder (主要操作按钮 - 深紫色实心) */
        .btn-add-folder {
            background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
            color: #fff;
            border: none;
            box-shadow:
                0 0 20px rgba(124, 58, 237, 0.6),
                0 0 40px rgba(124, 58, 237, 0.4),
                0 4px 16px rgba(124, 58, 237, 0.5);
            font-weight: 700;
            letter-spacing: 0.05em;
        }

        .btn-add-folder:hover {
            transform: translateY(-2px);
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            box-shadow:
                0 0 30px rgba(139, 92, 246, 0.8),
                0 0 60px rgba(139, 92, 246, 0.6),
                0 6px 24px rgba(139, 92, 246, 0.7);
        }

        /* Light Purple - Quick Add (次要功能幽灵按钮 - 浅紫) */
        .btn-quick-add {
            background: transparent;
            color: #c4b5fd;
            border: 2px solid #c4b5fd;
            box-shadow:
                0 0 10px rgba(196, 181, 253, 0.3),
                0 0 20px rgba(196, 181, 253, 0.2);
            text-shadow:
                0 0 10px rgba(196, 181, 253, 0.6),
                0 0 20px rgba(196, 181, 253, 0.4);
        }

        .btn-quick-add:hover {
            transform: translateY(-2px);
            background: rgba(196, 181, 253, 0.1);
            box-shadow:
                0 0 15px rgba(196, 181, 253, 0.5),
                0 0 30px rgba(196, 181, 253, 0.3),
                0 4px 16px rgba(196, 181, 253, 0.2);
            text-shadow:
                0 0 15px rgba(196, 181, 253, 0.8),
                0 0 30px rgba(196, 181, 253, 0.6);
        }

        /* Medium Purple - Load Images (幽灵按钮 - 中紫) */
        .btn-load-images {
            background: transparent;
            color: #a78bfa;
            border: 2px solid #a78bfa;
            box-shadow:
                0 0 15px rgba(167, 139, 250, 0.4),
                0 0 30px rgba(167, 139, 250, 0.3);
            text-shadow:
                0 0 10px rgba(167, 139, 250, 0.8),
                0 0 20px rgba(167, 139, 250, 0.6);
        }

        .btn-load-images:hover {
            transform: translateY(-2px);
            background: rgba(167, 139, 250, 0.1);
            box-shadow:
                0 0 20px rgba(167, 139, 250, 0.6),
                0 0 40px rgba(167, 139, 250, 0.4),
                0 4px 16px rgba(167, 139, 250, 0.3);
            text-shadow:
                0 0 15px rgba(167, 139, 250, 1),
                0 0 30px rgba(167, 139, 250, 0.8);
        }

        /* Dark Purple - Clear Folders (危险操作幽灵按钮 - 暗紫红) */
        .btn-clear-folders {
            background: transparent;
            color: #c084fc;
            border: 2px solid #c084fc;
            box-shadow:
                0 0 20px rgba(192, 132, 252, 0.6),
                0 0 40px rgba(192, 132, 252, 0.4),
                0 0 60px rgba(192, 132, 252, 0.2);
            text-shadow:
                0 0 15px rgba(192, 132, 252, 1),
                0 0 30px rgba(192, 132, 252, 0.8),
                0 0 45px rgba(192, 132, 252, 0.6);
            font-weight: 600;
        }

        .btn-clear-folders:hover {
            transform: translateY(-2px);
            background: rgba(192, 132, 252, 0.15);
            box-shadow:
                0 0 30px rgba(192, 132, 252, 0.8),
                0 0 60px rgba(192, 132, 252, 0.6),
                0 0 90px rgba(192, 132, 252, 0.4),
                0 6px 24px rgba(192, 132, 252, 0.5);
            text-shadow:
                0 0 20px rgba(192, 132, 252, 1),
                0 0 40px rgba(192, 132, 252, 0.9),
                0 0 60px rgba(192, 132, 252, 0.7);
        }

        .file-upload-btn::before, .load-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.4);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .file-upload-btn:hover::before, .load-btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .file-upload-btn:hover, .load-btn:hover {
            transform: translateY(-2px);
            box-shadow:
                0 0 30px var(--amber-glow),
                0 0 60px var(--amber-glow),
                0 0 90px rgba(255, 184, 77, 0.3),
                0 8px 32px rgba(255, 165, 0, 0.6);
        }

        .file-upload-btn:active, .load-btn:active {
            transform: translateY(0);
        }

        /* SVG图标样式 */
        .folder-icon {
            display: inline-block;
            width: 1.1em;
            height: 1em;
            vertical-align: -0.125em;
            margin-right: 6px;
        }

        .folder-icon svg {
            width: 100%;
            height: 100%;
            fill: currentColor;
        }

        input[type="number"] {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            color: var(--text-primary);
            padding: 12px 20px;
            border-radius: 12px;
            font-size: 1rem;
            width: 100px;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        input[type="number"]:focus {
            outline: none;
            border-color: var(--neon-purple);
            box-shadow: 0 0 0 4px var(--purple-glow),
                        0 0 20px var(--purple-glow);
        }

        .stats-panel {
            background: var(--bg-control-panel);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 24px;
            animation: fadeInUp 0.8s ease-out 0.4s both;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
        }

        .stat-item {
            text-align: center;
            padding: 14px 16px;
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            position: relative;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
        }

        .stat-item:hover {
            transform: translateY(-4px);
            border-color: var(--neon-purple);
            box-shadow:
                0 0 15px rgba(139, 92, 246, 0.4),
                0 0 30px rgba(139, 92, 246, 0.2),
                0 8px 20px rgba(0, 0, 0, 0.6);
        }

        .stat-progress-bar {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 2px;
            margin-top: 12px;
            overflow: hidden;
        }

        .stat-progress-fill {
            height: 100%;
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 2px;
        }

        .stat-progress-fill.like {
            background: linear-gradient(90deg, var(--attitude-like) 0%, var(--attitude-like-light) 100%);
            box-shadow: 0 0 8px var(--attitude-like-glow);
        }

        .stat-progress-fill.neutral {
            background: linear-gradient(90deg, var(--attitude-neutral) 0%, var(--attitude-neutral-light) 100%);
            box-shadow: 0 0 8px var(--attitude-neutral-glow);
        }

        .stat-progress-fill.dislike {
            background: linear-gradient(90deg, var(--attitude-dislike) 0%, var(--attitude-dislike-light) 100%);
            box-shadow: 0 0 8px var(--attitude-dislike-glow);
        }

        .stat-progress-fill.unrated {
            background: linear-gradient(90deg, rgba(155, 143, 165, 0.6) 0%, rgba(155, 143, 165, 0.8) 100%);
        }

        /* 快捷键帮助模态框 */
        .help-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            z-index: 10000;
            animation: fadeIn 0.2s ease;
        }

        .help-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .help-content {
            background: var(--bg-secondary);
            border-radius: 20px;
            max-width: 700px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
            animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .help-header {
            padding: 30px 40px 20px;
            border-bottom: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .help-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .help-close {
            background: none;
            border: none;
            font-size: 2rem;
            color: var(--text-muted);
            cursor: pointer;
            padding: 0;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .help-close:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            transform: rotate(90deg);
        }

        .help-body {
            padding: 30px 40px;
        }

        .help-section {
            margin-bottom: 30px;
        }

        .help-section:last-child {
            margin-bottom: 0;
        }

        .help-section-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary-purple);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .help-shortcuts {
            display: grid;
            gap: 12px;
        }

        .help-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            border: 1px solid var(--border-color);
            transition: all 0.2s ease;
        }

        .help-item:hover {
            background: rgba(255, 255, 255, 0.06);
            border-color: var(--primary-purple);
            transform: translateX(4px);
        }

        .help-item-desc {
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .help-item-keys {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        kbd {
            display: inline-block;
            padding: 6px 12px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-primary);
            background: rgba(139, 92, 246, 0.15);
            border: 2px solid var(--primary-purple);
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            min-width: 32px;
            text-align: center;
        }

        .help-item-keys .help-or {
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .help-tips {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(236, 72, 153, 0.1) 100%);
            border: 2px solid rgba(139, 92, 246, 0.3);
            border-radius: 12px;
            padding: 16px 20px;
        }

        .help-tips ul {
            margin: 0;
            padding-left: 20px;
        }

        .help-tips li {
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.8;
            margin-bottom: 6px;
        }

        .help-tips li:last-child {
            margin-bottom: 0;
        }

        .highlight-like {
            color: #10b981;
            font-weight: 600;
        }

        .highlight-neutral {
            color: #f59e0b;
            font-weight: 600;
        }

        .highlight-dislike {
            color: #ef4444;
            font-weight: 600;
        }

        .help-footer {
            padding: 20px 40px;
            border-top: 2px solid var(--border-color);
            text-align: center;
        }

        .help-tagline {
            color: var(--text-muted);
            font-size: 0.9rem;
            font-style: italic;
        }

        /* 滚动条样式 for help modal */
        .help-content::-webkit-scrollbar {
            width: 8px;
        }

        .help-content::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }

        .help-content::-webkit-scrollbar-thumb {
            background: var(--primary-purple);
            border-radius: 4px;
        }

        .help-content::-webkit-scrollbar-thumb:hover {
            background: var(--primary-pink);
        }

        /* 预览悬浮框 */
        .preview-tooltip {
            display: none;
            position: fixed;
            background: var(--bg-secondary);
            border: 2px solid var(--primary-purple);
            border-radius: 16px;
            padding: 20px;
            max-width: 600px;
            max-height: 500px;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            z-index: 10000;
            backdrop-filter: blur(10px);
            animation: tooltipFadeIn 0.2s ease;
        }

        @keyframes tooltipFadeIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .preview-tooltip.active {
            display: block;
        }

        .preview-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 16px;
            text-align: center;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--border-color);
        }

        .preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 12px;
        }

        .preview-image-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid var(--border-color);
            transition: all 0.3s ease;
            background: var(--bg-primary);
        }

        .preview-image-item:hover {
            transform: scale(1.05);
            border-color: var(--primary-purple);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
        }

        .preview-image-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .preview-image-name {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0, 0, 0, 0.9));
            color: white;
            font-size: 0.65rem;
            padding: 4px 6px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .preview-empty {
            text-align: center;
            color: var(--text-muted);
            padding: 40px 20px;
            font-size: 0.95rem;
        }

        /* 滚动条样式 */
        .preview-tooltip::-webkit-scrollbar {
            width: 8px;
        }

        .preview-tooltip::-webkit-scrollbar-track {
            background: var(--bg-primary);
            border-radius: 4px;
        }

        .preview-tooltip::-webkit-scrollbar-thumb {
            background: var(--primary-purple);
            border-radius: 4px;
        }

        .preview-tooltip::-webkit-scrollbar-thumb:hover {
            background: var(--light-purple);
        }

        .stat-percentage {
            font-size: 2.2rem;
            font-weight: 600;
            margin-bottom: 4px;
            line-height: 1.1;
        }

        .stat-item.like .stat-percentage {
            background: linear-gradient(135deg, var(--attitude-like) 0%, var(--attitude-like-light) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-item.neutral .stat-percentage {
            background: linear-gradient(135deg, var(--attitude-neutral) 0%, var(--attitude-neutral-light) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-item.dislike .stat-percentage {
            background: linear-gradient(135deg, var(--attitude-dislike) 0%, var(--attitude-dislike-light) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-value {
            font-size: 1.2rem;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 3px;
            line-height: 1.2;
        }

        .stat-label {
            color: var(--text-muted);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            font-weight: 500;
            opacity: 0.8;
        }

        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .image-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            animation: scaleIn 0.6s ease-out both;
            position: relative;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.6);
        }

        .image-card:hover {
            transform: translateY(-8px);
            box-shadow:
                0 0 20px rgba(139, 92, 246, 0.4),
                0 0 40px rgba(139, 92, 246, 0.2),
                0 8px 32px rgba(0, 0, 0, 0.8);
            border-color: var(--neon-purple);
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .image-card:nth-child(1) { animation-delay: 0.1s; }
        .image-card:nth-child(2) { animation-delay: 0.2s; }
        .image-card:nth-child(3) { animation-delay: 0.3s; }
        .image-card:nth-child(4) { animation-delay: 0.4s; }
        .image-card:nth-child(5) { animation-delay: 0.5s; }
        .image-card:nth-child(6) { animation-delay: 0.6s; }

        .image-container {
            width: 100%;
            height: 550px;
            overflow: hidden;
            position: relative;
            background: var(--midnight-deep);
            border-radius: 12px;
        }

        .image-container img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            transition: transform 0.5s ease, filter 0.3s ease;
            filter: drop-shadow(0 0 30px rgba(255, 255, 255, 0.3))
                    drop-shadow(0 0 60px rgba(255, 255, 255, 0.2));
        }

        .image-card:hover .image-container img {
            transform: scale(1.05);
            filter: drop-shadow(0 0 40px rgba(255, 255, 255, 0.4))
                    drop-shadow(0 0 80px rgba(255, 255, 255, 0.3));
        }

        .image-name {
            padding: 8px 10px;
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-align: center;
            font-weight: 500;
            border-top: 1px solid var(--border-color);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.2;
        }

        .folder-tag {
            position: absolute;
            top: 12px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, var(--primary-purple) 0%, var(--deep-purple) 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 600;
            z-index: 5;
            box-shadow: 0 2px 8px rgba(139, 92, 246, 0.4);
            backdrop-filter: blur(10px);
            max-width: calc(100% - 80px);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .folder-list-item {
            display: flex;
            flex-direction: column;
            padding: 3px 6px 2px 6px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            transition: all 0.3s ease;
            cursor: grab;
            position: relative;
            gap: 1px;
        }

        .folder-list-item:hover {
            border-color: var(--primary-purple);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }

        .folder-list-item:active {
            cursor: grabbing;
        }

        .folder-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .folder-order {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            background: linear-gradient(135deg, var(--primary-purple) 0%, var(--deep-purple) 100%);
            color: white;
            border-radius: 3px;
            font-weight: 600;
            font-size: 0.6rem;
        }

        .folder-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--primary-purple);
        }

        .folder-list-item.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .folder-list-item.disabled:hover {
            border-color: var(--border-color);
            box-shadow: none;
        }

        .folder-name {
            color: var(--text-primary);
            font-weight: 600;
            font-size: 0.72rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            display: block;
            line-height: 1.2;
        }

        .folder-count {
            color: var(--text-muted);
            font-size: 0.62rem;
            margin-top: 0px;
            line-height: 1.1;
        }

        .folder-remove-btn {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            color: var(--text-muted);
            padding: 2px 6px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.7rem;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .folder-star-btn {
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-size: 1.3rem;
            cursor: pointer;
            padding: 4px 8px;
            transition: all 0.3s ease;
            line-height: 1;
        }

        .folder-star-btn:hover {
            transform: scale(1.2);
        }

        .folder-star-btn.active {
            color: var(--light-purple);
            filter: drop-shadow(0 0 8px var(--purple-glow));
        }

        .folder-badge {
            display: inline-flex;
            align-items: center;
            margin-right: 6px;
            font-size: 1rem;
            color: var(--color-blue);
        }

        .folder-badge svg {
            width: 1em;
            height: 1em;
            fill: currentColor;
        }

        .toggle-rating-btn {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            color: var(--text-primary);
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .toggle-rating-btn:hover {
            border-color: var(--primary-purple);
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(109, 40, 217, 0.1) 100%);
        }

        .toggle-rating-btn.active {
            background: transparent;
            color: var(--neon-purple);
            border-color: var(--neon-purple);
            box-shadow:
                0 0 15px rgba(139, 92, 246, 0.4),
                0 0 30px rgba(139, 92, 246, 0.3);
            text-shadow:
                0 0 10px rgba(139, 92, 246, 0.8),
                0 0 20px rgba(139, 92, 246, 0.6);
        }

        .folder-remove-btn:hover {
            background: linear-gradient(135deg, var(--deep-purple) 0%, var(--deeper-purple) 100%);
            border-color: var(--deep-purple);
            color: white;
        }

        /* 子文件夹选择模态框 */
        .folder-select-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.9);
            z-index: 10000;
            overflow-y: auto;
        }

        .folder-select-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        .folder-select-container {
            max-width: 700px;
            width: 90%;
            background: var(--bg-secondary);
            border-radius: 20px;
            border: 2px solid var(--primary-purple);
            box-shadow: var(--shadow-lg);
            padding: 40px;
        }

        .folder-select-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
        }

        .folder-select-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .folder-select-subtitle {
            color: var(--text-muted);
            font-size: 0.95rem;
        }

        .folder-select-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 30px;
            max-height: 400px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .folder-select-list::-webkit-scrollbar {
            width: 8px;
        }

        .folder-select-list::-webkit-scrollbar-track {
            background: var(--bg-primary);
            border-radius: 4px;
        }

        .folder-select-list::-webkit-scrollbar-thumb {
            background: var(--primary-purple);
            border-radius: 4px;
        }

        .folder-select-item {
            display: flex;
            align-items: center;
            padding: 16px;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .folder-select-item:hover {
            border-color: var(--primary-purple);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }

        .folder-select-item.selected {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.2) 0%, rgba(109, 40, 217, 0.2) 100%);
            border-color: var(--primary-purple);
        }

        .folder-select-checkbox {
            width: 24px;
            height: 24px;
            margin-right: 16px;
            cursor: pointer;
            accent-color: var(--primary-purple);
        }

        .folder-select-info {
            flex: 1;
        }

        .folder-select-name {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .folder-select-count {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .folder-select-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .folder-select-btn {
            padding: 12px 32px;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }

        .folder-select-btn-primary {
            background: transparent;
            color: var(--neon-purple);
            border: 2px solid var(--neon-purple);
            box-shadow:
                0 0 15px rgba(139, 92, 246, 0.4),
                0 0 30px rgba(139, 92, 246, 0.3);
            text-shadow:
                0 0 10px rgba(139, 92, 246, 0.8),
                0 0 20px rgba(139, 92, 246, 0.6);
        }

        .folder-select-btn-primary:hover {
            transform: translateY(-2px);
            background: rgba(139, 92, 246, 0.1);
            box-shadow:
                0 0 20px rgba(139, 92, 246, 0.6),
                0 0 40px rgba(139, 92, 246, 0.4);
            text-shadow:
                0 0 15px rgba(139, 92, 246, 1),
                0 0 30px rgba(139, 92, 246, 0.8);
        }

        .folder-select-btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .folder-select-btn-secondary {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 2px solid var(--border-color);
        }

        .folder-select-btn-secondary:hover {
            border-color: var(--primary-purple);
            background: var(--bg-primary);
        }

        .folder-select-all {
            text-align: center;
            margin-bottom: 20px;
            padding: 12px;
            background: var(--bg-card);
            border-radius: 10px;
            border: 1px solid var(--border-color);
        }

        .folder-select-all label {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            cursor: pointer;
            font-size: 0.95rem;
            color: var(--text-secondary);
        }

        .rating-bar {
            display: flex;
            gap: 6px;
            padding: 8px;
            justify-content: center;
            background: linear-gradient(180deg, transparent 0%, rgba(15, 10, 31, 0.6) 100%);
        }

        .rating-btn {
            background: var(--bg-primary);
            border: 2px solid var(--border-color);
            color: var(--text-muted);
            padding: 8px 12px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 4px;
            font-weight: 600;
            flex: 1;
            justify-content: center;
        }

        .rating-btn:hover {
            transform: translateY(-2px);
            border-color: var(--neon-purple);
            color: var(--text-primary);
            box-shadow: 0 0 10px rgba(139, 92, 246, 0.3);
        }

        .rating-btn.active {
            background: transparent;
            border-color: var(--neon-purple);
            color: var(--text-primary);
            box-shadow:
                0 0 15px rgba(139, 92, 246, 0.4),
                0 4px 16px rgba(139, 92, 246, 0.3);
        }

        /* 态度按钮样式 */
        .attitude-btn {
            background: var(--bg-primary);
            border: 2px solid var(--border-color);
            color: var(--text-muted);
            padding: 10px 16px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 600;
            flex: 1;
            justify-content: center;
        }

        .attitude-btn:hover {
            transform: translateY(-2px);
            color: var(--text-primary);
            box-shadow: 0 0 10px rgba(139, 92, 246, 0.3);
        }

        .attitude-btn.active.like {
            background: transparent;
            border-color: var(--attitude-like);
            color: var(--attitude-like);
            box-shadow:
                0 0 15px var(--attitude-like-glow),
                0 0 30px var(--attitude-like-glow);
            text-shadow:
                0 0 10px var(--attitude-like-glow),
                0 0 20px var(--attitude-like-glow);
        }

        .attitude-btn.active.neutral {
            background: transparent;
            border-color: var(--attitude-neutral);
            color: var(--attitude-neutral);
            box-shadow:
                0 0 15px var(--attitude-neutral-glow),
                0 0 30px var(--attitude-neutral-glow);
            text-shadow:
                0 0 10px var(--attitude-neutral-glow),
                0 0 20px var(--attitude-neutral-glow);
        }

        .attitude-btn.active.dislike {
            background: transparent;
            border-color: var(--attitude-dislike);
            color: var(--attitude-dislike);
            box-shadow:
                0 0 15px var(--attitude-dislike-glow),
                0 0 30px var(--attitude-dislike-glow);
            text-shadow:
                0 0 10px var(--attitude-dislike-glow),
                0 0 20px var(--attitude-dislike-glow);
        }

        /* 态度评分栏 */
        .attitude-bar {
            display: flex;
            gap: 8px;
            padding: 8px;
            justify-content: center;
            background: linear-gradient(180deg, transparent 0%, rgba(15, 10, 31, 0.6) 100%);
        }

        .comment-box {
            padding: 8px 12px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
        }

        .comment-input {
            width: 100%;
            padding: 8px 10px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 0.85rem;
            color: var(--text-primary);
            font-family: 'Manrope', -apple-system, sans-serif;
            resize: vertical;
            min-height: 36px;
            transition: all 0.3s ease;
        }

        .comment-input:focus {
            outline: none;
            border-color: var(--primary-purple);
            box-shadow: 0 0 0 3px var(--purple-glow);
        }

        .comment-input::placeholder {
            color: var(--text-muted);
            opacity: 0.6;
        }

        /* 画笔工具栏 */
        .draw-toolbar {
            position: fixed;
            top: 90px;
            right: 30px;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            display: none;
            flex-direction: column;
            gap: 12px;
            z-index: 10002;
            box-shadow: var(--shadow-lg);
            backdrop-filter: blur(10px);
        }

        .draw-toolbar.active {
            display: flex;
        }

        .draw-tool-btn {
            width: 44px;
            height: 44px;
            border: 2px solid var(--border-color);
            background: var(--bg-primary);
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .draw-tool-btn:hover {
            background: linear-gradient(135deg, var(--primary-purple) 0%, var(--deep-purple) 100%);
            border-color: var(--primary-purple);
            transform: scale(1.05);
        }

        .draw-tool-btn.active {
            background: linear-gradient(135deg, var(--primary-purple) 0%, var(--deep-purple) 100%);
            border-color: var(--primary-purple);
            color: white;
        }

        .color-picker {
            width: 44px;
            height: 44px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
        }

        .draw-canvas {
            position: absolute;
            top: 0;
            left: 0;
            cursor: crosshair;
            z-index: 10;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        .empty-state-text {
            font-size: 1.1rem;
            font-weight: 500;
        }

        .pagination {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 40px;
        }

        .pagination button {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            color: var(--text-primary);
            padding: 12px 28px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .pagination button:hover:not(:disabled) {
            background: var(--bg-card);
            border-color: var(--neon-purple);
            transform: translateY(-2px);
            box-shadow:
                0 0 15px rgba(139, 92, 246, 0.4),
                0 4px 16px rgba(139, 92, 246, 0.3);
        }

        .pagination button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        /* 截图按钮特殊样式 */
        .pagination .screenshot-btn {
            background: transparent;
            border: 1.5px solid rgba(155, 143, 165, 0.3);
            color: #9B8FA5;
            padding: 10px 20px;
            font-size: 0.9rem;
            margin-left: 10px;
            font-weight: 500;
            letter-spacing: 0.03em;
        }

        .pagination .screenshot-btn:hover {
            background: rgba(139, 92, 246, 0.08);
            border-color: rgba(139, 92, 246, 0.4);
            color: #8b5cf6;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(139, 92, 246, 0.15);
        }

        @keyframes subtle-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.85; }
        }

        .page-info {
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            font-weight: 600;
            padding: 0 10px;
        }

        /* 图片查看器模态框 */
        .image-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.95);
            z-index: 9999;
            cursor: grab;
            overflow: hidden;
        }

        .image-modal.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .image-modal.dragging {
            cursor: grabbing;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes quickFeedback {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.5);
            }
            50% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.2);
            }
            100% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(1);
            }
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            transform-origin: center center;
            transition: none;
            will-change: transform;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content img {
            display: block;
            width: auto;
            height: auto;
            max-width: 95vw;
            max-height: 90vh;
            object-fit: contain;
            user-select: none;
            pointer-events: none;
            /* 性能优化：启用硬件加速，优化大图渲染 */
            transform: translateZ(0);
            backface-visibility: hidden;
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
        }

        /* 加载动画 */
        #imageModal.loading::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: var(--primary-purple);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            z-index: 10001;
        }

        #imageModal.loading .modal-content img {
            opacity: 0;
        }

        @keyframes spin {
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }

        .modal-controls {
            position: fixed;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 12px;
            background: var(--bg-secondary);
            padding: 16px 24px;
            border-radius: 16px;
            border: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
            box-shadow: var(--shadow-lg);
            z-index: 10001;
        }

        .modal-btn {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            color: var(--text-primary);
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .modal-btn:hover {
            background: linear-gradient(135deg, var(--primary-purple) 0%, var(--deep-purple) 100%);
            border-color: var(--primary-purple);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
        }

        .modal-close {
            position: fixed;
            top: 30px;
            right: 30px;
            width: 50px;
            height: 50px;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 10001;
            backdrop-filter: blur(10px);
        }

        .modal-close:hover {
            background: linear-gradient(135deg, var(--deep-purple) 0%, var(--deeper-purple) 100%);
            border-color: var(--deep-purple);
            transform: scale(1.1);
        }

        .zoom-info {
            position: fixed;
            top: 30px;
            left: 30px;
            background: var(--bg-secondary);
            padding: 12px 20px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            font-weight: 600;
            backdrop-filter: blur(10px);
            z-index: 10001;
        }

        /* 对比功能 */
        .compare-checkbox {
            position: absolute;
            top: 12px;
            left: 12px;
            width: 28px;
            height: 28px;
            cursor: pointer;
            z-index: 10;
            opacity: 1;
            transition: opacity 0.3s ease;
        }

        .compare-checkbox-label {
            position: absolute;
            top: 12px;
            left: 12px;
            width: 28px;
            height: 28px;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 9;
            opacity: 1;
            backdrop-filter: blur(10px);
        }

        .compare-checkbox:checked + .compare-checkbox-label {
            background: linear-gradient(135deg, var(--primary-purple) 0%, var(--deep-purple) 100%);
            border-color: var(--primary-purple);
            opacity: 1;
        }

        .compare-checkbox:checked + .compare-checkbox-label::after {
            content: '✓';
            color: white;
            font-weight: bold;
            font-size: 1rem;
        }

        .compare-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border-top: 2px solid var(--primary-purple);
            padding: 16px;
            display: none;
            align-items: center;
            justify-content: center;
            gap: 20px;
            z-index: 9998;
            box-shadow: 0 -4px 20px rgba(139, 92, 246, 0.3);
            backdrop-filter: blur(10px);
        }

        .compare-bar.active {
            display: flex;
        }

        .compare-info {
            color: var(--text-primary);
            font-weight: 600;
            font-size: 1rem;
        }

        .compare-btn {
            background: linear-gradient(135deg, var(--primary-purple) 0%, var(--deep-purple) 100%);
            color: white;
            border: none;
            padding: 12px 28px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 16px rgba(139, 92, 246, 0.4);
        }

        .compare-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 24px rgba(139, 92, 246, 0.6);
        }

        .compare-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .clear-compare-btn {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            color: var(--text-primary);
        }

        .clear-compare-btn:hover {
            background: linear-gradient(135deg, var(--deep-purple) 0%, var(--deeper-purple) 100%);
            border-color: var(--deep-purple);
        }

        /* 对比模态框 */
        .compare-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.95);
            z-index: 9999;
            overflow: hidden;
        }

        .compare-modal.active {
            display: flex;
            flex-direction: column;
            animation: fadeIn 0.3s ease;
        }

        .compare-header {
            background: var(--bg-secondary);
            padding: 12px 20px;
            border-bottom: 2px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .compare-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .compare-mode-indicator {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 16px;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 600;
        }

        .compare-mode-indicator.sync-mode {
            border-color: var(--primary-purple);
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.2) 0%, rgba(109, 40, 217, 0.2) 100%);
        }

        .compare-mode-indicator.individual-mode {
            border-color: var(--light-purple);
            background: linear-gradient(135deg, rgba(201, 181, 208, 0.2) 0%, rgba(155, 143, 165, 0.2) 100%);
        }

        .compare-mode-icon {
            font-size: 1.2rem;
        }

        .compare-image-wrapper.focused {
            outline: 3px solid var(--light-purple);
            outline-offset: -3px;
            z-index: 1;
        }

        .compare-close {
            width: 40px;
            height: 40px;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 1.3rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .compare-close:hover {
            background: linear-gradient(135deg, var(--deep-purple) 0%, var(--deeper-purple) 100%);
            border-color: var(--deep-purple);
            transform: scale(1.1);
        }

        .compare-content {
            flex: 1;
            display: grid;
            gap: 1px;
            background: rgba(139, 92, 246, 0.2);
            overflow: hidden;
        }

        .compare-content.cols-2 {
            grid-template-columns: repeat(2, 1fr);
        }

        .compare-content.cols-3 {
            grid-template-columns: repeat(3, 1fr);
        }

        .compare-content.cols-4 {
            grid-template-columns: repeat(4, 1fr);
        }

        .compare-image-wrapper {
            position: relative;
            background: var(--bg-primary);
            overflow: hidden;
            cursor: grab;
        }

        .compare-image-wrapper.dragging {
            cursor: grabbing;
        }

        .compare-image-container {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100%;
            height: 100%;
            transform: translate(-50%, -50%);
            transform-origin: center center;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .compare-image-container img {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
            object-fit: contain;
            user-select: none;
            pointer-events: none;
        }

        .compare-image-name {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0, 0, 0, 0.9));
            color: white;
            padding: 12px;
            font-size: 0.9rem;
            font-weight: 500;
            text-align: center;
        }

        .compare-folder-tag {
            position: absolute;
            top: 12px;
            left: 12px;
            background: linear-gradient(135deg, var(--primary-purple) 0%, var(--deep-purple) 100%);
            color: white;
            padding: 6px 16px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 700;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.5);
            backdrop-filter: blur(10px);
            max-width: calc(100% - 180px);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            letter-spacing: 0.05em;
        }

        .compare-image-controls {
            position: absolute;
            top: 12px;
            right: 12px;
            display: flex;
            gap: 8px;
        }

        .compare-control-btn {
            width: 36px;
            height: 36px;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .compare-control-btn:hover {
            background: linear-gradient(135deg, var(--primary-purple) 0%, var(--deep-purple) 100%);
            border-color: var(--primary-purple);
            transform: scale(1.1);
        }

        .compare-zoom-info {
            position: absolute;
            bottom: 60px;
            left: 12px;
            background: var(--bg-secondary);
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 0.85rem;
            backdrop-filter: blur(10px);
            z-index: 10;
        }

        /* 全屏画廊模态框 */
        .fullscreen-gallery {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: var(--bg-primary);
            z-index: 10000;
            overflow: hidden;
        }

        .fullscreen-gallery.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .gallery-close {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 48px;
            height: 48px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid var(--border-color);
            border-radius: 50%;
            color: var(--text-primary);
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 10001;
            backdrop-filter: blur(10px);
        }

        .gallery-close:hover {
            background: var(--primary-purple);
            border-color: var(--primary-purple);
            transform: scale(1.1) rotate(90deg);
        }

        .gallery-info {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.1);
            padding: 12px 20px;
            border-radius: 12px;
            border: 2px solid var(--border-color);
            color: var(--text-primary);
            font-weight: 600;
            font-size: 0.95rem;
            z-index: 10001;
            backdrop-filter: blur(10px);
        }

        .gallery-container {
            width: 100%;
            height: 100%;
            overflow: auto;
            padding: 100px 40px 40px 40px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            align-content: start;
        }

        .gallery-image-wrapper {
            position: relative;
            background: var(--bg-card);
            border-radius: 12px;
            border: 2px solid var(--border-color);
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .gallery-image-wrapper:hover {
            border-color: var(--primary-purple);
            box-shadow: 0 8px 24px rgba(139, 92, 246, 0.3);
        }

        .gallery-image-container {
            position: relative;
            width: 100%;
            min-height: 300px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-secondary);
        }

        .gallery-image-container img {
            width: auto;
            height: auto;
            max-width: 100%;
            max-height: 600px;
            object-fit: contain;
            user-select: none;
        }

        .gallery-image-name {
            padding: 12px 16px;
            color: var(--text-secondary);
            font-size: 0.9rem;
            text-align: center;
            border-top: 1px solid var(--border-color);
            background: var(--bg-secondary);
        }

        /* 报告模态框 */
        /* ==================== 莫兰迪配色 + 简洁设计：报告界面 ==================== */

        .report-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.95);
            z-index: 10000;
            overflow-y: auto;
            animation: fadeIn 0.3s ease;
            padding: 0;
        }

        .report-modal.active {
            display: block;
        }

        .report-container {
            width: 100%;
            height: auto;
            min-height: 100vh;
            margin: 0;
            padding: 100px 80px 80px 80px;
            background: var(--bg-secondary);
            border-radius: 0;
            border: none;
            box-shadow: none;
            overflow-y: visible;
        }

        /* 报告深色主题 */
        .report-modal.dark-theme {
            background: radial-gradient(ellipse at top, rgba(26, 26, 62, 1) 0%, rgba(6, 6, 18, 1) 50%, rgba(10, 10, 31, 1) 100%);
        }

        .report-modal.dark-theme .report-container {
            background: rgba(20, 20, 40, 0.7);
            border-color: rgba(139, 92, 246, 0.2);
        }

        .report-modal.dark-theme .report-folder-name {
            color: #d8b4fe;
        }

        .report-modal.dark-theme .report-subtitle {
            color: #a78bfa;
        }

        .report-modal.dark-theme .report-stat-card {
            background: rgba(30, 30, 50, 0.6);
            border-color: rgba(139, 92, 246, 0.15);
        }

        .report-modal.dark-theme .report-stat-card:hover {
            background: rgba(40, 40, 60, 0.8);
            border-color: rgba(139, 92, 246, 0.3);
        }

        .report-modal.dark-theme .report-stat-card.like {
            background: rgba(16, 185, 129, 0.15);
            border-left-color: #34d399;
        }

        .report-modal.dark-theme .report-stat-card.neutral {
            background: rgba(245, 158, 11, 0.15);
            border-left-color: #fbbf24;
        }

        .report-modal.dark-theme .report-stat-card.dislike {
            background: rgba(239, 68, 68, 0.15);
            border-left-color: #f87171;
        }

        .report-modal.dark-theme .report-stat-card.like .report-stat-percentage {
            color: #34d399;
        }

        .report-modal.dark-theme .report-stat-card.neutral .report-stat-percentage {
            color: #fbbf24;
        }

        .report-modal.dark-theme .report-stat-card.dislike .report-stat-percentage {
            color: #f87171;
        }

        .report-modal.dark-theme h2,
        .report-modal.dark-theme h3,
        .report-modal.dark-theme .report-stat-value {
            color: #e9d5ff;
        }

        .report-modal.dark-theme .report-theme-btn,
        .report-modal.dark-theme .report-close-btn {
            background: rgba(139, 92, 246, 0.2);
            border-color: rgba(167, 139, 250, 0.3);
            color: #d8b4fe;
        }

        .report-modal.dark-theme .report-theme-btn:hover,
        .report-modal.dark-theme .report-close-btn:hover {
            background: rgba(167, 139, 250, 0.3);
            border-color: rgba(167, 139, 250, 0.5);
            color: #ffffff;
        }

        /* 报告容器样式已在上面定义，此处移除重复定义 */

        /* 报告编辑工具栏 */
        .report-edit-toolbar {
            position: relative;
            z-index: 10;
            display: flex;
            gap: 12px;
            padding: 16px 24px;
            background: rgba(139, 92, 246, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            border: 2px solid rgba(139, 92, 246, 0.3);
            margin-bottom: 32px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .edit-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 18px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .edit-btn:hover {
            background: rgba(139, 92, 246, 0.3);
            border-color: rgba(139, 92, 246, 0.5);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }

        .edit-btn.active {
            background: rgba(139, 92, 246, 0.5);
            border-color: rgba(139, 92, 246, 0.7);
        }

        .edit-btn span {
            font-size: 1.2rem;
            line-height: 1;
            display: inline-block;
        }

        .edit-btn:active {
            transform: translateY(0);
        }

        /* 可拖拽的内容块 */
        .draggable-block {
            position: relative;
            margin-bottom: 24px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 2px solid transparent;
            transition: all 0.2s ease;
        }

        .draggable-block.drag-mode {
            cursor: move;
            border-color: rgba(139, 92, 246, 0.3);
        }

        .draggable-block.drag-mode:hover {
            border-color: rgba(139, 92, 246, 0.6);
            background: rgba(255, 255, 255, 0.08);
        }

        .draggable-block.dragging {
            opacity: 0.5;
            transform: scale(0.98);
        }

        .draggable-block .drag-handle {
            display: none;
            position: absolute;
            top: 8px;
            right: 8px;
            padding: 6px 12px;
            background: rgba(139, 92, 246, 0.3);
            border-radius: 6px;
            color: #fff;
            font-size: 0.85rem;
            cursor: move;
        }

        .drag-mode .draggable-block .drag-handle {
            display: block;
        }

        .draggable-block .delete-btn {
            display: none;
            position: absolute;
            top: 8px;
            left: 8px;
            padding: 6px 12px;
            background: rgba(239, 68, 68, 0.8);
            border: none;
            border-radius: 6px;
            color: #fff;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .drag-mode .draggable-block .delete-btn {
            display: block;
        }

        .draggable-block .delete-btn:hover {
            background: rgba(239, 68, 68, 1);
            transform: scale(1.05);
        }

        /* 自定义文本块 - 结构化样式 */
        .custom-text-block {
            padding: 24px 32px;
            background: rgba(139, 92, 246, 0.08);
            border-radius: 16px;
            border: 2px solid rgba(139, 92, 246, 0.3);
            margin: 24px 0;
        }

        .custom-text-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #a78bfa;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid rgba(139, 92, 246, 0.3);
            outline: none;
            text-shadow: 0 0 20px rgba(167, 139, 250, 0.4);
        }

        .custom-text-title:focus {
            color: #c4b5fd;
            text-shadow: 0 0 25px rgba(167, 139, 250, 0.6);
        }

        .custom-text-title:empty::before {
            content: "点击输入标题...";
            color: rgba(167, 139, 250, 0.5);
            font-weight: 600;
        }

        .custom-text-content {
            font-size: 1.1rem;
            line-height: 1.8;
            color: rgba(255, 255, 255, 0.85);
            outline: none;
            min-height: 60px;
        }

        .custom-text-content:focus {
            color: rgba(255, 255, 255, 0.95);
        }

        .custom-text-content:empty::before {
            content: "点击输入内容描述...";
            color: rgba(255, 255, 255, 0.4);
            font-style: italic;
        }

        /* 自定义图片块 */
        .custom-image-block {
            max-width: 100%;
            border-radius: 8px;
            overflow: hidden;
        }

        .custom-image-block img {
            width: 100%;
            height: auto;
            display: block;
        }

        .report-header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 30px;
            border-bottom: 2px solid var(--border-color);
        }

        .report-folder-name {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-purple);
            margin-bottom: 12px;
        }

        .report-subtitle {
            color: var(--text-muted);
            font-size: 1.1rem;
            font-weight: 500;
        }

        /* Goodcase/Badcase 总结 */
        .report-case-summary {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 48px;
            margin-bottom: 48px;
            padding: 40px 60px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.08) 0%, rgba(255, 255, 255, 0.04) 100%);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 2px solid rgba(255, 255, 255, 0.15);
            max-width: 100%;
            margin-left: auto;
            margin-right: auto;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .case-column {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .case-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }

        .case-label {
            font-size: 1.3rem;
            font-weight: 700;
            letter-spacing: 0.5px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .case-column.goodcase .case-label {
            color: #10b981;
        }

        .case-column.badcase .case-label {
            color: #ef4444;
        }

        .case-percentage {
            font-size: 2.8rem;
            font-weight: 900;
            letter-spacing: -1px;
        }

        .case-column.goodcase .case-percentage {
            color: #10b981;
            text-shadow: 0 0 25px rgba(16, 185, 129, 0.5), 0 2px 8px rgba(0, 0, 0, 0.4);
        }

        .case-column.badcase .case-percentage {
            color: #ef4444;
            text-shadow: 0 0 25px rgba(239, 68, 68, 0.5), 0 2px 8px rgba(0, 0, 0, 0.4);
        }

        /* 完美标识 (≥98%) */
        .case-column.goodcase.perfect {
            background: rgba(16, 185, 129, 0.08);
            border-radius: 16px;
            padding: 20px;
            border: 2px solid rgba(16, 185, 129, 0.3);
        }

        .perfect-badge {
            display: inline-block;
            margin-left: 12px;
            padding: 4px 12px;
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
            color: #ffffff;
            font-size: 0.85rem;
            font-weight: 700;
            border-radius: 6px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.4);
            animation: pulse-perfect 2s ease-in-out infinite;
        }

        @keyframes pulse-perfect {
            0%, 100% {
                box-shadow: 0 2px 8px rgba(16, 185, 129, 0.4);
            }
            50% {
                box-shadow: 0 4px 16px rgba(16, 185, 129, 0.7);
            }
        }

        /* 优秀标识 (90-97%) */
        .case-column.goodcase.excellent {
            background: rgba(245, 158, 11, 0.08);
            border-radius: 16px;
            padding: 20px;
            border: 2px solid rgba(245, 158, 11, 0.3);
        }

        .excellent-badge {
            display: inline-block;
            margin-left: 12px;
            padding: 4px 12px;
            background: linear-gradient(135deg, #d97706 0%, #f59e0b 100%);
            color: #ffffff;
            font-size: 0.85rem;
            font-weight: 700;
            border-radius: 6px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.4);
            animation: pulse-excellent 2s ease-in-out infinite;
        }

        @keyframes pulse-excellent {
            0%, 100% {
                box-shadow: 0 2px 8px rgba(245, 158, 11, 0.4);
            }
            50% {
                box-shadow: 0 4px 16px rgba(245, 158, 11, 0.7);
            }
        }

        /* 高风险标识 */
        .case-column.badcase.high-risk {
            background: rgba(239, 68, 68, 0.08);
            border-radius: 16px;
            padding: 20px;
            border: 2px solid rgba(239, 68, 68, 0.3);
        }

        .risk-badge {
            display: inline-block;
            margin-left: 12px;
            padding: 4px 12px;
            background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
            color: #ffffff;
            font-size: 0.85rem;
            font-weight: 700;
            border-radius: 6px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
            animation: pulse-risk 2s ease-in-out infinite;
        }

        @keyframes pulse-risk {
            0%, 100% {
                box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
            }
            50% {
                box-shadow: 0 4px 16px rgba(239, 68, 68, 0.7);
            }
        }

        .case-divider {
            width: 2px;
            align-self: stretch;
            background: linear-gradient(to bottom, transparent, rgba(255, 255, 255, 0.3), transparent);
            border-radius: 1px;
        }

        .case-details {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .detail-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .detail-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            transition: all 0.2s ease;
        }

        .detail-item:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .detail-label {
            font-size: 1rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.9);
        }

        .detail-stats {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .detail-percentage {
            font-size: 1.4rem;
            font-weight: 700;
        }

        .detail-item.like .detail-percentage {
            color: #34d399;
        }

        .detail-item.neutral .detail-percentage {
            color: #fbbf24;
        }

        .detail-item.dislike .detail-percentage {
            color: #f87171;
        }

        .detail-count {
            font-size: 1rem;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.7);
        }

        /* 未评分区域 */
        .report-unrated-section {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            padding: 16px 32px;
            background: rgba(155, 143, 165, 0.1);
            border-radius: 12px;
            border: 2px solid rgba(155, 143, 165, 0.2);
            margin-bottom: 32px;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .unrated-label {
            font-size: 1.1rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.6);
        }

        .unrated-stats {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .unrated-percentage {
            font-size: 1.5rem;
            font-weight: 700;
            color: #b8afc0;
        }

        .unrated-count {
            font-size: 1rem;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.5);
        }

        .report-buttons-wrapper {
            position: fixed;
            top: 40px;
            left: 50%;
            transform: translateX(-50%);
            max-width: calc(100vw - 40px);
            width: 100%;
            padding: 0 60px;
            pointer-events: none;
            z-index: 10001;
        }

        .report-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            pointer-events: auto;
            margin-right: 0;
        }

        .report-close-btn {
            width: 50px;
            height: 50px;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-md);
        }

        .report-close-btn:hover {
            background: linear-gradient(135deg, var(--deep-purple) 0%, var(--deeper-purple) 100%);
            border-color: var(--deep-purple);
            color: white;
            transform: scale(1.05);
        }

        .report-print-btn {
            height: 50px;
            padding: 0 20px;
            background: var(--bg-card);
            border: 2px solid var(--primary-purple);
            border-radius: 12px;
            color: var(--primary-purple);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-md);
        }

        .report-print-btn:hover {
            background: var(--primary-purple);
            color: white;
            transform: scale(1.05);
        }

        .report-export-btn {
            height: 50px;
            padding: 0 20px;
            background: var(--bg-card);
            border: 2px solid #10b981;
            border-radius: 12px;
            color: #10b981;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-md);
        }

        .report-export-btn:hover {
            background: #10b981;
            color: white;
            transform: scale(1.05);
        }

        .report-confluence-btn {
            height: 50px;
            padding: 0 20px;
            background: var(--bg-card);
            border: 2px solid #3b82f6;
            border-radius: 12px;
            color: #3b82f6;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-md);
        }

        .report-confluence-btn:hover {
            background: #3b82f6;
            color: white;
            transform: scale(1.05);
        }

        .report-theme-btn {
            width: 36px;
            height: 36px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 50%;
            color: #666;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .report-theme-btn:hover {
            background: #f5f5f5;
            border-color: #999;
        }

        .report-print-btn, .report-export-btn {
            padding: 8px 16px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 18px;
            color: #666;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .report-print-btn:hover, .report-export-btn:hover {
            background: #f5f5f5;
            border-color: #999;
            color: #333;
        }

        /* 旧的卡片样式已移除，使用新的两栏文本布局 */

        .report-section {
            margin-bottom: 64px;
        }

        .report-section-title {
            font-size: 1.5rem;
            font-weight: 300;
            color: #6A5F74;
            margin-bottom: 32px;
            padding-bottom: 16px;
            border-bottom: 1px solid rgba(155, 143, 165, 0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            letter-spacing: -0.01em;
        }

        .report-section-icon {
            font-size: 1.5rem;
            opacity: 0.5;
            color: #9B8FA5;
        }

        .report-image-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(500px, 1fr));
            gap: 24px;
        }

        /* Wallpaper* 风格的带评论图片列表 */
        .report-image-list-with-comments {
            display: flex;
            flex-direction: column;
            gap: 56px;
        }

        /* Wallpaper* 风格的图片网格（评论只出现一次） */
        .report-image-grid-wallpaper {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 32px;
            padding: 0;
        }

        .report-image-grid-item {
            display: flex;
            flex-direction: column;
            gap: 12px;
            background: transparent;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .report-image-grid-item:hover {
            transform: translateY(-2px);
        }

        .report-image-grid-visual {
            width: 100%;
            aspect-ratio: 4/3;
            background: rgba(250, 247, 245, 0.5);
            border: 1px solid rgba(155, 143, 165, 0.08);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
            transition: all 0.3s ease;
        }

        .report-image-grid-replace-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 32px;
            height: 32px;
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid white;
            border-radius: 8px;
            color: white;
            font-size: 1rem;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 10;
        }

        .report-image-grid-item:hover .report-image-grid-replace-btn {
            display: flex;
        }

        .report-image-grid-replace-btn:hover {
            background: rgba(0, 0, 0, 0.9);
            transform: scale(1.1);
        }

        .report-image-grid-item:hover .report-image-grid-visual {
            border-color: rgba(155, 143, 165, 0.2);
            box-shadow: 0 4px 20px rgba(155, 143, 165, 0.08);
        }

        .report-image-grid-visual img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            cursor: pointer;
            transition: opacity 0.3s ease;
        }

        .report-image-grid-visual img:hover {
            opacity: 0.9;
        }

        /* 自定义图片区域样式 */
        .custom-image-section {
            margin: 48px 0;
            padding: 32px;
            background: rgba(250, 247, 245, 0.3);
            border: 2px dashed rgba(155, 143, 165, 0.2);
            border-radius: 8px;
            position: relative;
            page-break-inside: avoid;
        }

        .custom-image-section:hover {
            border-color: rgba(155, 143, 165, 0.4);
        }

        .custom-image-row {
            display: grid;
            gap: 0;
            margin-bottom: 0;
        }

        .custom-image-row:not(:last-child) {
            margin-bottom: 0;
        }

        .custom-image-item {
            aspect-ratio: 4/3;
            background: rgba(250, 247, 245, 0.5);
            border: 1px solid rgba(155, 143, 165, 0.08);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
            cursor: pointer;
        }

        .custom-image-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .custom-image-item:hover .custom-image-placeholder {
            color: #9B8FA5;
        }

        .custom-image-placeholder {
            color: rgba(155, 143, 165, 0.4);
            font-size: 2rem;
            transition: all 0.3s ease;
        }

        .custom-section-delete-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 32px;
            height: 32px;
            background: rgba(212, 165, 181, 0.9);
            border: 2px solid white;
            border-radius: 8px;
            color: white;
            font-size: 1rem;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 10;
        }

        .custom-image-section:hover .custom-section-delete-btn {
            display: flex;
        }

        .custom-section-delete-btn:hover {
            background: rgba(212, 165, 181, 1);
            transform: scale(1.1);
        }

        .add-image-section-btn {
            margin: 32px auto;
            padding: 16px 32px;
            background: linear-gradient(135deg, rgba(155, 143, 165, 0.1) 0%, rgba(155, 143, 165, 0.05) 100%);
            border: 2px dashed rgba(155, 143, 165, 0.3);
            border-radius: 12px;
            color: #9B8FA5;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .add-image-section-btn:hover {
            background: linear-gradient(135deg, rgba(155, 143, 165, 0.15) 0%, rgba(155, 143, 165, 0.1) 100%);
            border-color: rgba(155, 143, 165, 0.5);
            color: #6A5F74;
        }

        .image-layout-config {
            display: none;
            margin: 24px 0;
            padding: 24px;
            background: white;
            border: 2px solid rgba(155, 143, 165, 0.2);
            border-radius: 12px;
            gap: 20px;
        }

        .image-layout-config.active {
            display: flex;
            flex-direction: column;
        }

        .config-row {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .config-label {
            font-size: 0.9rem;
            color: #6A5F74;
            font-weight: 500;
            min-width: 100px;
        }

        .config-input {
            padding: 8px 12px;
            border: 2px solid rgba(155, 143, 165, 0.2);
            border-radius: 8px;
            font-size: 0.9rem;
            width: 80px;
            outline: none;
            transition: all 0.3s ease;
        }

        .config-input:focus {
            border-color: #9B8FA5;
        }

        .config-buttons {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .config-btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid;
        }

        .config-btn-confirm {
            background: linear-gradient(135deg, #9B8FA5 0%, #7B6D87 100%);
            border-color: #9B8FA5;
            color: white;
        }

        .config-btn-confirm:hover {
            background: linear-gradient(135deg, #7B6D87 0%, #6B5D77 100%);
        }

        .config-btn-cancel {
            background: transparent;
            border-color: rgba(155, 143, 165, 0.3);
            color: #9B8FA5;
        }

        .config-btn-cancel:hover {
            border-color: rgba(155, 143, 165, 0.5);
            background: rgba(155, 143, 165, 0.05);
        }

        /* Hotkey Amber Highlight */
        .hotkey {
            display: inline-block;
            color: #FFD700;
            font-weight: 800;
            padding: 2px 8px;
            background: rgba(255, 215, 0, 0.1);
            border-radius: 6px;
            border: 1px solid rgba(255, 215, 0, 0.3);
            text-shadow:
                0 0 10px rgba(255, 215, 0, 0.8),
                0 0 20px rgba(255, 215, 0, 0.6),
                0 0 30px rgba(255, 215, 0, 0.4);
            box-shadow:
                0 0 10px rgba(255, 215, 0, 0.3),
                0 0 20px rgba(255, 215, 0, 0.2);
            animation: hotKeyPulse 2s ease-in-out infinite;
        }

        @keyframes hotKeyPulse {
            0%, 100% {
                text-shadow:
                    0 0 10px rgba(255, 215, 0, 0.8),
                    0 0 20px rgba(255, 215, 0, 0.6),
                    0 0 30px rgba(255, 215, 0, 0.4);
                box-shadow:
                    0 0 10px rgba(255, 215, 0, 0.3),
                    0 0 20px rgba(255, 215, 0, 0.2);
            }
            50% {
                text-shadow:
                    0 0 15px rgba(255, 215, 0, 1),
                    0 0 25px rgba(255, 215, 0, 0.8),
                    0 0 35px rgba(255, 215, 0, 0.6);
                box-shadow:
                    0 0 15px rgba(255, 215, 0, 0.5),
                    0 0 30px rgba(255, 215, 0, 0.3);
            }
        }

        /* Cursor Star Trail Effect */
        body {
            cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3" fill="rgba(139, 92, 246, 0.6)"/><circle cx="12" cy="12" r="1.5" fill="white"/></svg>') 12 12, auto;
        }

        .star-particle {
            position: fixed;
            pointer-events: none;
            width: 4px;
            height: 4px;
            background: white;
            border-radius: 50%;
            z-index: 9999;
            box-shadow:
                0 0 6px rgba(255, 255, 255, 0.8),
                0 0 12px rgba(139, 92, 246, 0.6);
            animation: starFade 0.8s ease-out forwards;
        }

        @keyframes starFade {
            0% {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
            100% {
                opacity: 0;
                transform: scale(0.3) translateY(-20px);
            }
        }

        @media print {
            .add-image-section-btn,
            .image-layout-config,
            .custom-section-delete-btn {
                display: none !important;
            }

            .custom-image-section {
                border: none;
                background: transparent;
                padding: 0;
            }
        }

        .report-image-grid-filename {
            font-size: 0.7rem;
            color: #9B8FA5;
            letter-spacing: 0.03em;
            font-weight: 400;
            opacity: 0.8;
            line-height: 1.4;
            text-align: center;
            padding: 0 8px;
        }

        .report-image-with-comment {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 48px;
            align-items: start;
            padding: 0;
            border: none;
            background: transparent;
        }

        .report-image-with-comment-visual {
            width: 100%;
            aspect-ratio: 4/3;
            background: rgba(250, 247, 245, 0.5);
            border: 1px solid rgba(155, 143, 165, 0.08);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .report-image-with-comment-visual:hover {
            border-color: rgba(155, 143, 165, 0.2);
            box-shadow: 0 8px 32px rgba(155, 143, 165, 0.1);
        }

        .report-image-with-comment-visual img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            cursor: pointer;
            transition: opacity 0.3s ease;
        }

        .report-image-with-comment-visual img:hover {
            opacity: 0.9;
        }

        .report-image-with-comment-content {
            padding: 24px 0;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .report-image-with-comment-filename {
            font-size: 0.7rem;
            color: #9B8FA5;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            font-weight: 400;
            opacity: 0.8;
            line-height: 1.6;
        }

        .report-image-with-comment-text {
            font-size: 1.125rem;
            line-height: 1.8;
            color: #4A4550;
            font-weight: 300;
            letter-spacing: -0.01em;
            padding: 0;
            border: none;
            background: transparent;
            outline: none;
            transition: color 0.3s ease;
        }

        .report-image-with-comment-text:hover,
        .report-image-with-comment-text:focus {
            color: #2A2530;
        }

        .report-image-with-comment-text[contenteditable="true"]:empty:before {
            content: "点击添加评价...";
            color: #9B8FA5;
            opacity: 0.4;
        }

        .report-image-item {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .report-image-item:hover {
            transform: translateY(-4px);
            border-color: var(--primary-purple);
            box-shadow: 0 6px 16px rgba(139, 92, 246, 0.3);
        }

        .report-image-thumb {
            width: 100%;
            height: 450px;
            background: var(--bg-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }

        .report-image-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .report-image-thumb img:hover {
            transform: scale(1.05);
        }

        .report-image-replace-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 32px;
            height: 32px;
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid white;
            border-radius: 8px;
            color: white;
            font-size: 1rem;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .report-image-thumb:hover .report-image-replace-btn {
            display: flex;
        }

        .report-image-replace-btn:hover {
            background: var(--primary-purple);
            transform: scale(1.1);
        }

        .report-image-filename {
            padding: 12px;
            font-size: 0.85rem;
            color: var(--text-secondary);
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-weight: 500;
        }

        /* 可编辑文本样式 */
        [contenteditable="true"] {
            outline: none;
            cursor: text;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        [contenteditable="true"]:hover {
            background: rgba(155, 143, 165, 0.1);
        }

        [contenteditable="true"]:focus {
            background: rgba(155, 143, 165, 0.15);
            box-shadow: 0 0 0 2px var(--primary-purple);
        }

        .report-empty {
            text-align: center;
            padding: 64px 20px;
            color: #9B8FA5;
            font-size: 0.875rem;
            font-weight: 300;
            letter-spacing: 0.05em;
            text-transform: uppercase;
        }

        /* 帮助按钮容器 */
        .help-btn-wrapper {
            display: flex;
            justify-content: flex-end;
            padding: 30px 40px 60px;
            margin-top: 40px;
            position: relative;
            z-index: 100;
        }

        /* 帮助按钮 */
        .help-btn {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--primary-purple) 0%, var(--deep-purple) 100%);
            border: 3px solid var(--bg-card);
            border-radius: 50%;
            color: white;
            font-size: 2rem;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 24px rgba(123, 109, 135, 0.4);
            transition: all 0.3s ease;
            position: relative;
            z-index: 101;
        }

        .help-btn:hover {
            transform: scale(1.1) rotate(15deg);
            box-shadow: 0 12px 32px rgba(123, 109, 135, 0.6);
        }

        /* 帮助模态框 */
        .help-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.95);
            z-index: 10000;
            overflow-y: auto;
            animation: fadeIn 0.3s ease;
        }

        .help-modal.active {
            display: block;
        }

        .help-container {
            max-width: 1400px;
            margin: 40px auto;
            padding: 60px;
            background: var(--bg-secondary);
            border-radius: 20px;
            border: 2px solid var(--primary-purple);
            box-shadow: var(--shadow-lg);
            position: relative;
        }

        .help-close {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .help-close:hover {
            background: linear-gradient(135deg, var(--deep-purple) 0%, var(--deeper-purple) 100%);
            border-color: var(--deep-purple);
            color: white;
            transform: scale(1.1);
        }

        .help-title {
            text-align: center;
            font-size: 3rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary-purple) 0%, var(--light-purple) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 50px;
        }

        /* 思维导图样式 */
        .mindmap {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 40px;
        }

        .mindmap-center {
            background: linear-gradient(135deg, var(--primary-purple) 0%, var(--deep-purple) 100%);
            color: white;
            padding: 30px 50px;
            border-radius: 20px;
            font-size: 2rem;
            font-weight: 700;
            box-shadow: 0 12px 40px rgba(123, 109, 135, 0.4);
            text-align: center;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .mindmap-branches {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 30px;
            width: 100%;
        }

        .mindmap-branch {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 16px;
            padding: 24px;
            transition: all 0.3s ease;
        }

        .mindmap-branch:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(155, 143, 165, 0.3);
            border-color: var(--primary-purple);
        }

        .mindmap-branch-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .mindmap-branch-icon {
            font-size: 2rem;
            background: linear-gradient(135deg, var(--primary-purple) 0%, var(--light-purple) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .mindmap-branch-items {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .mindmap-branch-items li {
            padding: 12px 0;
            color: var(--text-secondary);
            font-size: 1.05rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .mindmap-branch-items li:last-child {
            border-bottom: none;
        }

        .mindmap-branch-items li::before {
            content: '▸';
            color: var(--primary-purple);
            font-weight: 700;
            flex-shrink: 0;
        }

        .mindmap-branch-items li strong {
            color: var(--text-primary);
            font-weight: 600;
        }

        @media print {
            /* 隐藏所有非报告内容 */
            body > *:not(.report-modal) {
                display: none !important;
            }

            body {
                background: white;
                margin: 0;
                padding: 0;
            }

            .report-buttons-wrapper {
                display: none !important;
            }

            .report-modal {
                position: static !important;
                background: white !important;
                overflow: visible !important;
                display: block !important;
                height: auto !important;
                padding: 0 !important;
                backdrop-filter: none !important;
            }

            .report-container {
                max-width: 100% !important;
                margin: 0 !important;
                padding: 40px 60px !important;
                background: white !important;
                color: #2A2530 !important;
                border: none !important;
                box-shadow: none !important;
                height: auto !important;
            }

            /* 一级标题：只在第一页显示 */
            .report-header {
                margin-bottom: 24px !important;
                page-break-after: avoid;
            }

            .report-folder-name {
                color: #2A2530 !important;
                font-size: 2.5rem !important;
                font-weight: 600 !important;
            }

            .report-subtitle {
                color: #6A5F74 !important;
                font-weight: 500 !important;
            }

            /* 统计面板优化 */
            .report-summary {
                display: grid !important;
                grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)) !important;
                gap: 16px !important;
                margin-bottom: 48px !important;
                page-break-after: avoid;
                page-break-inside: avoid;
            }

            .report-stat-card {
                page-break-inside: avoid;
                background: white !important;
                border: 1px solid rgba(155, 143, 165, 0.2) !important;
            }

            .report-stat-percentage {
                color: inherit !important;
            }

            .report-stat-value {
                color: #6A5F74 !important;
            }

            .report-stat-label {
                color: #9B8FA5 !important;
            }

            /* Badcase 标题前分页 */
            .report-section[style*="page-break-before"] {
                page-break-before: always;
            }

            /* 三级内容分组：避免被分页打断 */
            .report-section > div[style*="page-break-inside: avoid"] {
                page-break-inside: avoid;
            }

            /* 图片和评论组合不被分页打断 */
            .report-image-with-comment {
                page-break-inside: avoid;
                margin-bottom: 40px;
            }

            /* 打印时优化图片显示 */
            .report-image-with-comment-visual {
                border: 1px solid #E0E0E0 !important;
                background: #FAFAFA !important;
            }

            .report-image-with-comment-visual img {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            /* 打印时优化文字 */
            .report-image-with-comment-filename {
                color: #9B8FA5 !important;
            }

            .report-image-with-comment-text {
                color: #2A2530 !important;
                line-height: 1.8;
            }

            /* H2 二级标题（Goodcase/Badcase）优化 */
            h2 {
                page-break-after: avoid;
                page-break-inside: avoid;
                color: #2A2530 !important;
                font-weight: 600 !important;
            }

            /* H3 三级标题（评论分组）优化 */
            h3 {
                page-break-after: avoid;
                page-break-inside: avoid;
                color: #4A4550 !important;
            }

            /* 图片网格打印优化 */
            .report-image-grid-wallpaper {
                display: grid !important;
                grid-template-columns: repeat(3, 1fr) !important;
                gap: 24px !important;
            }

            .report-image-grid-item {
                page-break-inside: avoid;
            }

            .report-image-grid-visual {
                border: 1px solid #E0E0E0 !important;
                background: #FAFAFA !important;
            }

            .report-image-grid-visual img {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .report-image-grid-filename {
                color: #9B8FA5 !important;
            }

            /* 打印时隐藏替换按钮 */
            .report-image-grid-replace-btn {
                display: none !important;
            }
        }

        @media (max-width: 1200px) {
            .gallery {
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            }

            .image-container {
                height: 450px;
            }
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 2.5rem;
            }

            .gallery {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .image-container {
                height: 350px;
            }

            .control-group {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        /* ========== Toast 通知系统 ========== */
        .toast-container {
            position: fixed;
            top: 24px;
            right: 24px;
            z-index: 99999;
            display: flex;
            flex-direction: column;
            gap: 12px;
            pointer-events: none;
        }

        .toast {
            min-width: 300px;
            max-width: 450px;
            padding: 16px 20px;
            background: rgba(13, 13, 26, 0.95);
            border-radius: 12px;
            border: 1px solid;
            backdrop-filter: blur(20px);
            box-shadow:
                0 8px 32px rgba(0, 0, 0, 0.6),
                0 0 0 1px rgba(255, 255, 255, 0.05);
            display: flex;
            align-items: center;
            gap: 12px;
            pointer-events: auto;
            transform: translateX(120%);
            animation: slideInRight 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
            font-family: 'Inter', sans-serif;
        }

        .toast.hiding {
            animation: slideOutRight 0.3s cubic-bezier(0.6, 0.04, 0.98, 0.34) forwards;
        }

        .toast-icon {
            font-size: 1.5rem;
            line-height: 1;
            flex-shrink: 0;
        }

        .toast-content {
            flex: 1;
            min-width: 0;
        }

        .toast-title {
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 2px;
            letter-spacing: 0.02em;
        }

        .toast-message {
            font-size: 0.85rem;
            opacity: 0.9;
            line-height: 1.4;
            word-wrap: break-word;
        }

        .toast-close {
            background: none;
            border: none;
            color: currentColor;
            opacity: 0.6;
            cursor: pointer;
            padding: 4px;
            line-height: 1;
            font-size: 1.2rem;
            transition: opacity 0.2s ease;
            flex-shrink: 0;
        }

        .toast-close:hover {
            opacity: 1;
        }

        /* Toast 类型样式 */
        .toast.success {
            border-color: var(--attitude-like);
            color: var(--attitude-like-light);
            box-shadow:
                0 8px 32px rgba(0, 0, 0, 0.6),
                0 0 20px rgba(16, 185, 129, 0.2),
                0 0 0 1px rgba(16, 185, 129, 0.3);
        }

        .toast.success .toast-icon {
            color: var(--attitude-like);
            text-shadow: 0 0 10px var(--attitude-like-glow);
        }

        .toast.error {
            border-color: var(--attitude-dislike);
            color: var(--attitude-dislike-light);
            box-shadow:
                0 8px 32px rgba(0, 0, 0, 0.6),
                0 0 20px rgba(239, 68, 68, 0.2),
                0 0 0 1px rgba(239, 68, 68, 0.3);
        }

        .toast.error .toast-icon {
            color: var(--attitude-dislike);
            text-shadow: 0 0 10px var(--attitude-dislike-glow);
        }

        .toast.warning {
            border-color: var(--attitude-neutral);
            color: var(--attitude-neutral-light);
            box-shadow:
                0 8px 32px rgba(0, 0, 0, 0.6),
                0 0 20px rgba(245, 158, 11, 0.2),
                0 0 0 1px rgba(245, 158, 11, 0.3);
        }

        .toast.warning .toast-icon {
            color: var(--attitude-neutral);
            text-shadow: 0 0 10px var(--attitude-neutral-glow);
        }

        .toast.info {
            border-color: var(--neon-blue);
            color: var(--neon-violet);
            box-shadow:
                0 8px 32px rgba(0, 0, 0, 0.6),
                0 0 20px rgba(107, 127, 255, 0.2),
                0 0 0 1px rgba(107, 127, 255, 0.3);
        }

        .toast.info .toast-icon {
            color: var(--neon-blue);
            text-shadow: 0 0 10px rgba(107, 127, 255, 0.4);
        }

        @keyframes slideInRight {
            from {
                transform: translateX(120%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(120%);
                opacity: 0;
            }
        }

        /* Loading 加载指示器 */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 10, 31, 0.85);
            backdrop-filter: blur(8px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 99998;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .loading-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 3px solid rgba(139, 92, 246, 0.2);
            border-top-color: var(--neon-purple);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.4);
        }

        .loading-text {
            margin-top: 20px;
            color: var(--text-primary);
            font-size: 1.1rem;
            font-weight: 500;
            letter-spacing: 0.05em;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* 移动端适配 */
        @media (max-width: 768px) {
            .toast-container {
                right: 12px;
                left: 12px;
                top: 12px;
            }

            .toast {
                min-width: auto;
                max-width: none;
            }
        }

        /* ========== 确认对话框 ========== */
        .confirm-dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 10, 31, 0.9);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 99997;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .confirm-dialog-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        .confirm-dialog {
            background: rgba(13, 13, 26, 0.98);
            border: 1px solid var(--neon-purple);
            border-radius: 16px;
            padding: 32px;
            max-width: 480px;
            width: 90%;
            box-shadow:
                0 20px 60px rgba(0, 0, 0, 0.8),
                0 0 40px rgba(139, 92, 246, 0.3),
                0 0 0 1px rgba(139, 92, 246, 0.2);
            transform: scale(0.9);
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .confirm-dialog-overlay.active .confirm-dialog {
            transform: scale(1);
        }

        .confirm-dialog-icon {
            font-size: 3rem;
            text-align: center;
            margin-bottom: 20px;
        }

        .confirm-dialog-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-title);
            text-align: center;
            margin-bottom: 12px;
            letter-spacing: 0.02em;
        }

        .confirm-dialog-message {
            font-size: 1rem;
            color: var(--text-secondary);
            text-align: center;
            line-height: 1.6;
            margin-bottom: 28px;
        }

        .confirm-dialog-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .confirm-dialog-btn {
            flex: 1;
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            letter-spacing: 0.02em;
        }

        .confirm-dialog-btn-cancel {
            background: rgba(107, 114, 128, 0.2);
            color: var(--text-secondary);
            border: 1px solid rgba(107, 114, 128, 0.3);
        }

        .confirm-dialog-btn-cancel:hover {
            background: rgba(107, 114, 128, 0.3);
            color: var(--text-primary);
        }

        .confirm-dialog-btn-confirm {
            background: var(--neon-purple);
            color: white;
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.4);
        }

        .confirm-dialog-btn-confirm:hover {
            background: var(--neon-violet);
            box-shadow: 0 0 30px rgba(139, 92, 246, 0.6);
            transform: translateY(-2px);
        }

        .confirm-dialog-btn-confirm.danger {
            background: var(--attitude-dislike);
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.4);
        }

        .confirm-dialog-btn-confirm.danger:hover {
            background: var(--attitude-dislike-light);
            box-shadow: 0 0 30px rgba(239, 68, 68, 0.6);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Lightbox</h1>
            <p class="subtitle">专业影像甄选台 (Professional Image Curation)</p>
        </header>

        <div class="controls">
            <div class="control-group">
                <label>选择图片文件夹：</label>
                <input type="file" id="folderInput" webkitdirectory directory multiple>
                <button class="file-upload-btn btn-add-folder" onclick="document.getElementById('folderInput').click()">
                    📁 添加文件夹
                </button>
                <button class="load-btn btn-clear-folders" onclick="clearFolders()">
                    🗑️ 清空文件夹
                </button>
            </div>
            <div class="control-group" style="margin-top: -10px; padding-top: 0;">
                <span class="subtitle" style="font-size: 0.8rem; color: var(--text-muted); line-height: 1.6;">
                    <strong>单文件夹</strong>：逐张浏览评价 | <strong>多文件夹</strong>：自动对比模式（同时显示每个文件夹的第N张图）<br>
                    <strong>添加方式</strong>：① 逐个添加文件夹 ② 选择父文件夹批量添加所有子文件夹
                </span>
            </div>

            <div class="control-group" id="folderList" style="display: none; width: 100%; flex-direction: column; align-items: stretch; margin-bottom: 8px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <label style="margin: 0;">已添加的文件夹（按顺序）：</label>
                    <button class="toggle-rating-btn" id="toggleRatingBtn" onclick="toggleRatingMode()" style="display: none;">
                        <span id="toggleRatingIcon">⭐</span>
                        <span id="toggleRatingText">单一评分</span>
                    </button>
                </div>
                <div id="folderListContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); column-gap: 8px; row-gap: 2px;">
                    <!-- 文件夹列表将在这里动态生成 -->
                </div>
                <div style="margin-top: 12px; text-align: center;">
                    <button class="load-btn btn-load-images" onclick="loadImages()" style="padding: 10px 24px; font-size: 0.95rem;">
                        🖼️ 加载全部图片
                    </button>
                </div>
            </div>

            <!-- 布局选择器 -->
            <div class="control-group" id="layoutSelector" style="display: none; margin-top: 8px;">
                <label style="margin-right: 12px;">📐 布局：</label>
                <select id="layoutRows" onchange="updateLayout()" style="padding: 8px 12px; border-radius: 8px; border: 2px solid var(--border-color); margin-right: 8px; font-size: 0.9rem;">
                    <option value="1">1 行</option>
                    <option value="2">2 行</option>
                    <option value="3">3 行</option>
                    <option value="4">4 行</option>
                    <option value="5">5 行</option>
                    <option value="6">6 行</option>
                </select>
                <span style="margin: 0 8px; color: var(--text-muted);">×</span>
                <select id="layoutCols" onchange="updateLayout()" style="padding: 8px 12px; border-radius: 8px; border: 2px solid var(--border-color); font-size: 0.9rem;">
                    <option value="1">1 列</option>
                    <option value="2">2 列</option>
                    <option value="3" selected>3 列</option>
                    <option value="4">4 列</option>
                    <option value="5">5 列</option>
                    <option value="6">6 列</option>
                </select>
                <span style="margin-left: 12px; font-size: 0.85rem; color: var(--text-muted);">
                    每页显示 <span id="layoutTotal" style="font-weight: 600; color: var(--text-primary);">3</span> 张
                </span>
            </div>

        </div>

        <div class="stats-panel" id="statsPanel" style="display: none;">
            <div class="stats-grid">
                <div class="stat-item like">
                    <div class="stat-percentage" id="likePercent">0%</div>
                    <div class="stat-value" id="likeCount">0</div>
                    <div class="stat-label">👍 喜欢</div>
                    <div class="stat-progress-bar">
                        <div class="stat-progress-fill like" id="likeProgress" style="width: 0%"></div>
                    </div>
                </div>
                <div class="stat-item neutral">
                    <div class="stat-percentage" id="neutralPercent">0%</div>
                    <div class="stat-value" id="neutralCount">0</div>
                    <div class="stat-label">😐 一般</div>
                    <div class="stat-progress-bar">
                        <div class="stat-progress-fill neutral" id="neutralProgress" style="width: 0%"></div>
                    </div>
                </div>
                <div class="stat-item dislike">
                    <div class="stat-percentage" id="dislikePercent">0%</div>
                    <div class="stat-value" id="dislikeCount">0</div>
                    <div class="stat-label">👎 不喜欢</div>
                    <div class="stat-progress-bar">
                        <div class="stat-progress-fill dislike" id="dislikeProgress" style="width: 0%"></div>
                    </div>
                </div>
                <div class="stat-item" style="background: rgba(155, 143, 165, 0.05); border-color: rgba(155, 143, 165, 0.2);">
                    <div class="stat-percentage" id="unratedPercent">0%</div>
                    <div class="stat-value">
                        <span id="unratedCount">0</span>
                        <span style="margin: 0 4px; opacity: 0.3;">/</span>
                        <span id="totalImages" style="opacity: 0.7;">0</span>
                    </div>
                    <div class="stat-label">⭕ 未评分 / 照片总数</div>
                    <div class="stat-progress-bar">
                        <div class="stat-progress-fill unrated" id="unratedProgress" style="width: 0%"></div>
                    </div>
                </div>
            </div>
            <div style="text-align: center; margin-top: 30px;">
                <button class="load-btn" onclick="generateReport()" style="padding: 16px 40px; font-size: 1rem; background: transparent; border: 1.5px solid rgba(155, 143, 165, 0.3); color: #9B8FA5; font-weight: 500; letter-spacing: 0.05em;">
                    📊 生成报告
                </button>
            </div>
        </div>

        <!-- 快捷键提示 -->
        <div id="shortcutHint" style="display: none; text-align: center; padding: 8px; margin-bottom: 10px; background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(52, 211, 153, 0.1) 100%); border-radius: 8px; font-size: 0.85rem; color: #059669;">
            ⌨️ 快捷键: <strong>← →</strong> 翻页 | <strong>Space</strong> 预览 | 鼠标悬浮图片 + <strong>1</strong>喜欢/<strong>2</strong>一般/<strong>3</strong>不喜欢 | <strong>0</strong>取消 | <strong>⌘Z</strong>撤销
        </div>

        <div class="gallery" id="gallery">
            <div class="empty-state">
                <div class="empty-state-icon">🖼️</div>
                <div class="empty-state-text">选择文件夹并加载图片开始评分</div>
            </div>
        </div>

        <div class="pagination" id="pagination" style="display: none;">
            <button onclick="prevPage()">← 上一页</button>
            <div class="page-info">
                <span id="pageInfo">第 1 页</span>
            </div>
            <button onclick="nextPage()">下一页 →</button>
            <button onclick="takeScreenshot()" class="screenshot-btn" title="截图当前对比 (快捷键: S)">
                保存
            </button>
        </div>
    </div>

    <!-- 图片查看器模态框 -->
    <div class="image-modal" id="imageModal">
        <div class="modal-close" onclick="closeModal()">✕</div>
        <div class="zoom-info" id="zoomInfo">100%</div>
        <div class="modal-content" id="modalContent">
            <img id="modalImage" src="" alt="">
            <canvas id="drawCanvas" class="draw-canvas"></canvas>
        </div>
        <div class="modal-controls">
            <button class="modal-btn" onclick="zoomIn()">🔍 放大</button>
            <button class="modal-btn" onclick="zoomOut()">🔍 缩小</button>
            <button class="modal-btn" onclick="resetZoom()">↺ 重置</button>
            <button class="modal-btn" onclick="toggleDrawMode()" id="drawModeBtn" style="background: linear-gradient(135deg, var(--color-rose) 0%, var(--color-rose-light) 100%);">✏️ 标记细节</button>
        </div>
    </div>

    <!-- 画笔工具栏 -->
    <div class="draw-toolbar" id="drawToolbar">
        <button class="draw-tool-btn active" onclick="setDrawTool('pen')" title="画笔">✏️</button>
        <button class="draw-tool-btn" onclick="setDrawTool('eraser')" title="橡皮擦">🧹</button>
        <input type="color" class="color-picker" id="drawColor" value="#ef4444" title="颜色">
        <button class="draw-tool-btn" onclick="clearDrawing()" title="清除全部">🗑️</button>
        <button class="draw-tool-btn" onclick="saveDrawing()" title="保存标记">💾</button>
    </div>

    <!-- 预览悬浮框 -->
    <div class="preview-tooltip" id="previewTooltip">
        <div class="preview-title" id="previewTitle"></div>
        <div class="preview-grid" id="previewGrid"></div>
    </div>

    <!-- 对比栏 -->
    <div class="compare-bar" id="compareBar">
        <div class="compare-info">
            已选择 <span id="compareCount">0</span> 张图片
        </div>
        <button class="compare-btn" id="compareButton" onclick="openCompareModal()" disabled>
            🔍 开始对比
        </button>
        <button class="compare-btn clear-compare-btn" onclick="clearCompareSelection()">
            ✕ 清除选择
        </button>
    </div>

    <!-- 对比模态框 -->
    <div class="compare-modal" id="compareModal">
        <div class="compare-header">
            <div class="compare-title">图片对比</div>
            <div class="compare-mode-indicator sync-mode" id="compareModeIndicator" onclick="toggleCompareZoomMode()" style="cursor: pointer;" title="点击切换缩放模式，或按住Ctrl/Cmd键临时单张缩放">
                <span class="compare-mode-icon">🔗</span>
                <span id="compareModeText">同步缩放模式</span>
            </div>
            <div class="compare-close" onclick="closeCompareModal()">✕</div>
        </div>
        <div class="compare-content" id="compareContent">
            <!-- 对比图片将在这里动态生成 -->
        </div>
    </div>

    <!-- 全屏画廊模态框 -->
    <div class="fullscreen-gallery" id="fullscreenGallery">
        <div class="gallery-close" onclick="closeFullscreenGallery()">✕</div>
        <div class="gallery-info" id="galleryInfo">
            <span id="galleryZoomLevel">100%</span>
            <span style="margin-left: 16px; opacity: 0.7;">ESC 关闭</span>
        </div>
        <div class="gallery-container" id="galleryContainer">
            <!-- 图片将在这里动态生成 -->
        </div>
    </div>

    <!-- 报告模态框 -->
    <div class="report-modal" id="reportModal">
        <div class="report-buttons-wrapper">
            <div class="report-buttons">
                <button class="report-print-btn" onclick="window.print()">🖨️ 打印</button>
                <button class="report-export-btn" onclick="exportFileList()">💾 保存清单</button>
                <button class="report-confluence-btn" onclick="exportToConfluence()">📋 CF-MD</button>
                <button class="report-close-btn" onclick="closeReport()">✕</button>
            </div>
        </div>
        <div class="report-container" id="reportContainer">
            <!-- 报告内容将在这里动态生成 -->
        </div>
    </div>

    <!-- 子文件夹选择模态框 -->
    <div class="folder-select-modal" id="folderSelectModal">
        <div class="folder-select-container">
            <div class="folder-select-header">
                <div class="folder-select-title">选择要添加的文件夹</div>
                <div class="folder-select-subtitle">已检测到多个子文件夹，请勾选要添加的文件夹</div>
            </div>

            <div class="folder-select-all">
                <label>
                    <input type="checkbox" id="selectAllFolders" onchange="toggleSelectAllFolders(this.checked)">
                    全选/取消全选
                </label>
            </div>

            <div class="folder-select-list" id="folderSelectList">
                <!-- 文件夹列表将在这里动态生成 -->
            </div>

            <div class="folder-select-actions">
                <button class="folder-select-btn folder-select-btn-secondary" onclick="closeFolderSelectModal()">
                    取消
                </button>
                <button class="folder-select-btn folder-select-btn-primary" id="confirmFolderSelectBtn" onclick="confirmFolderSelection()">
                    添加选中的文件夹
                </button>
            </div>
        </div>
    </div>

    <!-- 帮助按钮 -->
    <div class="help-btn-wrapper">
        <div class="help-btn" onclick="openHelp()" title="使用说明">?</div>
    </div>

    <!-- 帮助模态框 -->
    <div class="help-modal" id="helpModal">
        <div class="help-container">
            <div class="help-close" onclick="closeHelp()">✕</div>
            <div class="help-title">📖 使用说明</div>

            <div class="mindmap">
                <!-- 中心节点 -->
                <div class="mindmap-center">
                    Lightbox<br>
                    <span style="font-size: 1.2rem; opacity: 0.9;">专业影像甄选台 (Professional Image Curation)</span>
                </div>

                <!-- 分支节点 -->
                <div class="mindmap-branches">
                    <!-- 图片加载 -->
                    <div class="mindmap-branch">
                        <div class="mindmap-branch-title">
                            <span class="mindmap-branch-icon">📁</span>
                            图片加载
                        </div>
                        <ul class="mindmap-branch-items">
                            <li><strong>单个文件夹：</strong>逐张浏览评价模式</li>
                            <li><strong>多个文件夹：</strong>自动对比模式（同时显示每个文件夹的第N张图）</li>
                            <li><strong>批量添加：</strong>选择父文件夹，自动识别所有子文件夹并批量添加</li>
                            <li><strong>支持格式：</strong>JPG, PNG, GIF, WEBP, BMP 以及 RAW 格式（CR2, CR3, NEF, ARW, ORF, DNG等）</li>
                            <li><strong>文件夹顺序：</strong>按添加顺序显示，可拖拽调整（会话内保持）</li>
                        </ul>
                    </div>

                    <!-- 评分系统 -->
                    <div class="mindmap-branch">
                        <div class="mindmap-branch-title">
                            <span class="mindmap-branch-icon">⭐</span>
                            评分系统
                        </div>
                        <ul class="mindmap-branch-items">
                            <li><strong>三种态度评分：</strong>👍 喜欢、😐 一般、👎 不喜欢</li>
                            <li><strong>添加评论：</strong>点击评分按钮后可输入文字评价（支持相似评论自动归纳）</li>
                            <li><strong>单一评分模式：</strong>点击"⭐ 单一评分"切换，统一管理所有文件夹的评分</li>
                            <li><strong>多维评分模式：</strong>同一张图片在不同文件夹中可有不同评分</li>
                            <li><strong>实时统计：</strong>4个统计卡片显示喜欢、一般、不喜欢、未评分的百分比和数量</li>
                            <li><strong>悬停预览：</strong>鼠标悬停在统计卡片上可快速预览该类别的图片</li>
                        </ul>
                    </div>

                    <!-- 键盘快捷键 -->
                    <div class="mindmap-branch">
                        <div class="mindmap-branch-title">
                            <span class="mindmap-branch-icon">⌨️</span>
                            键盘快捷键
                        </div>
                        <ul class="mindmap-branch-items">
                            <li><strong>空格键：</strong>下一组图片</li>
                            <li><strong><span class="hotkey">A</span>键：</strong>上一组图片</li>
                            <li><strong><span class="hotkey">Q</span>键（按住）：</strong>轮换对比文件夹顺序（对比模式或多文件夹主界面）</li>
                            <li><strong><span class="hotkey">S</span>键：</strong>截图保存当前显示的图片（多文件夹模式）</li>
                            <li><strong>ESC键：</strong>关闭模态框（对比、报告、帮助）</li>
                        </ul>
                    </div>

                    <!-- 对比模式 -->
                    <div class="mindmap-branch">
                        <div class="mindmap-branch-title">
                            <span class="mindmap-branch-icon">🔄</span>
                            对比模式
                        </div>
                        <ul class="mindmap-branch-items">
                            <li><strong>同名对比：</strong>点击图片名查看同名图片在所有文件夹中的版本</li>
                            <li><strong>独立缩放：</strong>每个版本可独立放大、缩小、拖动查看细节</li>
                            <li><strong>同步模式：</strong>点击"🔗 同步缩放"切换，所有图片同步缩放和移动</li>
                            <li><strong>评分对比：</strong>并排展示各版本评分，便于比较</li>
                            <li><strong>文件夹标识：</strong>每个版本标注所属文件夹名称</li>
                        </ul>
                    </div>

                    <!-- 画笔标记 -->
                    <div class="mindmap-branch">
                        <div class="mindmap-branch-title">
                            <span class="mindmap-branch-icon">✏️</span>
                            画笔标记
                        </div>
                        <ul class="mindmap-branch-items">
                            <li><strong>激活画笔：</strong>点击对比模式中的 ✏️ 按钮自动进入标记模式</li>
                            <li><strong>工具选择：</strong>提供画笔、橡皮擦、颜色选择器等工具</li>
                            <li><strong>保存标记：</strong>点击 💾 保存标记，下次查看时自动加载</li>
                            <li><strong>清除标记：</strong>点击 🗑️ 清除当前图片的所有标记</li>
                        </ul>
                    </div>

                    <!-- 生成报告 -->
                    <div class="mindmap-branch">
                        <div class="mindmap-branch-title">
                            <span class="mindmap-branch-icon">📊</span>
                            生成报告
                        </div>
                        <ul class="mindmap-branch-items">
                            <li><strong>自动归纳：</strong>相似的评论会自动分组显示</li>
                            <li><strong>Goodcase：</strong>展示所有"喜欢"的评价和图片</li>
                            <li><strong>Badcase：</strong>展示"一般"和"不喜欢"的评价和图片</li>
                            <li><strong>可编辑：</strong>报告中的标题、评论、图片文件名都可直接编辑</li>
                            <li><strong>替换图片：</strong>悬停在图片上点击 🔄 按钮可替换图片</li>
                        </ul>
                    </div>

                    <!-- 保存清单 -->
                    <div class="mindmap-branch">
                        <div class="mindmap-branch-title">
                            <span class="mindmap-branch-icon">💾</span>
                            保存清单
                        </div>
                        <ul class="mindmap-branch-items">
                            <li><strong>保存清单：</strong>点击报告页的"💾 保存清单"生成评分清单文件</li>
                            <li><strong>TXT格式：</strong>便于阅读的文本格式，包含完整评分信息</li>
                            <li><strong>JSON格式：</strong>结构化数据，便于程序处理</li>
                            <li><strong>持久化：</strong>所有评分和标记自动保存到浏览器本地</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 快捷键帮助面板 -->
    <div class="help-modal" id="helpModal">
        <div class="help-content">
            <div class="help-header">
                <h2>⌨️ 快捷键指南</h2>
                <button class="help-close" onclick="closeHelpModal()">✕</button>
            </div>
            <div class="help-body">
                <div class="help-section">
                    <h3>📄 浏览与导航</h3>
                    <div class="help-shortcuts">
                        <div class="help-item">
                            <kbd>←</kbd> <kbd>→</kbd>
                            <span>上一页 / 下一页</span>
                        </div>
                        <div class="help-item">
                            <kbd>Space</kbd>
                            <span>预览第一张图片</span>
                        </div>
                        <div class="help-item">
                            <kbd>ESC</kbd>
                            <span>关闭预览/帮助</span>
                        </div>
                    </div>
                </div>

                <div class="help-section">
                    <h3>⭐ 快速打分</h3>
                    <div class="help-shortcuts">
                        <div class="help-item highlight-like">
                            <div><kbd>鼠标悬浮</kbd> + <kbd>1</kbd></div>
                            <span>👍 标记喜欢</span>
                        </div>
                        <div class="help-item highlight-neutral">
                            <div><kbd>鼠标悬浮</kbd> + <kbd>2</kbd></div>
                            <span>😐 标记一般</span>
                        </div>
                        <div class="help-item highlight-dislike">
                            <div><kbd>鼠标悬浮</kbd> + <kbd>3</kbd></div>
                            <span>👎 标记不喜欢</span>
                        </div>
                        <div class="help-item">
                            <kbd>0</kbd>
                            <span>取消当前页所有评分</span>
                        </div>
                    </div>
                </div>

                <div class="help-section">
                    <h3>🔄 撤销与编辑</h3>
                    <div class="help-shortcuts">
                        <div class="help-item">
                            <kbd>⌘</kbd> + <kbd>Z</kbd> <span style="opacity: 0.5;">或</span> <kbd>Ctrl</kbd> + <kbd>Z</kbd>
                            <span>撤销上次操作（50步历史）</span>
                        </div>
                    </div>
                </div>

                <div class="help-section">
                    <h3>💡 提示</h3>
                    <div class="help-tips">
                        <p>• 鼠标悬浮在图片上会出现紫色边框，此时按 1/2/3 即可打分</p>
                        <p>• 打分后屏幕中央会闪现大emoji作为反馈</p>
                        <p>• 所有操作都会自动保存到本地存储</p>
                        <p>• 按 <kbd>?</kbd> 或 <kbd>h</kbd> 随时查看此帮助</p>
                    </div>
                </div>
            </div>
            <div class="help-footer">
                <p>🤖 专业影像甄选台 - 让打分更高效</p>
            </div>
        </div>
    </div>

    <!-- Toast 通知容器 -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Loading 加载指示器 -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">加载中...</div>
    </div>

    <!-- 确认对话框 -->
    <div class="confirm-dialog-overlay" id="confirmDialogOverlay">
        <div class="confirm-dialog">
            <div class="confirm-dialog-icon" id="confirmDialogIcon">⚠</div>
            <div class="confirm-dialog-title" id="confirmDialogTitle">确认操作</div>
            <div class="confirm-dialog-message" id="confirmDialogMessage">您确定要执行此操作吗？</div>
            <div class="confirm-dialog-buttons">
                <button class="confirm-dialog-btn confirm-dialog-btn-cancel" id="confirmDialogCancel">取消</button>
                <button class="confirm-dialog-btn confirm-dialog-btn-confirm" id="confirmDialogConfirm">确定</button>
            </div>
        </div>
    </div>

    <script>
        // Cursor Star Trail Effect
        (function initStarTrail() {
            let lastX = 0, lastY = 0;
            let throttleTimer = null;

            document.addEventListener('mousemove', function(e) {
                const dx = e.clientX - lastX;
                const dy = e.clientY - lastY;
                const distance = Math.sqrt(dx * dx + dy * dy);

                // Only create stars if mouse moved significantly
                if (distance > 15) {
                    if (!throttleTimer) {
                        createStar(e.clientX, e.clientY);
                        lastX = e.clientX;
                        lastY = e.clientY;

                        throttleTimer = setTimeout(() => {
                            throttleTimer = null;
                        }, 50);
                    }
                }
            });

            function createStar(x, y) {
                const star = document.createElement('div');
                star.className = 'star-particle';
                star.style.left = x + 'px';
                star.style.top = y + 'px';

                // Random size variation
                const size = 3 + Math.random() * 3;
                star.style.width = size + 'px';
                star.style.height = size + 'px';

                // Random color variation (white to purple)
                const hue = 250 + Math.random() * 30; // Purple range
                star.style.background = `hsl(${hue}, 70%, ${70 + Math.random() * 30}%)`;

                document.body.appendChild(star);

                // Remove star after animation
                setTimeout(() => {
                    star.remove();
                }, 800);
            }
        })();

        // 浏览器兼容性检测
        (function checkBrowserCompatibility() {
            const features = {
                fileReader: typeof FileReader !== 'undefined',
                localStorage: typeof localStorage !== 'undefined',
                grid: CSS.supports('display', 'grid'),
                flexbox: CSS.supports('display', 'flex')
            };

            const unsupported = Object.keys(features).filter(key => !features[key]);

            if (unsupported.length > 0) {
                console.warn('某些功能在当前浏览器中可能不支持:', unsupported);
            }

            // 检查文件夹选择支持
            const input = document.createElement('input');
            input.type = 'file';
            const supportsDirectory = 'webkitdirectory' in input || 'directory' in input;

            if (!supportsDirectory) {
                console.warn('当前浏览器可能不支持文件夹选择功能，建议使用最新版本的 Chrome、Edge、Firefox 或 Safari');
            }
        })();

        // ========== Toast 通知系统 ==========
        const Toast = {
            container: null,

            init() {
                this.container = document.getElementById('toastContainer');
            },

            show(message, type = 'info', title = '', duration = 4000) {
                if (!this.container) this.init();

                const icons = {
                    success: '✓',
                    error: '✕',
                    warning: '⚠',
                    info: 'ⓘ'
                };

                const titles = {
                    success: title || '成功',
                    error: title || '错误',
                    warning: title || '警告',
                    info: title || '提示'
                };

                const toast = document.createElement('div');
                toast.className = `toast ${type}`;

                toast.innerHTML = `
                    <div class="toast-icon">${icons[type] || 'ⓘ'}</div>
                    <div class="toast-content">
                        <div class="toast-title">${titles[type]}</div>
                        <div class="toast-message">${this.escapeHtml(message)}</div>
                    </div>
                    <button class="toast-close" aria-label="关闭">×</button>
                `;

                this.container.appendChild(toast);

                // 关闭按钮事件
                const closeBtn = toast.querySelector('.toast-close');
                closeBtn.addEventListener('click', () => this.hide(toast));

                // 自动关闭
                if (duration > 0) {
                    setTimeout(() => this.hide(toast), duration);
                }

                return toast;
            },

            hide(toast) {
                toast.classList.add('hiding');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            },

            success(message, title, duration) {
                return this.show(message, 'success', title, duration);
            },

            error(message, title, duration) {
                return this.show(message, 'error', title, duration);
            },

            warning(message, title, duration) {
                return this.show(message, 'warning', title, duration);
            },

            info(message, title, duration) {
                return this.show(message, 'info', title, duration);
            },

            // XSS防护：转义HTML
            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        };

        // 初始化Toast系统
        Toast.init();

        // ========== Loading 加载管理器 ==========
        const Loading = {
            overlay: null,
            textElement: null,
            activeCount: 0,

            init() {
                this.overlay = document.getElementById('loadingOverlay');
                this.textElement = document.getElementById('loadingText');
            },

            show(text = '加载中...') {
                if (!this.overlay) this.init();

                this.activeCount++;
                if (this.textElement) {
                    this.textElement.textContent = text;
                }
                this.overlay.classList.add('active');
            },

            hide() {
                if (!this.overlay) this.init();

                this.activeCount = Math.max(0, this.activeCount - 1);
                if (this.activeCount === 0) {
                    this.overlay.classList.remove('active');
                }
            },

            update(text) {
                if (this.textElement && this.activeCount > 0) {
                    this.textElement.textContent = text;
                }
            }
        };

        // 初始化Loading管理器
        Loading.init();

        // ========== 确认对话框系统 ==========
        const ConfirmDialog = {
            overlay: null,
            iconEl: null,
            titleEl: null,
            messageEl: null,
            cancelBtn: null,
            confirmBtn: null,
            resolveCallback: null,

            init() {
                this.overlay = document.getElementById('confirmDialogOverlay');
                this.iconEl = document.getElementById('confirmDialogIcon');
                this.titleEl = document.getElementById('confirmDialogTitle');
                this.messageEl = document.getElementById('confirmDialogMessage');
                this.cancelBtn = document.getElementById('confirmDialogCancel');
                this.confirmBtn = document.getElementById('confirmDialogConfirm');

                // 绑定事件
                this.cancelBtn.addEventListener('click', () => this.close(false));
                this.confirmBtn.addEventListener('click', () => this.close(true));

                // 点击遮罩关闭
                this.overlay.addEventListener('click', (e) => {
                    if (e.target === this.overlay) {
                        this.close(false);
                    }
                });

                // ESC键关闭
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && this.overlay.classList.contains('active')) {
                        this.close(false);
                    }
                });
            },

            show(options = {}) {
                const {
                    title = '确认操作',
                    message = '您确定要执行此操作吗？',
                    icon = '⚠',
                    confirmText = '确定',
                    cancelText = '取消',
                    danger = false
                } = options;

                return new Promise((resolve) => {
                    this.resolveCallback = resolve;

                    this.titleEl.textContent = title;
                    this.messageEl.textContent = message;
                    this.iconEl.textContent = icon;
                    this.confirmBtn.textContent = confirmText;
                    this.cancelBtn.textContent = cancelText;

                    // 设置危险样式
                    if (danger) {
                        this.confirmBtn.classList.add('danger');
                    } else {
                        this.confirmBtn.classList.remove('danger');
                    }

                    this.overlay.classList.add('active');
                });
            },

            close(result) {
                this.overlay.classList.remove('active');
                if (this.resolveCallback) {
                    this.resolveCallback(result);
                    this.resolveCallback = null;
                }
            }
        };

        // 初始化确认对话框
        ConfirmDialog.init();

        // 全局错误处理
        window.addEventListener('error', (event) => {
            console.error('全局错误:', event.error);
            Toast.error('发生了一个错误，请查看控制台获取详情', '系统错误');
        });

        window.addEventListener('unhandledrejection', (event) => {
            console.error('未处理的Promise拒绝:', event.reason);
            Toast.error('操作失败，请重试', '错误');
        });

        // 页面卸载时清理所有缓存
        window.addEventListener('beforeunload', () => {
            if (typeof cleanupAllImages === 'function') {
                cleanupAllImages();
            }
        });

        let allImages = [];
        let currentPage = 0;
        let imagesPerPage = 3;
        let layoutRows = 1; // 布局行数
        let layoutCols = 3; // 布局列数
        let ratings = {}; // 多维评分结构: { "filename.jpg": { "folder1": "like", "folder2": "dislike" } }
        let folders = []; // 存储所有文件夹信息 [{name: 'folder1', images: [...], files: [...]}]
        let selectedFolders = []; // 选中的文件夹索引列表（按选择顺序）
        let currentFolderName = ''; // 当前文件夹名称（用于报告）
        let pendingFolders = []; // 待选择的文件夹列表

        // 画笔功能变量
        let isDrawMode = false;
        let drawTool = 'pen';
        let drawColor = '#ef4444';
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;
        let drawings = {}; // 存储每张图片的标记数据: { "imageKey": [...paths] }
        let currentImageKey = '';  // 当前显示的图片key
        let isQuickAddMode = false; // 是否处于快速连续添加模式
        let ratingMode = 'single'; // 评分模式: 'single' 单一评分, 'multi' 多维评分
        let mainFolderIndex = -1; // 单一评分模式下的主文件夹索引（-1表示第一个文件夹）

        // 图片查看器状态
        let currentZoom = 1;
        let currentX = 0;
        let currentY = 0;
        let isDragging = false;
        let startX = 0;
        let startY = 0;

        // 对比功能状态
        let compareSelection = new Set(); // 存储选中的图片的唯一标识
        let compareImages = []; // 存储选中的图片对象
        let compareStates = {}; // 存储每张对比图片的缩放和位置状态
        let compareZoomMode = 'sync'; // 缩放模式：'sync' 同步, 'individual' 独立
        let compareFocusedImage = null; // 当前聚焦的图片key
        let compareHoverTimer = null; // 悬停计时器
        let compareContentWheelHandler = null; // 对比内容区域的滚轮事件处理器
        let originalCompareImages = null; // 保存原始对比图片（用于Q键预览）
        let originalFoldersOrder = null; // 保存原始文件夹顺序（用于Q键预览）
        let isQKeyPressed = false; // 标记Q键是否被按下
        let isCtrlCmdPressed = false; // 标记Ctrl/Cmd键是否被按下
        let manualIndividualMode = false; // 标记是否手动切换到独立模式

        // RAW 文件扩展名列表
        const RAW_EXTENSIONS = [
            'cr2', 'cr3', 'nef', 'arw', 'dng', 'orf', 'rw2', 'pef', 'srw', 'srf',
            'raf', 'raw', 'rwl', 'mrw', 'nrw', 'x3f', 'erf', 'kdc', 'dcr', 'sr2', '3fr'
        ];

        // 检查是否是图片文件（包括RAW格式）
        function isImageFile(file) {
            // 过滤macOS隐藏文件(以._开头)和其他隐藏文件
            if (file.name.startsWith('._') || file.name.startsWith('.')) {
                return false;
            }
            // 检查MIME类型
            if (file.type.startsWith('image/')) {
                return true;
            }
            // 检查文件扩展名（用于RAW格式）
            const ext = file.name.split('.').pop().toLowerCase();
            return RAW_EXTENSIONS.includes(ext);
        }

        // 检查是否是RAW文件
        function isRawFile(file) {
            const ext = file.name.split('.').pop().toLowerCase();
            return RAW_EXTENSIONS.includes(ext);
        }

        // 从RAW文件中提取嵌入的JPEG预览图（提取最大的一个以获得最佳质量）
        async function extractRawPreview(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const buffer = new Uint8Array(e.target.result);

                        // 查找所有JPEG标记 (0xFFD8 = JPEG开始, 0xFFD9 = JPEG结束)
                        const jpegs = [];

                        // 搜索所有JPEG起始和结束标记
                        for (let i = 0; i < buffer.length - 1; i++) {
                            if (buffer[i] === 0xFF && buffer[i + 1] === 0xD8) {
                                const jpegStart = i;

                                // 从当前位置搜索对应的结束标记
                                for (let j = jpegStart + 2; j < buffer.length - 1; j++) {
                                    if (buffer[j] === 0xFF && buffer[j + 1] === 0xD9) {
                                        const jpegEnd = j + 2;
                                        jpegs.push({
                                            start: jpegStart,
                                            end: jpegEnd,
                                            size: jpegEnd - jpegStart
                                        });
                                        i = jpegEnd; // 跳过已找到的JPEG
                                        break;
                                    }
                                }
                            }
                        }

                        // 如果找到JPEG，选择最大的一个（通常是全尺寸预览）
                        if (jpegs.length > 0) {
                            // 按大小排序，选择最大的
                            jpegs.sort((a, b) => b.size - a.size);
                            const largestJpeg = jpegs[0];

                            console.log(`在 ${file.name} 中找到 ${jpegs.length} 个嵌入预览图，使用最大的 (${(largestJpeg.size / 1024 / 1024).toFixed(2)} MB)`);

                            const jpegData = buffer.slice(largestJpeg.start, largestJpeg.end);
                            const blob = new Blob([jpegData], { type: 'image/jpeg' });
                            const url = URL.createObjectURL(blob);
                            resolve(url);
                        } else {
                            // 没有找到嵌入的JPEG，返回null
                            console.log(`未在 ${file.name} 中找到嵌入的预览图`);
                            resolve(null);
                        }
                    } catch (error) {
                        console.error('提取RAW预览失败:', error);
                        resolve(null);
                    }
                };
                reader.onerror = () => resolve(null);
                reader.readAsArrayBuffer(file);
            });
        }

        // 生成缩略图（用于卡片显示，减少内存占用）
        // 优化：使用Blob URL代替DataURL，节省33%内存
        // 高质量策略：保持清晰度，卡片用800x800高质量预览
        async function generateThumbnail(imageUrl, maxWidth = 800, maxHeight = 800) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = function() {
                    // 计算缩略图尺寸
                    let width = img.width;
                    let height = img.height;

                    if (width > maxWidth || height > maxHeight) {
                        const ratio = Math.min(maxWidth / width, maxHeight / height);
                        width = Math.floor(width * ratio);
                        height = Math.floor(height * ratio);
                    }

                    // 创建canvas生成缩略图
                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');

                    // 使用高质量缩放（保持质感）
                    ctx.imageSmoothingEnabled = true;
                    ctx.imageSmoothingQuality = 'high';
                    ctx.drawImage(img, 0, 0, width, height);

                    // 使用Blob URL代替DataURL（节省33%内存）
                    canvas.toBlob((blob) => {
                        if (blob) {
                            const url = URL.createObjectURL(blob);
                            resolve(url);
                        } else {
                            // 如果生成失败，返回原图
                            resolve(imageUrl);
                        }
                    }, 'image/jpeg', 0.92);
                };
                img.onerror = () => {
                    // 如果生成失败，返回原图
                    resolve(imageUrl);
                };
                img.src = imageUrl;
            });
        }

        // 从 localStorage 加载评分
        function loadRatings() {
            const saved = localStorage.getItem('imageRatings');
            if (saved) {
                const loadedRatings = JSON.parse(saved);

                // 检查是否是旧版本数据格式（值是字符串而不是对象）
                const firstKey = Object.keys(loadedRatings)[0];
                if (firstKey && typeof loadedRatings[firstKey] === 'string') {
                    // 迁移旧数据：将 {"img.jpg": "like"} 转换为 {"img.jpg": {"folder0": "like"}}
                    const migratedRatings = {};
                    for (const [key, value] of Object.entries(loadedRatings)) {
                        migratedRatings[key] = { "默认文件夹": value };
                    }
                    ratings = migratedRatings;
                    saveRatings(); // 保存迁移后的数据
                } else {
                    ratings = loadedRatings;
                }
            }
        }

        // 保存评分到 localStorage
        function saveRatings() {
            localStorage.setItem('imageRatings', JSON.stringify(ratings));
        }

        // 添加文件夹
        document.getElementById('folderInput').addEventListener('change', function() {
            const files = Array.from(this.files);

            if (files.length === 0) {
                return;
            }

            const imageFiles = files.filter(file => isImageFile(file));

            if (imageFiles.length === 0) {
                Toast.warning('所选文件夹中没有图片文件，请选择包含图片的文件夹', '提示');
                this.value = ''; // 重置input
                return;
            }

            // 分析文件路径，检测是否有子文件夹
            const folderMap = new Map(); // key: 文件夹路径, value: {name, files, images}

            imageFiles.forEach(file => {
                if (file.webkitRelativePath) {
                    const pathParts = file.webkitRelativePath.split('/');

                    // 如果路径深度 > 2，说明有子文件夹
                    if (pathParts.length > 2) {
                        // 使用第二级路径作为文件夹名（即第一级子文件夹）
                        const subFolderName = pathParts[1];
                        const folderKey = `${pathParts[0]}/${subFolderName}`;

                        if (!folderMap.has(folderKey)) {
                            folderMap.set(folderKey, {
                                name: subFolderName,
                                fullPath: folderKey,
                                files: [],
                                images: []
                            });
                        }

                        folderMap.get(folderKey).images.push(file);
                    } else {
                        // 没有子文件夹，直接使用根文件夹名
                        const rootFolderName = pathParts[0] || '未命名文件夹';

                        if (!folderMap.has(rootFolderName)) {
                            folderMap.set(rootFolderName, {
                                name: rootFolderName,
                                fullPath: rootFolderName,
                                files: [],
                                images: []
                            });
                        }

                        folderMap.get(rootFolderName).images.push(file);
                    }
                }
            });

            // 智能排序：优先数字，然后字母
            const sortedFolders = Array.from(folderMap.values()).sort((a, b) => {
                // 提取文件夹名开头的数字
                const aNum = parseInt(a.name.match(/^\d+/));
                const bNum = parseInt(b.name.match(/^\d+/));

                // 如果两者都有数字前缀，按数字排序
                if (!isNaN(aNum) && !isNaN(bNum)) {
                    return aNum - bNum;
                }

                // 如果只有一个有数字前缀，有数字的排在前面
                if (!isNaN(aNum)) return -1;
                if (!isNaN(bNum)) return 1;

                // 都没有数字前缀，按字母排序
                return a.name.localeCompare(b.name, 'zh-CN');
            });

            // 检测到多个子文件夹时显示选择界面
            if (sortedFolders.length > 1) {
                pendingFolders = sortedFolders;
                openFolderSelectModal();
            } else {
                // 只有一个文件夹，直接添加
                const folder = sortedFolders[0];

                // 检查是否已经添加过该文件夹
                if (folders.some(f => f.name === folder.name)) {
                    Toast.info(`文件夹"${folder.name}"已经添加过了`, '重复添加');

                    // 快速添加模式下继续
                    if (isQuickAddMode) {
                        setTimeout(() => {
                            document.getElementById('folderInput').click();
                        }, 100);
                    }
                } else {
                    folders.push({
                        name: folder.name,
                        fullPath: folder.fullPath,
                        files: folder.files || files,
                        images: folder.images
                    });

                    updateFolderList();
                    console.log(`已添加文件夹: ${folder.name} (${folder.images.length} 张图片)`);

                    // 快速添加模式下，自动弹出下一个文件夹选择
                    if (isQuickAddMode) {
                        setTimeout(() => {
                            document.getElementById('folderInput').click();
                        }, 100);
                    }
                }
            }

            // 重置input以便可以再次选择
            this.value = '';
        });

        // 更新布局设置
        function updateLayout() {
            const rowsSelect = document.getElementById('layoutRows');
            const colsSelect = document.getElementById('layoutCols');
            const totalSpan = document.getElementById('layoutTotal');

            layoutRows = parseInt(rowsSelect.value);
            layoutCols = parseInt(colsSelect.value);
            imagesPerPage = layoutRows * layoutCols;

            totalSpan.textContent = imagesPerPage;

            // 保存布局设置
            localStorage.setItem('layoutRows', layoutRows);
            localStorage.setItem('layoutCols', layoutCols);

            // 重新显示图片
            if (allImages.length > 0) {
                currentPage = 0;
                displayImages();
            }
        }

        // 加载布局设置
        function loadLayoutSettings() {
            const savedRows = localStorage.getItem('layoutRows');
            const savedCols = localStorage.getItem('layoutCols');

            if (savedRows) {
                layoutRows = parseInt(savedRows);
                document.getElementById('layoutRows').value = savedRows;
            }
            if (savedCols) {
                layoutCols = parseInt(savedCols);
                document.getElementById('layoutCols').value = savedCols;
            }

            imagesPerPage = layoutRows * layoutCols;
            document.getElementById('layoutTotal').textContent = imagesPerPage;
        }

        // 页面加载时恢复布局设置
        loadLayoutSettings();

        // 加载全部图片
        function loadImages() {
            if (folders.length === 0) {
                Toast.warning('请先添加至少一个文件夹', '提示');
                return;
            }

            Loading.show('正在加载图片...');

            // 使用 setTimeout 让 Loading 有时间显示
            setTimeout(() => {
                try {
                    // 设置总文件夹名称用于报告
                    if (folders.length === 1) {
                        currentFolderName = folders[0].name;
                        // 单文件夹模式：顺序加载所有图片
                        allImages = [];
                        folders[0].images.forEach(file => {
                            file.folderName = folders[0].name;
                            allImages.push(file);
                        });
                    } else {
                        currentFolderName = `${folders.length}个文件夹对比`;
                        // 多文件夹模式：统计所有图片用于报告
                        allImages = [];
                        folders.forEach(folder => {
                            folder.images.forEach(file => {
                                file.folderName = folder.name;
                                allImages.push(file);
                            });
                        });
                    }

                    const rawCount = allImages.filter(file => isRawFile(file)).length;
                    if (rawCount > 0) {
                        console.log(`检测到 ${rawCount} 个 RAW 格式文件`);
                        Loading.update(`正在处理 ${rawCount} 个 RAW 格式文件...`);
                    }

                    currentPage = 0;

                    loadRatings();
                    updateStats();
                    displayImages();

                    document.getElementById('statsPanel').style.display = 'block';
                    document.getElementById('pagination').style.display = 'flex';
                    document.getElementById('shortcutHint').style.display = 'block';

                    Loading.hide();
                    Toast.success(`成功加载 ${allImages.length} 张图片${rawCount > 0 ? `（含 ${rawCount} 张RAW）` : ''}`, '加载成功');
                } catch (error) {
                    Loading.hide();
                    console.error('加载图片时出错:', error);
                    Toast.error('加载图片时出错：' + error.message, '加载失败');
                }
            }, 100);
        }

        // 更新文件夹列表显示
        function updateFolderList() {
            const container = document.getElementById('folderListContainer');
            const folderList = document.getElementById('folderList');
            const toggleRatingBtn = document.getElementById('toggleRatingBtn');

            if (folders.length === 0) {
                folderList.style.display = 'none';
                container.innerHTML = '';
                toggleRatingBtn.style.display = 'none';
                return;
            }

            folderList.style.display = 'flex';
            container.innerHTML = '';

            // 只在多文件夹模式下显示评分模式切换按钮
            if (folders.length > 1) {
                toggleRatingBtn.style.display = 'inline-flex';
            } else {
                toggleRatingBtn.style.display = 'none';
            }

            // 初始化selectedFolders：默认显示所有文件夹
            // 检查是否有新添加的文件夹索引不在selectedFolders中
            if (folders.length > 0) {
                const allIndices = folders.map((_, idx) => idx);
                // 添加不在selectedFolders中的新索引
                allIndices.forEach(idx => {
                    if (!selectedFolders.includes(idx)) {
                        selectedFolders.push(idx);
                    }
                });
                // 移除不再存在的索引（文件夹被删除的情况）
                selectedFolders = selectedFolders.filter(idx => idx < folders.length);
            }

            folders.forEach((folder, index) => {
                const item = document.createElement('div');
                item.className = 'folder-list-item';

                // 单一评分模式下显示星标按钮
                let starButton = '';
                if (ratingMode === 'single' && folders.length > 1) {
                    const starIcon = mainFolderIndex === index ? '⭐' : '☆';
                    const starClass = mainFolderIndex === index ? 'active' : '';
                    starButton = `
                        <button class="folder-star-btn ${starClass}" onclick="toggleMainFolder(${index})" title="设为主文件夹（只评价此文件夹）">
                            ${starIcon}
                        </button>
                    `;
                }

                // 多维评分模式下显示文件夹标记
                let folderBadge = '';
                if (ratingMode === 'multi' && folders.length > 1) {
                    folderBadge = `<span class="folder-badge"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="width: 1em; height: 1em; vertical-align: -0.125em; fill: currentColor;"><path d="M10 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/></svg></span>`;
                }

                item.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 3px;">
                            <div class="folder-order">${index + 1}</div>
                            <div style="font-size: 0.65rem; opacity: 0.5; cursor: grab; user-select: none;" title="拖拽调整顺序">⋮⋮</div>
                        </div>
                        <button class="folder-remove-btn" onclick="event.stopPropagation(); removeFolder(${index})" style="padding: 1px 4px; font-size: 0.6rem;">✕</button>
                    </div>
                    <div style="display: flex; flex-direction: column; flex-shrink: 0;">
                        ${folderBadge}
                        <div class="folder-name" title="${folder.name}">${folder.name}</div>
                        <div class="folder-count">${folder.images.length} 张图片</div>
                    </div>
                    ${starButton ? `<div style="flex-shrink: 0;">${starButton}</div>` : ''}
                `;

                // 添加拖拽功能
                item.draggable = true;
                item.dataset.index = index;

                item.addEventListener('dragstart', (e) => {
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/html', item.innerHTML);
                    e.dataTransfer.setData('index', index);
                    item.style.opacity = '0.4';
                });

                item.addEventListener('dragend', (e) => {
                    item.style.opacity = '1';
                });

                item.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                    const afterElement = getDragAfterElement(container, e.clientY);
                    if (afterElement == null) {
                        container.appendChild(item);
                    } else {
                        container.insertBefore(item, afterElement);
                    }
                });

                item.addEventListener('drop', (e) => {
                    e.preventDefault();
                    const fromIndex = parseInt(e.dataTransfer.getData('index'));
                    const toIndex = parseInt(item.dataset.index);

                    if (fromIndex !== toIndex) {
                        // 重新排列folders数组
                        const movedFolder = folders.splice(fromIndex, 1)[0];
                        folders.splice(toIndex, 0, movedFolder);

                        // 更新selectedFolders：调整索引
                        selectedFolders = selectedFolders.map(idx => {
                            if (idx === fromIndex) {
                                return toIndex;
                            } else if (fromIndex < toIndex) {
                                // 向后移动：中间的索引需要减1
                                if (idx > fromIndex && idx <= toIndex) {
                                    return idx - 1;
                                }
                            } else {
                                // 向前移动：中间的索引需要加1
                                if (idx >= toIndex && idx < fromIndex) {
                                    return idx + 1;
                                }
                            }
                            return idx;
                        });

                        // 更新主文件夹索引
                        if (mainFolderIndex === fromIndex) {
                            mainFolderIndex = toIndex;
                        } else if (fromIndex < mainFolderIndex && toIndex >= mainFolderIndex) {
                            mainFolderIndex--;
                        } else if (fromIndex > mainFolderIndex && toIndex <= mainFolderIndex) {
                            mainFolderIndex++;
                        }

                        // 刷新显示
                        updateFolderList();
                        displayImages();
                    }
                });

                container.appendChild(item);
            });

            // 自动加载图片：如果有图片未加载，自动调用loadImages()
            if (folders.length > 0 && allImages.length === 0) {
                loadImages();
            }

            // 显示布局选择器（单文件夹和多文件夹模式都显示）
            const layoutSelector = document.getElementById('layoutSelector');
            if (folders.length > 0) {
                layoutSelector.style.display = 'flex';
            } else {
                layoutSelector.style.display = 'none';
            }
        }

        // 拖拽辅助函数：获取鼠标下方的元素
        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.folder-list-item:not(.dragging)')];

            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;

                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        // 切换文件夹选择状态
        function toggleFolderSelection(index, checked) {
            if (checked) {
                // 勾选：按勾选顺序添加到selectedFolders
                if (!selectedFolders.includes(index)) {
                    selectedFolders.push(index);
                }
            } else {
                // 取消勾选：从selectedFolders中移除
                const idx = selectedFolders.indexOf(index);
                if (idx > -1) {
                    selectedFolders.splice(idx, 1);
                }
            }

            // 至少保留一个选中的文件夹
            if (selectedFolders.length === 0 && folders.length > 0) {
                selectedFolders = [0];
                updateFolderList();
                Toast.warning('至少需要选中一个文件夹', '提示');
                return;
            }

            // 刷新显示
            updateFolderList();
            displayImages();
        }

        // 移除文件夹
        function removeFolder(index) {
            folders.splice(index, 1);

            // 更新selectedFolders：移除该索引，并调整后续索引
            selectedFolders = selectedFolders
                .filter(idx => idx !== index)
                .map(idx => idx > index ? idx - 1 : idx);

            // 如果移除的是主文件夹，清除主文件夹设置
            if (mainFolderIndex === index) {
                mainFolderIndex = -1;
                saveSettings();
            } else if (mainFolderIndex > index) {
                // 如果主文件夹在被移除文件夹之后，索引需要减1
                mainFolderIndex--;
                saveSettings();
            }

            updateFolderList();

            // 如果移除后没有文件夹了，清空显示
            if (folders.length === 0) {
                allImages = [];
                currentPage = 0;
                document.getElementById('gallery').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">🖼️</div>
                        <div class="empty-state-text">选择文件夹并加载图片开始评分</div>
                    </div>
                `;
                document.getElementById('statsPanel').style.display = 'none';
                document.getElementById('pagination').style.display = 'none';
                document.getElementById('shortcutHint').style.display = 'none';
            } else {
                // 重新显示图片（应用新的评分显示逻辑）
                displayImages();
            }

            Toast.success(`已移除文件夹"${folderName}"`, '移除成功');
        }

        // 切换主文件夹
        function toggleMainFolder(index) {
            if (mainFolderIndex === index) {
                // 取消主文件夹设置
                mainFolderIndex = -1;
            } else {
                // 设置为主文件夹
                mainFolderIndex = index;
            }
            saveSettings();
            updateFolderList();
            displayImages(); // 重新显示图片以应用新的评分显示逻辑
        }

        // 切换评分模式
        function toggleRatingMode() {
            ratingMode = ratingMode === 'single' ? 'multi' : 'single';

            // 如果切换到单一评分模式且没有设置主文件夹，默认选择第一个
            if (ratingMode === 'single' && mainFolderIndex === -1 && folders.length > 0) {
                mainFolderIndex = 0;
            }

            updateRatingModeButton();
            updateFolderList();
            saveSettings();
            displayImages(); // 重新显示图片
        }

        // 更新页面背景颜色（翻页时轻微变化）
        function updatePageBackground() {
            const body = document.body;
            // 根据页码生成轻微的色相偏移
            const hueShift = (currentPage % 5) * 2; // 每页偏移2度，5页一个循环
            const saturationShift = (currentPage % 3) * 2; // 饱和度轻微变化

            // 移除之前的样式
            body.style.transition = 'filter 0.5s ease-in-out';

            // 应用色相旋转和饱和度调整
            body.style.filter = `hue-rotate(${hueShift}deg) saturate(${100 + saturationShift}%)`;
        }

        // 更新评分模式按钮状态
        function updateRatingModeButton() {
            const btn = document.getElementById('toggleRatingBtn');
            const icon = document.getElementById('toggleRatingIcon');
            const text = document.getElementById('toggleRatingText');

            if (!btn) return;

            if (ratingMode === 'multi') {
                btn.classList.add('active');
                icon.textContent = '📊';
                text.textContent = '多维评分';
            } else {
                btn.classList.remove('active');
                icon.textContent = '⭐';
                text.textContent = '单一评分';
            }
        }

        // 保存设置到localStorage
        function saveSettings() {
            const settings = {
                ratingMode: ratingMode,
                mainFolderIndex: mainFolderIndex
            };
            localStorage.setItem('imageViewerSettings', JSON.stringify(settings));
        }

        // 从localStorage加载设置
        function loadSettings() {
            const saved = localStorage.getItem('imageViewerSettings');
            if (saved) {
                try {
                    const settings = JSON.parse(saved);
                    ratingMode = settings.ratingMode || 'single';
                    mainFolderIndex = settings.mainFolderIndex !== undefined ? settings.mainFolderIndex : -1;

                    // 更新模式按钮状态
                    updateRatingModeButton();
                } catch (e) {
                    console.error('加载设置失败:', e);
                }
            }
        }

        // 清空所有文件夹
        function clearFolders() {
            if (folders.length === 0) {
                return;
            }

            if (!confirm('确定要清空所有文件夹吗？')) {
                return;
            }

            folders = [];
            allImages = [];
            currentPage = 0;

            // 清理所有图片缓存，释放内存
            cleanupAllImages();

            updateFolderList();

            document.getElementById('gallery').innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">🖼️</div>
                    <div class="empty-state-text">选择文件夹并加载图片开始评分</div>
                </div>
            `;
            document.getElementById('statsPanel').style.display = 'none';
            document.getElementById('pagination').style.display = 'none';
            document.getElementById('shortcutHint').style.display = 'none';
        }

        // 辅助函数：将FileReader包装成Promise并添加错误处理
        function readFileAsDataURL(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => {
                    console.error('FileReader error:', e);
                    reject(new Error(`Failed to read file: ${file.name}`));
                };
                reader.readAsDataURL(file);
            });
        }

        // 辅助函数：标准化图片名称用于智能匹配
        function normalizeImageName(fileName) {
            // 去除文件扩展名
            const nameWithoutExt = fileName.replace(/\.[^.]+$/, '');
            // 转小写
            let normalized = nameWithoutExt.toLowerCase();
            // 去除所有空格、下划线、连字符
            normalized = normalized.replace(/[\s_-]+/g, '');
            // 去除前导零（如 001 -> 1）
            normalized = normalized.replace(/0+(\d+)/g, '$1');
            return normalized;
        }

        // 显示当前页图片
        async function displayImages() {
            const gallery = document.getElementById('gallery');
            gallery.innerHTML = '';

            // 翻页时背景颜色轻微变化
            updatePageBackground();

            if (folders.length === 1) {
                // 单文件夹模式：根据布局设置显示图片
                // 设置gallery的列数
                gallery.style.gridTemplateColumns = `repeat(${layoutCols}, 1fr)`;

                const start = currentPage * imagesPerPage;
                const end = start + imagesPerPage;
                const currentImages = allImages.slice(start, end);

                // 使用Promise.all并行处理，但保持顺序
                const imagePromises = currentImages.map(async (file) => {
                    const imageKey = `${file.name}_${file.size}`;

                    try {
                        if (isRawFile(file)) {
                            // 检查缓存
                            if (imageCache[imageKey]) {
                                return createImageCard(file, imageCache[imageKey], false);
                            } else {
                                // 尝试提取RAW文件中的预览图
                                const previewUrl = await extractRawPreview(file);
                                if (previewUrl) {
                                    // 成功提取预览图，保存到缓存
                                    imageCache[imageKey] = previewUrl;
                                    return createImageCard(file, previewUrl, false);
                                } else {
                                    // 无法提取预览图，显示图标
                                    return createImageCard(file, null, true);
                                }
                            }
                        } else {
                            // 检查缩略图缓存
                            if (thumbnailCache[imageKey]) {
                                return createImageCard(file, thumbnailCache[imageKey], false);
                            } else if (imageCache[imageKey]) {
                                return createImageCard(file, imageCache[imageKey], false);
                            } else {
                                // 读取图片并缓存
                                const dataUrl = await readFileAsDataURL(file);
                                imageCache[imageKey] = dataUrl;
                                return createImageCard(file, dataUrl, false);
                            }
                        }
                    } catch (error) {
                        console.error(`Failed to load image ${file.name}:`, error);
                        // 即使失败也返回一个占位卡片
                        return createErrorCard(file);
                    }
                });

                // 等待所有图片处理完成，然后按顺序添加到gallery
                const cards = await Promise.all(imagePromises);
                cards.forEach(card => gallery.appendChild(card));
            } else {
                // 多文件夹对比模式：按位置对比（第N张对比第N张）
                gallery.style.gridTemplateColumns = `repeat(${folders.length}, 1fr)`;

                // 对每个文件夹的图片按文件名排序（使用自然排序）
                const sortedFolders = folders.map(folder => {
                    return {
                        ...folder,
                        sortedImages: [...folder.images].sort((a, b) => {
                            return a.name.localeCompare(b.name, undefined, { numeric: true, sensitivity: 'base' });
                        })
                    };
                });

                // 找出最大的图片数量
                const maxImageCount = Math.max(...sortedFolders.map(f => f.sortedImages.length));

                // 分页显示
                const start = currentPage * imagesPerPage;
                const end = Math.min(start + imagesPerPage, maxImageCount);
                const totalRows = end - start;

                // 逐行显示：每行显示所有文件夹的第N张图片
                for (let rowIndex = 0; rowIndex < totalRows; rowIndex++) {
                    const imageIndex = start + rowIndex;

                    const rowPromises = sortedFolders.map(async (folder, folderIndex) => {
                        // 获取该文件夹的第N张图片
                        const file = folder.sortedImages[imageIndex];

                        if (file) {
                            // 有该图片，正常显示
                            const imageKey = `${file.name}_${file.size}`;

                            try {
                                if (isRawFile(file)) {
                                    // 检查缓存
                                    if (imageCache[imageKey]) {
                                        return createImageCard(file, imageCache[imageKey], false, folderIndex);
                                    } else {
                                        // 尝试提取RAW文件中的预览图
                                        const previewUrl = await extractRawPreview(file);
                                        if (previewUrl) {
                                            imageCache[imageKey] = previewUrl;
                                            return createImageCard(file, previewUrl, false, folderIndex);
                                        } else {
                                            return createImageCard(file, null, true, folderIndex);
                                        }
                                    }
                                } else {
                                    // 检查缩略图缓存
                                    if (thumbnailCache[imageKey]) {
                                        return createImageCard(file, thumbnailCache[imageKey], false, folderIndex);
                                    } else if (imageCache[imageKey]) {
                                        return createImageCard(file, imageCache[imageKey], false, folderIndex);
                                    } else {
                                        // 读取图片并缓存
                                        const dataUrl = await readFileAsDataURL(file);
                                        imageCache[imageKey] = dataUrl;
                                        return createImageCard(file, dataUrl, false, folderIndex);
                                    }
                                }
                            } catch (error) {
                                console.error(`Failed to load image ${file.name}:`, error);
                                return createErrorCard(file, folderIndex);
                            }
                        } else {
                            // 该文件夹没有这个名字的图片，显示占位符
                            const emptyCard = document.createElement('div');
                            emptyCard.className = 'image-card';
                            emptyCard.innerHTML = `
                                <div class="image-container" style="display: flex; align-items: center; justify-content: center; background: rgba(139, 92, 246, 0.05);">
                                    <div style="text-align: center; color: var(--text-muted);">
                                        <div style="font-size: 2rem; opacity: 0.3; margin-bottom: 8px;">📭</div>
                                        <div style="font-size: 0.8rem;">缺失</div>
                                    </div>
                                </div>
                                <div class="image-name" style="opacity: 0.5;">${folder.name}</div>
                            `;
                            return emptyCard;
                        }
                    });

                    // 等待当前行的所有图片加载完成，然后按顺序添加
                    const rowCards = await Promise.all(rowPromises);
                    rowCards.forEach(card => gallery.appendChild(card));
                }
            }

            updatePaginationButtons();
        }

        // 创建错误卡片（当图片加载失败时显示）
        function createErrorCard(file, folderIndex = -1) {
            const card = document.createElement('div');
            card.className = 'image-card';

            const folderName = file.folderName || (folders[folderIndex] ? folders[folderIndex].name : '');
            const folderTag = folders.length > 1 && folderName ?
                `<div class="folder-tag">${folderName}</div>` : '';

            card.innerHTML = `
                ${folderTag}
                <div class="image-container" style="display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(239, 68, 68, 0.1);">
                    <div style="font-size: 3rem; margin-bottom: 12px; opacity: 0.5;">⚠️</div>
                    <div style="font-size: 0.9rem; color: var(--text-muted); text-align: center; padding: 0 20px;">加载失败</div>
                    <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 8px; opacity: 0.7;">点击重新加载</div>
                </div>
                <div class="image-name" title="${file.name}" style="opacity: 0.7;">${file.name}</div>
            `;

            // 点击重试
            card.querySelector('.image-container').style.cursor = 'pointer';
            card.querySelector('.image-container').onclick = () => {
                Toast.info('正在重新加载...', '重试');
                displayImages();
            };

            return card;
        }

        // 创建图片卡片
        function createImageCard(file, imageUrl, isRaw = false, folderIndex = -1) {
            const card = document.createElement('div');
            card.className = 'image-card';

            const imageKey = `${file.name}_${file.size}`;

            // 根据评分模式获取当前评分和评论
            let currentRating = null;
            let currentComment = '';
            let folderName = file.folderName || (folders[folderIndex] ? folders[folderIndex].name : '');

            if (ratings[imageKey]) {
                if (ratingMode === 'single') {
                    // 单一评分模式：只显示主文件夹的评分
                    const targetFolderIndex = mainFolderIndex !== -1 ? mainFolderIndex : 0;
                    const targetFolderName = folders[targetFolderIndex] ? folders[targetFolderIndex].name : '';
                    const ratingData = ratings[imageKey][targetFolderName];
                    if (typeof ratingData === 'string') {
                        currentRating = ratingData;
                    } else if (ratingData && typeof ratingData === 'object') {
                        currentRating = ratingData.rating;
                        currentComment = ratingData.comment || '';
                    }
                } else {
                    // 多维评分模式：显示当前文件夹的评分
                    const ratingData = ratings[imageKey][folderName];
                    if (typeof ratingData === 'string') {
                        currentRating = ratingData;
                    } else if (ratingData && typeof ratingData === 'object') {
                        currentRating = ratingData.rating;
                        currentComment = ratingData.comment || '';
                    }
                }
            }

            // 判断是否显示评分按钮
            let showRating = true;

            // 评分按钮始终显示
            // 注释掉原来的限制逻辑，让喜好度标签在所有情况下都可见
            // if (ratingMode === 'single' && folders.length > 1) {
            //     const targetFolderIndex = mainFolderIndex !== -1 ? mainFolderIndex : 0;
            //     if (folderIndex !== -1 && folderIndex !== targetFolderIndex) {
            //         showRating = false;
            //     }
            // }

            let imageContent;
            if (isRaw) {
                const ext = file.name.split('.').pop().toUpperCase();
                imageContent = `
                    <div class="image-container" style="display: flex; flex-direction: column; align-items: center; justify-content: center; background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-card) 100%);">
                        <div style="font-size: 4rem; margin-bottom: 20px; opacity: 0.6;">📷</div>
                        <div style="font-size: 1.2rem; font-weight: 600; color: var(--primary-purple); margin-bottom: 8px;">${ext} 格式</div>
                        <div style="font-size: 0.9rem; color: var(--text-muted); text-align: center; padding: 0 20px;">RAW 文件已识别<br/>可正常评分</div>
                    </div>
                `;
            } else {
                // 所有模式：点击图片打开单图预览
                // 使用data属性存储信息，避免onclick中的转义问题
                const containerId = `img-container-${imageKey}-${Date.now()}`;
                imageContent = `
                    <div class="image-container" id="${containerId}" style="cursor: pointer;" data-image-key="${imageKey}">
                        <img src="${imageUrl}" alt="${file.name}">
                    </div>
                `;
            }

            const isSelected = compareSelection.has(imageKey);

            // 文件夹标签（仅在有多个文件夹时显示）
            const folderTag = folders.length > 1 && file.folderName ?
                `<div class="folder-tag">${file.folderName}</div>` : '';

            // 多文件夹模式下不显示复选框
            const compareCheckbox = folders.length === 1 ? `
                <input type="checkbox" class="compare-checkbox" id="compare_${imageKey}"
                       ${isSelected ? 'checked' : ''}
                       onchange="toggleCompareSelection('${imageKey}', this.checked)">
                <label class="compare-checkbox-label" for="compare_${imageKey}"></label>
            ` : '';

            // 根据条件决定是否显示评分按钮
            // 对于多维评分，需要传递文件夹名称
            const escapedFolderName = folderName.replace(/'/g, "\\'");
            const escapedComment = currentComment.replace(/'/g, "\\'").replace(/\n/g, '\\n');

            let ratingBar = '';
            if (showRating) {
                // 态度评分系统
                ratingBar = `
                    <div class="attitude-bar">
                        <button class="attitude-btn ${currentRating === 'like' ? 'active like' : ''}"
                                onclick="rateImage('${imageKey}', 'like', this, '${escapedFolderName}')">
                            👍 喜欢
                        </button>
                        <button class="attitude-btn ${currentRating === 'neutral' ? 'active neutral' : ''}"
                                onclick="rateImage('${imageKey}', 'neutral', this, '${escapedFolderName}')">
                            😐 一般
                        </button>
                        <button class="attitude-btn ${currentRating === 'dislike' ? 'active dislike' : ''}"
                                onclick="rateImage('${imageKey}', 'dislike', this, '${escapedFolderName}')">
                            👎 不喜欢
                        </button>
                    </div>
                    <div class="comment-box">
                        ${currentComment ? `
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <button class="toggle-comment-btn" onclick="toggleCommentBox('${imageKey}')" style="font-size: 0.8rem; padding: 4px 8px; flex-shrink: 0;">💬</button>
                                <div style="flex: 1; font-size: 0.85rem; color: var(--text-secondary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${currentComment}</div>
                            </div>
                            <textarea class="comment-input" id="comment_${imageKey}" style="display: none; margin-top: 4px;"
                                      placeholder="添加评价 (可选)..."
                                      onchange="saveComment('${imageKey}', this.value, '${escapedFolderName}')"
                                      onblur="saveComment('${imageKey}', this.value, '${escapedFolderName}')"
                            >${currentComment}</textarea>
                        ` : `
                            <textarea class="comment-input" id="comment_${imageKey}"
                                      placeholder="添加评价 (可选)..."
                                      onchange="saveComment('${imageKey}', this.value, '${escapedFolderName}')"
                                      onblur="saveComment('${imageKey}', this.value, '${escapedFolderName}')"
                            ></textarea>
                        `}
                    </div>
                `;
            }

            card.innerHTML = `
                ${compareCheckbox}
                ${folderTag}
                ${imageContent}
                <div class="image-name" title="${file.name}">${file.name}</div>
                ${ratingBar}
            `;

            // 添加点击事件监听器：打开全屏画廊
            if (!isRaw) {
                const container = card.querySelector('.image-container');
                if (container) {
                    container.addEventListener('click', function() {
                        openFullscreenGallery();
                    });
                }
            }

            return card;
        }

        // 评分图片
        function rateImage(imageKey, rating, button, folderName) {
            const ratingBar = button.parentElement;
            const buttons = ratingBar.querySelectorAll('.rating-btn, .attitude-btn');

            // 初始化评分对象
            if (!ratings[imageKey]) {
                ratings[imageKey] = {};
            }

            // 获取当前评分数据
            const currentData = ratings[imageKey][folderName];
            const currentRating = typeof currentData === 'string' ? currentData : (currentData?.rating || null);
            const currentComment = typeof currentData === 'object' ? (currentData?.comment || '') : '';

            // 如果点击已选中的按钮，则取消评分
            if (currentRating === rating) {
                delete ratings[imageKey][folderName];
                // 如果这个图片没有任何文件夹的评分了，删除整个条目
                if (Object.keys(ratings[imageKey]).length === 0) {
                    delete ratings[imageKey];
                }
                buttons.forEach(btn => {
                    // 移除所有可能的类名
                    btn.classList.remove('active', 'like', 'neutral', 'dislike');
                });
            } else {
                // 保存评分，如果有评论则保存为对象
                if (currentComment) {
                    ratings[imageKey][folderName] = {
                        rating: rating,
                        comment: currentComment
                    };
                } else {
                    ratings[imageKey][folderName] = {
                        rating: rating,
                        comment: ''
                    };
                }
                buttons.forEach(btn => {
                    // 移除所有可能的类名
                    btn.classList.remove('active', 'like', 'neutral', 'dislike');
                });
                button.classList.add('active', rating);
            }

            saveRatings();
            updateStats();
        }

        // 切换评论框显示/隐藏
        function toggleCommentBox(imageKey) {
            const textarea = document.getElementById(`comment_${imageKey}`);
            const commentBox = textarea.parentElement;
            const previewDiv = commentBox.querySelector('div[style*="flex"]');

            if (textarea.style.display === 'none' || !textarea.style.display) {
                // 显示编辑框
                textarea.style.display = 'block';
                if (previewDiv) {
                    previewDiv.style.display = 'none';
                }
                textarea.focus();
            } else {
                // 隐藏编辑框
                const comment = textarea.value.trim();
                if (comment) {
                    // 有评论内容：显示预览
                    textarea.style.display = 'none';
                    if (previewDiv) {
                        previewDiv.style.display = 'flex';
                        // 更新预览文本
                        const textDiv = previewDiv.querySelector('div[style*="flex: 1"]');
                        if (textDiv) {
                            textDiv.textContent = comment;
                        }
                    }
                } else {
                    // 无内容：保持输入框显示
                    textarea.style.display = 'block';
                }
            }
        }

        function saveComment(imageKey, comment, folderName) {
            comment = comment.trim();

            if (!ratings[imageKey]) {
                ratings[imageKey] = {};
            }

            const currentData = ratings[imageKey][folderName];
            const currentRating = typeof currentData === 'string' ? currentData : (currentData?.rating || null);

            // 如果有评分或评论，保存为对象
            if (currentRating || comment) {
                ratings[imageKey][folderName] = {
                    rating: currentRating,
                    comment: comment
                };
            } else {
                // 如果既没有评分也没有评论，删除条目
                delete ratings[imageKey][folderName];
                if (Object.keys(ratings[imageKey]).length === 0) {
                    delete ratings[imageKey];
                }
            }

            saveRatings();
        }

        // 更新统计数据
        function updateStats() {
            const total = allImages.length;
            let like = 0, neutral = 0, dislike = 0;

            allImages.forEach(file => {
                const imageKey = `${file.name}_${file.size}`;
                const folderName = file.folderName || '';

                // 获取评分（根据评分模式）
                let ratingData = null;
                if (ratings[imageKey]) {
                    if (ratingMode === 'single') {
                        // 单一评分模式：统计主文件夹的评分
                        const targetFolderIndex = mainFolderIndex !== -1 ? mainFolderIndex : 0;
                        const targetFolderName = folders[targetFolderIndex] ? folders[targetFolderIndex].name : '';
                        ratingData = ratings[imageKey][targetFolderName];
                    } else {
                        // 多维评分模式：统计所有文件夹的评分
                        ratingData = ratings[imageKey][folderName];
                    }
                }

                // 兼容新旧数据格式
                const rating = typeof ratingData === 'string' ? ratingData : (ratingData?.rating || null);

                if (rating === 'like') like++;
                else if (rating === 'neutral') neutral++;
                else if (rating === 'dislike') dislike++;
            });

            const unrated = total - like - neutral - dislike;

            // 计算百分比
            const likePercent = total > 0 ? Math.round((like / total) * 100) : 0;
            const neutralPercent = total > 0 ? Math.round((neutral / total) * 100) : 0;
            const dislikePercent = total > 0 ? Math.round((dislike / total) * 100) : 0;
            const unratedPercent = total > 0 ? Math.round((unrated / total) * 100) : 0;

            // 更新数量
            document.getElementById('totalImages').textContent = total;
            document.getElementById('likeCount').textContent = like;
            document.getElementById('neutralCount').textContent = neutral;
            document.getElementById('dislikeCount').textContent = dislike;

            // 未评分卡片：如果所有图片都评分了，显示照片总数
            const unratedCard = document.querySelector('.stat-item:has(#unratedCount)');
            const unratedLabel = unratedCard?.querySelector('.stat-label');
            const unratedIcon = unratedCard?.querySelector('.stat-value').previousElementSibling;

            if (unrated === 0) {
                document.getElementById('unratedCount').textContent = total;
                document.getElementById('unratedPercent').textContent = '100%';
                if (unratedLabel) unratedLabel.textContent = '📊 照片总数';
            } else {
                document.getElementById('unratedCount').textContent = unrated;
                document.getElementById('unratedPercent').textContent = `${unratedPercent}%`;
                if (unratedLabel) unratedLabel.textContent = '⭕ 未评分';
            }

            // 更新百分比
            document.getElementById('likePercent').textContent = `${likePercent}%`;
            document.getElementById('neutralPercent').textContent = `${neutralPercent}%`;
            document.getElementById('dislikePercent').textContent = `${dislikePercent}%`;

            // 更新进度条
            document.getElementById('likeProgress').style.width = `${likePercent}%`;
            document.getElementById('neutralProgress').style.width = `${neutralPercent}%`;
            document.getElementById('dislikeProgress').style.width = `${dislikePercent}%`;
            document.getElementById('unratedProgress').style.width = `${unratedPercent}%`;
        }

        // 上一页
        function prevPage() {
            if (currentPage > 0) {
                currentPage--;
                displayImages();
                cleanupOldImages(); // 清理旧页面图片，释放内存
            }
        }

        // 下一页
        function nextPage() {
            let maxPage;
            if (folders.length === 1) {
                // 单文件夹模式
                const imagesPerPage = 3;
                maxPage = Math.ceil(allImages.length / imagesPerPage) - 1;
            } else {
                // 多文件夹对比模式：按最大图片数量计算（位置对比）
                const maxImageCount = Math.max(...folders.map(f => f.images.length));
                maxPage = Math.ceil(maxImageCount / imagesPerPage) - 1;
            }

            if (currentPage < maxPage) {
                currentPage++;
                displayImages();
                cleanupOldImages(); // 清理旧页面图片，释放内存
            }
        }

        // 更新分页按钮状态
        function updatePaginationButtons() {
            let maxPage, totalPages;

            if (folders.length === 1) {
                // 单文件夹模式
                const imagesPerPage = 3;
                maxPage = Math.ceil(allImages.length / imagesPerPage) - 1;
                totalPages = maxPage + 1;
            } else {
                // 多文件夹对比模式：按最大图片数量计算（位置对比）
                const maxImageCount = Math.max(...folders.map(f => f.images.length));
                maxPage = Math.ceil(maxImageCount / imagesPerPage) - 1;
                totalPages = maxPage + 1;
            }

            const buttons = document.querySelectorAll('.pagination button');
            const pageInfo = document.getElementById('pageInfo');

            buttons[0].disabled = currentPage === 0;
            buttons[1].disabled = currentPage === maxPage;

            if (folders.length === 1) {
                pageInfo.textContent = `第 ${currentPage + 1} 页 / 共 ${totalPages} 页`;
            } else {
                pageInfo.textContent = `第 ${currentPage + 1} 组 / 共 ${totalPages} 组 (按图片名对比)`;
            }
        }

        // 初始化
        loadRatings();
        loadSettings(); // 加载用户设置（评分模式、主文件夹等）
        loadDrawings(); // 加载画笔标记

        // ==================== 图片查看器功能 ====================

        // 打开模态框
        // 防止重复打开modal的标志
        let isModalOpening = false;

        function openModal(imageUrl, imageKey = '') {
            const modal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');

            // 优化渲染性能：使用 requestAnimationFrame
            requestAnimationFrame(() => {
                // 先重置缩放状态（在图片加载前）
                currentZoom = 1;
                currentX = 0;
                currentY = 0;

                // 添加加载类（可以显示加载动画）
                modal.classList.add('loading');

                // 设置图片源
                modalImage.src = imageUrl;

                // 图片加载完成后的处理
                const onImageLoad = () => {
                    requestAnimationFrame(() => {
                        // 移除加载类
                        modal.classList.remove('loading');
                        // 应用变换
                        updateTransform();

                        // 如果处于画笔模式，加载标记
                        if (isDrawMode) {
                            setTimeout(() => loadDrawing(), 100);
                        }
                    });
                    modalImage.removeEventListener('load', onImageLoad);
                };

                modalImage.addEventListener('load', onImageLoad);

                // 立即显示模态框（图片可能还在加载）
                modal.classList.add('active');

                // 设置当前图片key用于标记功能
                currentImageKey = imageKey;

                // 阻止body滚动
                document.body.style.overflow = 'hidden';
            });
        }

        // 打开模态框并自动激活画笔模式
        function openModalForDrawing(imageUrl, imageKey = '') {
            openModal(imageUrl, imageKey);

            // 等待图片加载后自动激活画笔（无延迟）
            const modalImage = document.getElementById('modalImage');
            const originalOnload = modalImage.onload;
            modalImage.onload = function() {
                if (originalOnload) originalOnload.call(this);
                if (!isDrawMode) {
                    requestAnimationFrame(() => toggleDrawMode());
                }
            };
        }

        // 关闭模态框
        function closeModal() {
            const modal = document.getElementById('imageModal');
            modal.classList.remove('active');

            // 关闭画笔模式
            if (isDrawMode) {
                toggleDrawMode();
            }

            // 恢复body滚动
            document.body.style.overflow = 'auto';
        }

        // 放大
        function zoomIn() {
            currentZoom = Math.min(currentZoom + 0.25, 5);
            updateTransform();
        }

        // 缩小
        function zoomOut() {
            currentZoom = Math.max(currentZoom - 0.25, 0.25);
            updateTransform();
        }

        // 重置缩放
        function resetZoom() {
            currentZoom = 1;
            currentX = 0;
            currentY = 0;
            updateTransform();
        }

        // 更新变换
        function updateTransform() {
            const modalContent = document.getElementById('modalContent');
            // 使用 translate(-50%, -50%) 来居中，然后应用用户的拖动偏移和缩放
            modalContent.style.transform = `translate(calc(-50% + ${currentX}px), calc(-50% + ${currentY}px)) scale(${currentZoom})`;

            // 更新缩放信息显示
            const zoomInfo = document.getElementById('zoomInfo');
            zoomInfo.textContent = `${Math.round(currentZoom * 100)}%`;

            // 更新canvas大小和位置
            if (isDrawMode) {
                const canvas = document.getElementById('drawCanvas');
                const img = document.getElementById('modalImage');
                canvas.style.transform = modalContent.style.transform;
            }
        }

        // ==================== 画笔功能 ====================

        // 切换画笔模式
        function toggleDrawMode() {
            isDrawMode = !isDrawMode;
            const toolbar = document.getElementById('drawToolbar');
            const btn = document.getElementById('drawModeBtn');
            const modal = document.getElementById('imageModal');
            const canvas = document.getElementById('drawCanvas');

            if (isDrawMode) {
                toolbar.classList.add('active');
                btn.classList.add('active');
                btn.textContent = '✓ 标记中...';
                btn.style.background = 'linear-gradient(135deg, var(--color-like) 0%, var(--color-like-light) 100%)';
                modal.style.cursor = 'crosshair';

                // 初始化canvas
                const img = document.getElementById('modalImage');
                canvas.width = img.naturalWidth;
                canvas.height = img.naturalHeight;
                canvas.style.width = img.width + 'px';
                canvas.style.height = img.height + 'px';
                canvas.style.transform = document.getElementById('modalContent').style.transform;

                // 加载已有的标记
                loadDrawing();

                // 添加canvas事件监听
                canvas.addEventListener('mousedown', startDrawing);
                canvas.addEventListener('mousemove', draw);
                canvas.addEventListener('mouseup', stopDrawing);
                canvas.addEventListener('mouseout', stopDrawing);
            } else {
                toolbar.classList.remove('active');
                btn.classList.remove('active');
                btn.textContent = '✏️ 标记细节';
                btn.style.background = 'linear-gradient(135deg, var(--color-rose) 0%, var(--color-rose-light) 100%)';
                modal.style.cursor = 'grab';

                // 移除canvas事件监听
                canvas.removeEventListener('mousedown', startDrawing);
                canvas.removeEventListener('mousemove', draw);
                canvas.removeEventListener('mouseup', stopDrawing);
                canvas.removeEventListener('mouseout', stopDrawing);
            }
        }

        // 设置绘图工具
        function setDrawTool(tool) {
            drawTool = tool;
            document.querySelectorAll('.draw-tool-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            const canvas = document.getElementById('drawCanvas');
            if (tool === 'eraser') {
                canvas.style.cursor = 'cell';
            } else {
                canvas.style.cursor = 'crosshair';
            }
        }

        // 开始绘制
        function startDrawing(e) {
            if (!isDrawMode) return;
            isDrawing = true;
            const canvas = document.getElementById('drawCanvas');
            const rect = canvas.getBoundingClientRect();
            lastX = (e.clientX - rect.left) * (canvas.width / rect.width);
            lastY = (e.clientY - rect.top) * (canvas.height / rect.height);
        }

        // 绘制
        function draw(e) {
            if (!isDrawing || !isDrawMode) return;

            const canvas = document.getElementById('drawCanvas');
            const ctx = canvas.getContext('2d');
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX - rect.left) * (canvas.width / rect.width);
            const y = (e.clientY - rect.top) * (canvas.height / rect.height);

            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(x, y);

            if (drawTool === 'pen') {
                drawColor = document.getElementById('drawColor').value;
                ctx.strokeStyle = drawColor;
                ctx.lineWidth = 3;
                ctx.globalCompositeOperation = 'source-over';
            } else if (drawTool === 'eraser') {
                ctx.lineWidth = 20;
                ctx.globalCompositeOperation = 'destination-out';
            }

            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.stroke();

            lastX = x;
            lastY = y;
        }

        // 停止绘制
        function stopDrawing() {
            isDrawing = false;
        }

        // 清除绘制
        async function clearDrawing() {
            const confirmed = await ConfirmDialog.show({
                title: '清除画笔标记',
                message: '确定要清除当前图片的所有标记吗？\n此操作无法撤销。',
                icon: '🗑️',
                confirmText: '清除',
                cancelText: '取消',
                danger: true
            });

            if (!confirmed) return;

            const canvas = document.getElementById('drawCanvas');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // 删除保存的标记
            if (currentImageKey) {
                delete drawings[currentImageKey];
                saveDrawings();
                Toast.success('已清除当前图片的标记', '清除成功');
            }
        }

        // 保存绘制
        function saveDrawing() {
            const canvas = document.getElementById('drawCanvas');
            if (currentImageKey) {
                drawings[currentImageKey] = canvas.toDataURL();
                saveDrawings();
                Toast.success('标记已成功保存', '保存成功');
            }
        }

        // 加载绘制
        function loadDrawing() {
            if (!currentImageKey || !drawings[currentImageKey]) return;

            const canvas = document.getElementById('drawCanvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            img.onload = function() {
                ctx.drawImage(img, 0, 0);
            };
            img.src = drawings[currentImageKey];
        }

        // 保存标记到localStorage
        function saveDrawings() {
            localStorage.setItem('imageDrawings', JSON.stringify(drawings));
        }

        // 从localStorage加载标记
        function loadDrawings() {
            const saved = localStorage.getItem('imageDrawings');
            if (saved) {
                drawings = JSON.parse(saved);
            }
        }

        // 模态框事件监听
        const imageModal = document.getElementById('imageModal');
        const modalContent = document.getElementById('modalContent');

        // 获取位置（兼容鼠标和触摸）
        function getEventPosition(e) {
            if (e.touches && e.touches.length > 0) {
                return { x: e.touches[0].clientX, y: e.touches[0].clientY };
            }
            return { x: e.clientX, y: e.clientY };
        }

        // 鼠标/触摸按下
        function handleDragStart(e) {
            if (e.target === imageModal || e.target === modalContent || e.target.id === 'modalImage') {
                const pos = getEventPosition(e);
                isDragging = true;
                startX = pos.x - currentX;
                startY = pos.y - currentY;
                imageModal.classList.add('dragging');
            }
        }

        // 鼠标/触摸移动
        function handleDragMove(e) {
            if (isDragging) {
                e.preventDefault();
                const pos = getEventPosition(e);
                currentX = pos.x - startX;
                currentY = pos.y - startY;
                updateTransform();
            }
        }

        // 鼠标/触摸释放
        function handleDragEnd() {
            isDragging = false;
            imageModal.classList.remove('dragging');
        }

        // 鼠标事件
        imageModal.addEventListener('mousedown', handleDragStart);
        imageModal.addEventListener('mousemove', handleDragMove);
        imageModal.addEventListener('mouseup', handleDragEnd);

        // 触摸事件
        imageModal.addEventListener('touchstart', handleDragStart, { passive: true });
        imageModal.addEventListener('touchmove', handleDragMove, { passive: false });
        imageModal.addEventListener('touchend', handleDragEnd);
        imageModal.addEventListener('touchcancel', handleDragEnd);

        // 双指捏合缩放支持
        let initialPinchDistance = 0;
        let initialZoom = 1;

        imageModal.addEventListener('touchstart', (e) => {
            if (e.touches.length === 2) {
                e.preventDefault();
                const touch1 = e.touches[0];
                const touch2 = e.touches[1];
                initialPinchDistance = Math.hypot(
                    touch2.clientX - touch1.clientX,
                    touch2.clientY - touch1.clientY
                );
                initialZoom = currentZoom;
            }
        }, { passive: false });

        imageModal.addEventListener('touchmove', (e) => {
            if (e.touches.length === 2) {
                e.preventDefault();
                const touch1 = e.touches[0];
                const touch2 = e.touches[1];
                const currentDistance = Math.hypot(
                    touch2.clientX - touch1.clientX,
                    touch2.clientY - touch1.clientY
                );
                const scale = currentDistance / initialPinchDistance;
                currentZoom = Math.max(0.25, Math.min(5, initialZoom * scale));
                updateTransform();
            }
        }, { passive: false });

        // 鼠标滚轮缩放
        imageModal.addEventListener('wheel', (e) => {
            e.preventDefault();

            if (e.deltaY < 0) {
                // 向上滚动 - 放大
                currentZoom = Math.min(currentZoom + 0.1, 5);
            } else {
                // 向下滚动 - 缩小
                currentZoom = Math.max(currentZoom - 0.1, 0.25);
            }

            updateTransform();
        }, { passive: false });

        // 双击重置
        imageModal.addEventListener('dblclick', (e) => {
            if (e.target === imageModal || e.target === modalContent || e.target.id === 'modalImage') {
                resetZoom();
            }
        });

        // ESC键关闭
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                // 检查全屏画廊是否打开
                const gallery = document.getElementById('fullscreenGallery');
                if (gallery && gallery.classList.contains('active')) {
                    closeFullscreenGallery();
                } else {
                    closeModal();
                }
            }
            // F键：打开全屏画廊
            if (e.key === 'f' || e.key === 'F') {
                const gallery = document.getElementById('fullscreenGallery');
                if (gallery && !gallery.classList.contains('active')) {
                    openFullscreenGallery();
                }
            }
        });

        // ==================== 快捷键帮助模态框 ====================
        function openHelpModal() {
            const helpModal = document.getElementById('helpModal');
            helpModal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeHelpModal() {
            const helpModal = document.getElementById('helpModal');
            helpModal.classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        // 点击模态框背景关闭
        document.getElementById('helpModal')?.addEventListener('click', (e) => {
            if (e.target.id === 'helpModal') {
                closeHelpModal();
            }
        });

        // ==================== 键盘快捷键 ====================
        // 撤销历史记录
        let ratingHistory = [];
        const MAX_HISTORY = 50;

        // 追踪当前鼠标悬浮的图片卡片
        let currentHoveredCard = null;

        // 监听所有图片卡片的鼠标悬浮
        document.addEventListener('mouseover', (e) => {
            const card = e.target.closest('.image-card');
            if (card) {
                currentHoveredCard = card;
                // 添加视觉反馈
                card.style.outline = '2px solid rgba(139, 92, 246, 0.5)';
            }
        });

        document.addEventListener('mouseout', (e) => {
            const card = e.target.closest('.image-card');
            if (card && card === currentHoveredCard) {
                // 移除视觉反馈
                card.style.outline = '';
            }
        });

        // 全局键盘快捷键处理
        document.addEventListener('keydown', (e) => {
            // 如果在输入框或文本框中，不触发快捷键
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                return;
            }

            const modal = document.getElementById('imageModal');
            const isModalOpen = modal.style.display === 'block';
            const helpModal = document.getElementById('helpModal');
            const isHelpModalOpen = helpModal?.classList.contains('active');

            // ? 或 h 键：打开帮助模态框
            if ((e.key === '?' || e.key === 'h') && !isModalOpen && !isHelpModalOpen) {
                e.preventDefault();
                openHelpModal();
                return;
            }

            // ESC键：关闭帮助模态框
            if (e.key === 'Escape' && isHelpModalOpen) {
                e.preventDefault();
                closeHelpModal();
                return;
            }

            // 空格键：预览第一张图片
            if (e.key === ' ' && !isModalOpen) {
                e.preventDefault();
                const firstImage = document.querySelector('.image-container img');
                if (firstImage) {
                    const imageUrl = firstImage.src;
                    const card = firstImage.closest('.image-card');
                    const onclickAttr = card?.querySelector('.image-container').getAttribute('onclick');
                    // 提取imageKey
                    const match = onclickAttr?.match(/'([^']+_\d+)'/);
                    const imageKey = match ? match[1] : '';
                    openModal(imageUrl, imageKey);
                }
                return;
            }

            // 模态框打开时只响应ESC（已在上面处理）
            if (isModalOpen) {
                return;
            }

            // 左右箭头键翻页
            if (e.key === 'ArrowLeft') {
                e.preventDefault();
                prevPage();
            } else if (e.key === 'ArrowRight') {
                e.preventDefault();
                nextPage();
            }

            // 数字键0：取消当前页面所有图片评分
            if (e.key === '0') {
                e.preventDefault();
                const attitudeBars = document.querySelectorAll('.attitude-bar');
                let canceledCount = 0;

                attitudeBars.forEach(bar => {
                    const buttons = bar.querySelectorAll('.attitude-btn');
                    const activeButton = Array.from(buttons).find(btn => btn.classList.contains('active'));

                    if (activeButton) {
                        // 记录撤销历史
                        const onclickAttr = activeButton.getAttribute('onclick');
                        const imageKeyMatch = onclickAttr?.match(/'([^']+)'/);
                        const ratingMatch = onclickAttr?.match(/'(like|neutral|dislike)'/);
                        const folderMatch = onclickAttr?.match(/'([^']*)'[^']*$/);

                        if (imageKeyMatch && ratingMatch) {
                            ratingHistory.push({
                                imageKey: imageKeyMatch[1],
                                rating: ratingMatch[1],
                                folderName: folderMatch ? folderMatch[1] : '',
                                timestamp: Date.now()
                            });
                            if (ratingHistory.length > MAX_HISTORY) {
                                ratingHistory.shift();
                            }
                        }

                        // 点击已选中的按钮以取消评分
                        activeButton.click();
                        canceledCount++;
                    }
                });

                if (canceledCount > 0) {
                    Toast.info(`已取消 ${canceledCount} 张图片的评分`, '取消评分');
                } else {
                    Toast.info('当前页面没有已评分的图片', '提示');
                }
            }

            // 数字键1/2/3快速打分鼠标悬浮的图片
            if (e.key === '1' || e.key === '2' || e.key === '3') {
                e.preventDefault();
                const ratingMap = {
                    '1': 'like',
                    '2': 'neutral',
                    '3': 'dislike'
                };
                const rating = ratingMap[e.key];

                // 如果有悬浮的卡片，只对该卡片打分
                if (currentHoveredCard) {
                    const bar = currentHoveredCard.querySelector('.attitude-bar');
                    if (bar) {
                        const buttons = bar.querySelectorAll('.attitude-btn');

                        // 先记录当前状态用于撤销
                        const activeButton = Array.from(buttons).find(btn => btn.classList.contains('active'));
                        if (activeButton) {
                            const onclickAttr = activeButton.getAttribute('onclick');
                            const imageKeyMatch = onclickAttr?.match(/'([^']+)'/);
                            const ratingMatch = onclickAttr?.match(/'(like|neutral|dislike)'/);
                            const folderMatch = onclickAttr?.match(/'([^']*)'[^']*$/);

                            if (imageKeyMatch && ratingMatch) {
                                ratingHistory.push({
                                    imageKey: imageKeyMatch[1],
                                    rating: ratingMatch[1],
                                    folderName: folderMatch ? folderMatch[1] : '',
                                    timestamp: Date.now()
                                });
                                if (ratingHistory.length > MAX_HISTORY) {
                                    ratingHistory.shift();
                                }
                            }
                        }

                        // 找到对应评分的按钮并点击
                        buttons.forEach(button => {
                            const onclickAttr = button.getAttribute('onclick');
                            if (onclickAttr && onclickAttr.includes(`'${rating}'`)) {
                                button.click();
                            }
                        });

                        // 显示简洁提示
                        const ratingText = {
                            'like': '👍',
                            'neutral': '😐',
                            'dislike': '👎'
                        };

                        // 创建临时视觉反馈
                        const feedback = document.createElement('div');
                        feedback.textContent = ratingText[rating];
                        feedback.style.cssText = `
                            position: fixed;
                            top: 50%;
                            left: 50%;
                            transform: translate(-50%, -50%);
                            font-size: 4rem;
                            z-index: 10000;
                            pointer-events: none;
                            animation: quickFeedback 0.6s ease-out;
                        `;
                        document.body.appendChild(feedback);
                        setTimeout(() => feedback.remove(), 600);
                    }
                } else {
                    // 没有悬浮的卡片时，提示用户
                    Toast.info('请先将鼠标悬浮在要打分的图片上', '提示');
                }
            }

            // Cmd+Z (Mac) 或 Ctrl+Z (Windows/Linux) 撤销评分
            if ((e.metaKey || e.ctrlKey) && e.key === 'z') {
                e.preventDefault();

                if (ratingHistory.length === 0) {
                    Toast.info('没有可撤销的操作', '提示');
                    return;
                }

                // 获取最近的操作
                const lastAction = ratingHistory.pop();

                // 恢复之前的评分
                const { imageKey, rating, folderName } = lastAction;

                // 找到对应的按钮并恢复评分
                const attitudeBars = document.querySelectorAll('.attitude-bar');
                let restored = false;

                attitudeBars.forEach(bar => {
                    const buttons = bar.querySelectorAll('.attitude-btn');
                    buttons.forEach(button => {
                        const onclickAttr = button.getAttribute('onclick');
                        if (onclickAttr &&
                            onclickAttr.includes(`'${imageKey}'`) &&
                            onclickAttr.includes(`'${rating}'`)) {
                            button.click();
                            restored = true;
                        }
                    });
                });

                if (restored) {
                    Toast.success('已撤销上一次操作', '撤销成功');
                } else {
                    Toast.info('无法找到对应的图片，可能不在当前页面', '提示');
                }
            }
        });

        // 点击背景关闭（仅点击模态框背景，不包括图片）
        imageModal.addEventListener('click', (e) => {
            if (e.target === imageModal) {
                closeModal();
            }
        });

        // ==================== 预览悬浮功能 ====================

        let previewTimeout = null;
        let imageCache = {}; // 缓存图片 URL（向后兼容）
        let thumbnailCache = {}; // 缩略图缓存
        let fullImageCache = {}; // 原始大图缓存

        // ==================== 内存管理 ====================

        // 清理不在当前页的图片缓存，释放内存
        function cleanupOldImages() {
            const currentPageKeys = new Set();

            // 收集当前页面显示的图片key
            if (folders.length === 1) {
                // 单文件夹模式
                const start = currentPage * imagesPerPage;
                const end = Math.min(start + imagesPerPage, allImages.length);
                for (let i = start; i < end; i++) {
                    const file = allImages[i];
                    currentPageKeys.add(`${file.name}_${file.size}`);
                }
            } else {
                // 多文件夹模式
                const start = currentPage * imagesPerPage;
                const end = Math.min(start + imagesPerPage, maxImages);
                for (let i = start; i < end; i++) {
                    folders.forEach(folder => {
                        if (folder.images[i]) {
                            const file = folder.images[i];
                            currentPageKeys.add(`${file.name}_${file.size}`);
                        }
                    });
                }
            }

            // 释放不在当前页的ObjectURL
            let cleanedCount = 0;

            // 清理 imageCache
            for (const key in imageCache) {
                if (!currentPageKeys.has(key)) {
                    const url = imageCache[key];
                    if (url && typeof url === 'string' && url.startsWith('blob:')) {
                        URL.revokeObjectURL(url);
                        cleanedCount++;
                    }
                    delete imageCache[key];
                }
            }

            // 清理 thumbnailCache
            for (const key in thumbnailCache) {
                if (!currentPageKeys.has(key)) {
                    const url = thumbnailCache[key];
                    if (url && typeof url === 'string' && url.startsWith('blob:')) {
                        URL.revokeObjectURL(url);
                        cleanedCount++;
                    }
                    delete thumbnailCache[key];
                }
            }

            // 清理 fullImageCache
            for (const key in fullImageCache) {
                if (!currentPageKeys.has(key)) {
                    const url = fullImageCache[key];
                    if (url && typeof url === 'string' && url.startsWith('blob:')) {
                        URL.revokeObjectURL(url);
                        cleanedCount++;
                    }
                    delete fullImageCache[key];
                }
            }

            if (cleanedCount > 0) {
                console.log(`✓ 已释放 ${cleanedCount} 个图片对象，节省内存`);
            }
        }

        // 清理所有缓存
        function cleanupAllImages() {
            let cleanedCount = 0;

            // 清理所有ObjectURL
            for (const key in imageCache) {
                const url = imageCache[key];
                if (url && typeof url === 'string' && url.startsWith('blob:')) {
                    URL.revokeObjectURL(url);
                    cleanedCount++;
                }
            }

            for (const key in thumbnailCache) {
                const url = thumbnailCache[key];
                if (url && typeof url === 'string' && url.startsWith('blob:')) {
                    URL.revokeObjectURL(url);
                    cleanedCount++;
                }
            }

            for (const key in fullImageCache) {
                const url = fullImageCache[key];
                if (url && typeof url === 'string' && url.startsWith('blob:')) {
                    URL.revokeObjectURL(url);
                    cleanedCount++;
                }
            }

            // 清空缓存对象
            imageCache = {};
            thumbnailCache = {};
            fullImageCache = {};

            if (cleanedCount > 0) {
                console.log(`✓ 已清空所有缓存，释放 ${cleanedCount} 个图片对象`);
            }
        }

        // 显示预览
        function showPreview(event, ratingType) {
            // 清除之前的延迟隐藏
            if (previewTimeout) {
                clearTimeout(previewTimeout);
                previewTimeout = null;
            }

            const tooltip = document.getElementById('previewTooltip');
            const title = document.getElementById('previewTitle');
            const grid = document.getElementById('previewGrid');

            // 根据评分类型筛选图片
            const filteredImages = allImages.filter(file => {
                const imageKey = `${file.name}_${file.size}`;
                const folderName = file.folderName || '';

                // 获取评分（根据评分模式）
                let rating = null;
                if (ratings[imageKey]) {
                    if (ratingMode === 'single') {
                        // 单一评分模式：使用主文件夹的评分
                        const targetFolderIndex = mainFolderIndex !== -1 ? mainFolderIndex : 0;
                        const targetFolderName = folders[targetFolderIndex] ? folders[targetFolderIndex].name : '';
                        rating = ratings[imageKey][targetFolderName];
                    } else {
                        // 多维评分模式：使用当前文件夹的评分
                        rating = ratings[imageKey][folderName];
                    }
                }

                if (ratingType === 'unrated') {
                    return !rating;
                } else {
                    return rating === ratingType;
                }
            });

            // 设置标题
            const titles = {
                'like': '👍 喜欢的图片',
                'neutral': '😐 一般的图片',
                'dislike': '👎 不喜欢的图片',
                'unrated': '⭕ 未评分的图片'
            };
            title.textContent = titles[ratingType];

            // 清空网格
            grid.innerHTML = '';

            if (filteredImages.length === 0) {
                grid.innerHTML = '<div class="preview-empty">暂无图片</div>';
            } else {
                // 显示图片（最多显示前20张）
                const displayImages = filteredImages.slice(0, 20);

                displayImages.forEach(async (file) => {
                    const imageKey = `${file.name}_${file.size}`;

                    // 检查是否是RAW文件
                    if (isRawFile(file)) {
                        // 检查缓存
                        if (imageCache[imageKey]) {
                            addPreviewImage(grid, imageCache[imageKey], file.name);
                        } else {
                            // 尝试提取RAW预览
                            const previewUrl = await extractRawPreview(file);
                            if (previewUrl) {
                                imageCache[imageKey] = previewUrl;
                                addPreviewImage(grid, previewUrl, file.name);
                            } else {
                                // 无法提取，显示图标
                                const ext = file.name.split('.').pop().toUpperCase();
                                const item = document.createElement('div');
                                item.className = 'preview-image-item';
                                item.innerHTML = `
                                    <div style="width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-card) 100%);">
                                        <div style="font-size: 2rem; opacity: 0.6;">📷</div>
                                        <div style="font-size: 0.7rem; color: var(--primary-purple); margin-top: 4px;">${ext}</div>
                                    </div>
                                    <div class="preview-image-name">${file.name}</div>
                                `;
                                grid.appendChild(item);
                            }
                        }
                    } else {
                        // 普通图片
                        if (imageCache[imageKey]) {
                            // 使用缓存的图片
                            addPreviewImage(grid, imageCache[imageKey], file.name);
                        } else {
                            // 读取图片
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                imageCache[imageKey] = e.target.result;
                                addPreviewImage(grid, e.target.result, file.name);
                            };
                            reader.onerror = (e) => {
                                console.error(`统计预览加载失败: ${file.name}`, e);
                            };
                            reader.readAsDataURL(file);
                        }
                    }
                });

                // 如果图片总数超过20张，显示提示
                if (filteredImages.length > 20) {
                    const moreInfo = document.createElement('div');
                    moreInfo.className = 'preview-empty';
                    moreInfo.style.padding = '20px';
                    moreInfo.textContent = `还有 ${filteredImages.length - 20} 张图片未显示`;
                    grid.appendChild(moreInfo);
                }
            }

            // 定位工具提示框
            const rect = event.currentTarget.getBoundingClientRect();
            const tooltipWidth = 600;
            const tooltipHeight = 500;

            let left = rect.left + rect.width / 2 - tooltipWidth / 2;
            let top = rect.bottom + 10;

            // 确保不超出屏幕
            if (left < 10) left = 10;
            if (left + tooltipWidth > window.innerWidth - 10) {
                left = window.innerWidth - tooltipWidth - 10;
            }
            if (top + tooltipHeight > window.innerHeight - 10) {
                top = rect.top - tooltipHeight - 10;
            }

            tooltip.style.left = `${left}px`;
            tooltip.style.top = `${top}px`;
            tooltip.classList.add('active');
        }

        // 添加预览图片到网格
        function addPreviewImage(grid, imageUrl, fileName) {
            const item = document.createElement('div');
            item.className = 'preview-image-item';
            item.innerHTML = `
                <img src="${imageUrl}" alt="${fileName}">
                <div class="preview-image-name">${fileName}</div>
            `;
            grid.appendChild(item);
        }

        // 隐藏预览
        function hidePreview() {
            // 延迟隐藏，以便鼠标移动到工具提示框时不会立即关闭
            previewTimeout = setTimeout(() => {
                const tooltip = document.getElementById('previewTooltip');
                tooltip.classList.remove('active');
            }, 200);
        }

        // 鼠标移入工具提示框时保持显示
        const previewTooltip = document.getElementById('previewTooltip');
        previewTooltip.addEventListener('mouseenter', () => {
            if (previewTimeout) {
                clearTimeout(previewTimeout);
                previewTimeout = null;
            }
        });

        // 鼠标移出工具提示框时隐藏
        previewTooltip.addEventListener('mouseleave', () => {
            hidePreview();
        });

        // ==================== 对比功能 ====================

        // 切换对比选择
        async function toggleCompareSelection(imageKey, checked) {
            if (checked) {
                compareSelection.add(imageKey);
                // 查找对应的文件对象
                const file = allImages.find(f => `${f.name}_${f.size}` === imageKey);
                if (file) {
                    // 检查是否已经存在
                    if (!compareImages.some(img => `${img.file.name}_${img.file.size}` === imageKey)) {
                        // 获取图片URL
                        if (isRawFile(file)) {
                            // 检查缓存
                            if (imageCache[imageKey]) {
                                compareImages.push({
                                    file: file,
                                    imageUrl: imageCache[imageKey],
                                    isRaw: false,
                                    folderName: file.folderName
                                });
                            } else {
                                // 尝试提取RAW预览
                                const previewUrl = await extractRawPreview(file);
                                if (previewUrl) {
                                    imageCache[imageKey] = previewUrl;
                                    compareImages.push({
                                        file: file,
                                        imageUrl: previewUrl,
                                        isRaw: false,
                                        folderName: file.folderName
                                    });
                                } else {
                                    // 无法提取预览，标记为RAW
                                    compareImages.push({
                                        file: file,
                                        imageUrl: null,
                                        isRaw: true,
                                        folderName: file.folderName
                                    });
                                }
                            }
                        } else {
                            // 优先使用原始大图，其次使用缩略图
                            const imageUrl = fullImageCache[imageKey] || thumbnailCache[imageKey] || imageCache[imageKey];
                            if (imageUrl) {
                                compareImages.push({
                                    file: file,
                                    imageUrl: imageUrl,
                                    isRaw: false,
                                    folderName: file.folderName
                                });
                            } else {
                                const reader = new FileReader();
                                reader.onload = async (e) => {
                                    const fullImageUrl = e.target.result;

                                    // 检查文件大小
                                    const isLargeFile = file.size > 20 * 1024 * 1024;

                                    if (!isLargeFile) {
                                        fullImageCache[imageKey] = fullImageUrl;
                                    }

                                    // 生成缩略图
                                    const thumbnailUrl = await generateThumbnail(fullImageUrl);
                                    thumbnailCache[imageKey] = thumbnailUrl;
                                    imageCache[imageKey] = thumbnailUrl;

                                    compareImages.push({
                                        file: file,
                                        imageUrl: fullImageCache[imageKey] || thumbnailUrl,
                                        isRaw: false,
                                        folderName: file.folderName
                                    });
                                };
                                reader.readAsDataURL(file);
                            }
                        }
                    }
                }
            } else {
                compareSelection.delete(imageKey);
                compareImages = compareImages.filter(img => `${img.file.name}_${img.file.size}` !== imageKey);
            }

            updateCompareBar();
        }

        // 更新对比栏
        function updateCompareBar() {
            const compareBar = document.getElementById('compareBar');
            const compareCount = document.getElementById('compareCount');
            const compareButton = document.getElementById('compareButton');

            compareCount.textContent = compareSelection.size;

            if (compareSelection.size > 0) {
                compareBar.classList.add('active');
                compareButton.disabled = compareSelection.size < 2;
            } else {
                compareBar.classList.remove('active');
                compareButton.disabled = true;
            }
        }

        // 清除对比选择
        function clearCompareSelection() {
            compareSelection.clear();
            compareImages = [];
            updateCompareBar();

            // 取消所有复选框
            document.querySelectorAll('.compare-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
        }

        // 多文件夹模式：直接打开对比（不需要勾选）
        async function openDirectCompare() {
            // 清空现有选择
            compareImages = [];
            compareSelection.clear();

            // 获取当前页面显示的图片名称
            const allImageNames = new Set();
            folders.forEach(folder => {
                folder.images.forEach(img => {
                    allImageNames.add(img.name);
                });
            });
            const sortedImageNames = Array.from(allImageNames).sort();
            const start = currentPage * imagesPerPage;
            const end = start + imagesPerPage;
            const currentPageNames = sortedImageNames.slice(start, end);

            // 获取当前显示的第一组图片名称（Space预览第一张）
            const currentImageName = currentPageNames[0];
            if (!currentImageName) return;

            // 收集所有文件夹中该名称的图片
            for (const folder of folders) {
                const file = folder.images.find(img => img.name === currentImageName);
                if (file) {
                    const imageKey = `${file.name}_${file.size}`;

                    // 添加到选择集合
                    compareSelection.add(imageKey);

                    // 检查是否是RAW文件
                    if (isRawFile(file)) {
                        // 检查缓存
                        if (imageCache[imageKey]) {
                            compareImages.push({
                                file: file,
                                imageUrl: imageCache[imageKey],
                                isRaw: false,
                                folderName: folder.name
                            });
                        } else {
                            // 尝试提取RAW预览
                            const previewUrl = await extractRawPreview(file);
                            if (previewUrl) {
                                imageCache[imageKey] = previewUrl;
                                compareImages.push({
                                    file: file,
                                    imageUrl: previewUrl,
                                    isRaw: false,
                                    folderName: folder.name
                                });
                            } else {
                                // 无法提取预览
                                compareImages.push({
                                    file: file,
                                    imageUrl: null,
                                    isRaw: true,
                                    folderName: folder.name
                                });
                            }
                        }
                    } else {
                        // 从缓存获取图片URL（优先使用原始大图）
                        const imageUrl = fullImageCache[imageKey] || imageCache[imageKey];
                        if (imageUrl) {
                            compareImages.push({
                                file: file,
                                imageUrl: imageUrl,
                                isRaw: false,
                                folderName: folder.name  // 添加文件夹名称
                            });
                        }
                    }
                }
            }

            // 如果有图片，打开对比模态框
            if (compareImages.length > 0) {
                openCompareModal();
            }
        }

        // 打开对比模态框
        function openCompareModal() {

            const modal = document.getElementById('compareModal');
            const content = document.getElementById('compareContent');

            // 重置缩放模式
            compareZoomMode = 'sync';
            compareFocusedImage = null;
            updateCompareModeIndicator();

            // 清空内容
            content.innerHTML = '';

            // 设置网格列数
            const count = compareImages.length;
            if (count === 2) {
                content.className = 'compare-content cols-2';
            } else if (count === 3) {
                content.className = 'compare-content cols-3';
            } else {
                content.className = 'compare-content cols-4';
            }

            // 为每张图片创建独立的容器
            compareImages.forEach((img, index) => {
                const imageKey = `${img.file.name}_${img.file.size}`;

                // 初始化缩放状态
                if (!compareStates[imageKey]) {
                    compareStates[imageKey] = {
                        zoom: 1,
                        x: 0,
                        y: 0
                    };
                }

                const wrapper = document.createElement('div');
                wrapper.className = 'compare-image-wrapper';
                wrapper.dataset.imageKey = imageKey;
                wrapper.tabIndex = 0; // 使元素可聚焦

                // 文件夹名称标签（如果有的话）
                const folderTag = img.folderName ? `
                    <div class="compare-folder-tag">${img.folderName}</div>
                ` : '';

                if (img.isRaw) {
                    const ext = img.file.name.split('.').pop().toUpperCase();
                    wrapper.innerHTML = `
                        ${folderTag}
                        <div class="compare-zoom-info">${Math.round(compareStates[imageKey].zoom * 100)}%</div>
                        <div class="compare-image-controls">
                            <button class="compare-control-btn" onclick="compareZoomIn('${imageKey}')">+</button>
                            <button class="compare-control-btn" onclick="compareZoomOut('${imageKey}')">−</button>
                            <button class="compare-control-btn" onclick="compareResetZoom('${imageKey}')">↺</button>
                        </div>
                        <div class="compare-image-container">
                            <div style="display: flex; flex-direction: column; align-items: center; justify-content: center;">
                                <div style="font-size: 5rem; opacity: 0.6;">📷</div>
                                <div style="font-size: 1.5rem; color: var(--primary-purple); margin-top: 12px;">${ext} 格式</div>
                                <div style="font-size: 1rem; color: var(--text-muted); margin-top: 8px;">RAW 文件</div>
                            </div>
                        </div>
                        <div class="compare-image-name">${img.file.name}</div>
                    `;
                } else {
                    wrapper.innerHTML = `
                        ${folderTag}
                        <div class="compare-zoom-info">${Math.round(compareStates[imageKey].zoom * 100)}%</div>
                        <div class="compare-image-controls">
                            <button class="compare-control-btn" onclick="compareZoomIn('${imageKey}')">+</button>
                            <button class="compare-control-btn" onclick="compareZoomOut('${imageKey}')">−</button>
                            <button class="compare-control-btn" onclick="compareResetZoom('${imageKey}')">↺</button>
                            <button class="compare-control-btn" onclick="event.stopPropagation(); openModalForDrawing('${img.imageUrl}', '${imageKey}')" title="标记细节">✏️</button>
                        </div>
                        <div class="compare-image-container">
                            <img src="${img.imageUrl}" alt="${img.file.name}">
                        </div>
                        <div class="compare-image-name">${img.file.name}</div>
                    `;
                }

                content.appendChild(wrapper);

                // 应用初始变换
                updateCompareTransform(imageKey);

                // 添加拖拽事件
                setupCompareDrag(wrapper, imageKey);

                // 添加悬停事件监听（仅用于独立模式下的聚焦高亮）
                wrapper.addEventListener('mouseenter', () => {
                    // 只有在独立模式下才设置聚焦图片
                    if (compareZoomMode === 'individual') {
                        compareFocusedImage = imageKey;
                        // 添加聚焦样式
                        document.querySelectorAll('.compare-image-wrapper').forEach(w => {
                            w.classList.remove('focused');
                        });
                        wrapper.classList.add('focused');
                    }
                });

                wrapper.addEventListener('mouseleave', () => {
                    // 独立模式下，如果是当前聚焦的图片且没有按住Ctrl/Cmd，清除聚焦
                    if (compareZoomMode === 'individual' && compareFocusedImage === imageKey && !isCtrlCmdPressed) {
                        setTimeout(() => {
                            // 检查鼠标是否还在其他图片上
                            const hoveredWrapper = document.querySelector('.compare-image-wrapper:hover');
                            if (!hoveredWrapper && !isCtrlCmdPressed) {
                                compareFocusedImage = null;
                                // 移除所有聚焦样式
                                document.querySelectorAll('.compare-image-wrapper').forEach(w => {
                                    w.classList.remove('focused');
                                });
                            }
                        }, 100);
                    }
                });

                // 添加滚轮缩放
                wrapper.addEventListener('wheel', (e) => {
                    e.preventDefault();
                    e.stopPropagation();

                    const zoomDelta = e.deltaY < 0 ? 0.1 : -0.1;

                    if (compareZoomMode === 'sync') {
                        // 同步模式：所有图片一起缩放
                        compareImages.forEach(img => {
                            const key = `${img.file.name}_${img.file.size}`;
                            const state = compareStates[key];
                            state.zoom = Math.max(0.25, Math.min(5, state.zoom + zoomDelta));
                            updateCompareTransform(key);
                        });
                    } else {
                        // 独立模式：只缩放聚焦的图片
                        const state = compareStates[imageKey];
                        state.zoom = Math.max(0.25, Math.min(5, state.zoom + zoomDelta));
                        updateCompareTransform(imageKey);
                    }
                }, { passive: false });
            });

            modal.classList.add('active');
            document.body.style.overflow = 'hidden';

            // 移除旧的事件监听器（如果存在）
            if (compareContentWheelHandler) {
                content.removeEventListener('wheel', compareContentWheelHandler);
            }

            // 在整个content区域添加滚轮事件监听，确保打开后立即可用
            compareContentWheelHandler = (e) => {
                e.preventDefault();
                const zoomDelta = e.deltaY < 0 ? 0.1 : -0.1;

                // 同步模式：所有图片一起缩放
                compareImages.forEach(img => {
                    const key = `${img.file.name}_${img.file.size}`;
                    const state = compareStates[key];
                    if (state) {
                        state.zoom = Math.max(0.25, Math.min(5, state.zoom + zoomDelta));
                        updateCompareTransform(key);
                    }
                });
            };
            content.addEventListener('wheel', compareContentWheelHandler, { passive: false });

            // 双指捏合缩放支持（移动设备）
            let comparePinchDistance = 0;
            let compareInitialZooms = {};

            content.addEventListener('touchstart', (e) => {
                if (e.touches.length === 2) {
                    e.preventDefault();
                    const touch1 = e.touches[0];
                    const touch2 = e.touches[1];
                    comparePinchDistance = Math.hypot(
                        touch2.clientX - touch1.clientX,
                        touch2.clientY - touch1.clientY
                    );
                    // 保存所有图片的当前缩放值
                    compareImages.forEach(img => {
                        const key = `${img.file.name}_${img.file.size}`;
                        compareInitialZooms[key] = compareStates[key].zoom;
                    });
                }
            }, { passive: false });

            content.addEventListener('touchmove', (e) => {
                if (e.touches.length === 2) {
                    e.preventDefault();
                    const touch1 = e.touches[0];
                    const touch2 = e.touches[1];
                    const currentDistance = Math.hypot(
                        touch2.clientX - touch1.clientX,
                        touch2.clientY - touch1.clientY
                    );
                    const scale = currentDistance / comparePinchDistance;

                    // 同步模式：所有图片一起缩放
                    compareImages.forEach(img => {
                        const key = `${img.file.name}_${img.file.size}`;
                        const state = compareStates[key];
                        if (state && compareInitialZooms[key]) {
                            state.zoom = Math.max(0.25, Math.min(5, compareInitialZooms[key] * scale));
                            updateCompareTransform(key);
                        }
                    });
                }
            }, { passive: false });
        }

        // 关闭对比模态框
        function closeCompareModal() {
            const modal = document.getElementById('compareModal');
            const content = document.getElementById('compareContent');

            modal.classList.remove('active');
            document.body.style.overflow = 'auto';

            // 移除content区域的滚轮事件监听器
            if (compareContentWheelHandler) {
                content.removeEventListener('wheel', compareContentWheelHandler);
                compareContentWheelHandler = null;
            }

            // 清除悬停计时器
            if (compareHoverTimer) {
                clearTimeout(compareHoverTimer);
                compareHoverTimer = null;
            }

            // 重置模式
            compareZoomMode = 'sync';
            compareFocusedImage = null;
            manualIndividualMode = false;
            isCtrlCmdPressed = false;

            // 重置Q键相关状态
            isQKeyPressed = false;
            originalCompareImages = null;
            originalFoldersOrder = null;
        }

        // ==================== 全屏画廊功能 ====================

        // 为画廊创建优化的缩略图（Blob URL，更省内存）
        async function createGalleryThumbnail(dataUrl, maxSize = 600) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => {
                    // 计算缩放比例
                    let width = img.width;
                    let height = img.height;

                    if (width > maxSize || height > maxSize) {
                        const ratio = Math.min(maxSize / width, maxSize / height);
                        width = Math.floor(width * ratio);
                        height = Math.floor(height * ratio);
                    }

                    // 创建canvas并缩放
                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    // 转换为Blob URL（比Data URL省内存）
                    canvas.toBlob((blob) => {
                        if (blob) {
                            const blobUrl = URL.createObjectURL(blob);
                            resolve(blobUrl);
                        } else {
                            reject(new Error('Failed to create blob'));
                        }
                    }, 'image/jpeg', 0.85);
                };
                img.onerror = () => reject(new Error('Failed to load image'));
                img.src = dataUrl;
            });
        }

        // 打开全屏画廊（优化版：使用Blob URL避免内存溢出）
        async function openFullscreenGallery() {
            const gallery = document.getElementById('fullscreenGallery');
            const container = document.getElementById('galleryContainer');

            // 获取当前页的所有图片
            const currentImages = getCurrentPageImages();

            if (currentImages.length === 0) {
                Toast.warning('当前页没有图片', '提示');
                return;
            }

            // 先显示画廊和加载提示
            gallery.classList.add('active');
            document.body.style.overflow = 'hidden';
            container.innerHTML = '<div style="color: var(--text-muted); text-align: center; padding: 100px 20px; font-size: 1.2rem;">⏳ 正在加载图片...</div>';

            Toast.info('正在优化图片，请稍候...', '加载中');

            // 异步处理图片
            try {
                // 为所有图片创建优化的Blob URL
                const optimizedImages = await Promise.all(
                    currentImages.map(async (imgData) => {
                        try {
                            // 创建优化的缩略图Blob URL
                            const blobUrl = await createGalleryThumbnail(imgData.url, 600);
                            return {
                                name: imgData.name,
                                url: blobUrl,
                                success: true
                            };
                        } catch (error) {
                            console.error(`Failed to create thumbnail for ${imgData.name}:`, error);
                            return {
                                name: imgData.name,
                                url: null,
                                success: false
                            };
                        }
                    })
                );

                // 清空容器并渲染优化后的图片
                container.innerHTML = '';

                optimizedImages.forEach((imgData, index) => {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'gallery-image-wrapper';

                    const imgContainer = document.createElement('div');
                    imgContainer.className = 'gallery-image-container';

                    if (imgData.success && imgData.url) {
                        const img = document.createElement('img');
                        img.src = imgData.url;
                        img.alt = imgData.name;
                        img.style.cssText = 'max-width: 100%; max-height: 100%; object-fit: contain;';

                        // 图片加载完成后释放之前的Blob URL（如果需要）
                        img.onload = () => {
                            // Blob URL在这里已经被使用，可以保留直到关闭画廊
                        };

                        imgContainer.appendChild(img);
                    } else {
                        // 加载失败时显示占位符
                        imgContainer.style.cssText = 'background: var(--bg-secondary); display: flex; align-items: center; justify-content: center; font-size: 2rem; color: var(--text-muted);';
                        imgContainer.textContent = '❌ 加载失败';
                    }

                    const nameDiv = document.createElement('div');
                    nameDiv.className = 'gallery-image-name';
                    nameDiv.textContent = imgData.name;

                    wrapper.appendChild(imgContainer);
                    wrapper.appendChild(nameDiv);
                    container.appendChild(wrapper);
                });

                Toast.success('使用滚轮缩放，ESC 关闭', '全屏画廊');
            } catch (error) {
                console.error('Failed to open fullscreen gallery:', error);
                container.innerHTML = '<div style="color: var(--error); text-align: center; padding: 100px 20px; font-size: 1.2rem;">❌ 加载失败，请重试</div>';
                Toast.error('加载图片失败', '错误');
            }
        }

        // 关闭全屏画廊
        function closeFullscreenGallery() {
            const gallery = document.getElementById('fullscreenGallery');
            const container = document.getElementById('galleryContainer');

            // 释放所有Blob URL以防止内存泄漏
            const images = container.querySelectorAll('img');
            images.forEach(img => {
                if (img.src && img.src.startsWith('blob:')) {
                    URL.revokeObjectURL(img.src);
                }
            });

            // 清空容器并关闭画廊
            container.innerHTML = '';
            gallery.classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        // 获取当前页的所有图片
        function getCurrentPageImages() {
            const images = [];

            if (folders.length === 1) {
                // 单文件夹模式
                const start = currentPage * imagesPerPage;
                const end = start + imagesPerPage;
                const currentImages = allImages.slice(start, end);

                currentImages.forEach(file => {
                    const imageKey = `${file.name}_${file.size}`;
                    const url = imageCache[imageKey] || thumbnailCache[imageKey];
                    if (url) {
                        images.push({
                            name: file.name,
                            url: url
                        });
                    }
                });
            } else {
                // 多文件夹模式：按位置对比
                const sortedFolders = folders.map(folder => {
                    return {
                        ...folder,
                        sortedImages: [...folder.images].sort((a, b) => {
                            return a.name.localeCompare(b.name, undefined, { numeric: true, sensitivity: 'base' });
                        })
                    };
                });

                const maxImageCount = Math.max(...sortedFolders.map(f => f.sortedImages.length));
                const start = currentPage * imagesPerPage;
                const end = Math.min(start + imagesPerPage, maxImageCount);

                for (let i = start; i < end; i++) {
                    sortedFolders.forEach((folder, folderIndex) => {
                        const file = folder.sortedImages[i];
                        if (file) {
                            const imageKey = `${file.name}_${file.size}`;
                            const url = imageCache[imageKey] || thumbnailCache[imageKey];
                            if (url) {
                                images.push({
                                    name: `${folder.name} - ${file.name}`,
                                    url: url
                                });
                            }
                        }
                    });
                }
            }

            return images;
        }

        // 对比图片放大
        function compareZoomIn(imageKey) {
            if (compareZoomMode === 'sync') {
                // 同步模式：所有图片一起放大
                compareImages.forEach(img => {
                    const key = `${img.file.name}_${img.file.size}`;
                    const state = compareStates[key];
                    state.zoom = Math.min(state.zoom + 0.25, 5);
                    updateCompareTransform(key);
                });
            } else {
                // 独立模式：只放大指定图片
                const state = compareStates[imageKey];
                state.zoom = Math.min(state.zoom + 0.25, 5);
                updateCompareTransform(imageKey);
            }
        }

        // 对比图片缩小
        function compareZoomOut(imageKey) {
            if (compareZoomMode === 'sync') {
                // 同步模式：所有图片一起缩小
                compareImages.forEach(img => {
                    const key = `${img.file.name}_${img.file.size}`;
                    const state = compareStates[key];
                    state.zoom = Math.max(state.zoom - 0.25, 0.25);
                    updateCompareTransform(key);
                });
            } else {
                // 独立模式：只缩小指定图片
                const state = compareStates[imageKey];
                state.zoom = Math.max(state.zoom - 0.25, 0.25);
                updateCompareTransform(imageKey);
            }
        }

        // 对比图片重置缩放
        function compareResetZoom(imageKey) {
            if (compareZoomMode === 'sync') {
                // 同步模式：重置所有图片
                compareImages.forEach(img => {
                    const key = `${img.file.name}_${img.file.size}`;
                    const state = compareStates[key];
                    state.zoom = 1;
                    state.x = 0;
                    state.y = 0;
                    updateCompareTransform(key);
                });
            } else {
                // 独立模式：只重置指定图片
                const state = compareStates[imageKey];
                state.zoom = 1;
                state.x = 0;
                state.y = 0;
                updateCompareTransform(imageKey);
            }
        }

        // 更新缩放模式指示器
        function updateCompareModeIndicator() {
            const indicator = document.getElementById('compareModeIndicator');
            const modeText = document.getElementById('compareModeText');
            const modeIcon = indicator.querySelector('.compare-mode-icon');

            if (compareZoomMode === 'sync') {
                indicator.className = 'compare-mode-indicator sync-mode';
                indicator.style.cursor = 'pointer';
                modeIcon.textContent = '🔗';
                modeText.textContent = '同步缩放模式';
            } else {
                indicator.className = 'compare-mode-indicator individual-mode';
                indicator.style.cursor = 'pointer';
                modeIcon.textContent = '🎯';
                modeText.textContent = '独立缩放模式';
            }
        }

        // 切换对比缩放模式
        function toggleCompareZoomMode() {
            if (compareZoomMode === 'sync') {
                compareZoomMode = 'individual';
                manualIndividualMode = true;
                // 移除所有聚焦样式
                document.querySelectorAll('.compare-image-wrapper').forEach(w => {
                    w.classList.remove('focused');
                });
            } else {
                compareZoomMode = 'sync';
                manualIndividualMode = false;
                compareFocusedImage = null;
                // 移除所有聚焦样式
                document.querySelectorAll('.compare-image-wrapper').forEach(w => {
                    w.classList.remove('focused');
                });
            }
            updateCompareModeIndicator();
        }

        // 更新对比图片变换
        function updateCompareTransform(imageKey) {
            const wrapper = document.querySelector(`.compare-image-wrapper[data-image-key="${imageKey}"]`);
            if (!wrapper) return;

            const state = compareStates[imageKey];
            const container = wrapper.querySelector('.compare-image-container');
            const zoomInfo = wrapper.querySelector('.compare-zoom-info');

            // 使用 translate(-50%, -50%) 来居中，然后应用用户的拖动偏移和缩放
            container.style.transform = `translate(calc(-50% + ${state.x}px), calc(-50% + ${state.y}px)) scale(${state.zoom})`;
            zoomInfo.textContent = `${Math.round(state.zoom * 100)}%`;
        }

        // 设置对比图片拖拽（支持鼠标和触摸）
        function setupCompareDrag(wrapper, imageKey) {
            let isDragging = false;
            let startX = 0;
            let startY = 0;

            // 获取位置（兼容鼠标和触摸）
            function getPosition(e) {
                if (e.touches && e.touches.length > 0) {
                    return { x: e.touches[0].clientX, y: e.touches[0].clientY };
                }
                return { x: e.clientX, y: e.clientY };
            }

            // 开始拖拽
            function startDrag(e) {
                e.preventDefault();
                const state = compareStates[imageKey];
                const pos = getPosition(e);
                isDragging = true;
                startX = pos.x - state.x;
                startY = pos.y - state.y;
                wrapper.classList.add('dragging');
            }

            // 移动中
            function moveDrag(e) {
                if (isDragging) {
                    e.preventDefault();
                    const pos = getPosition(e);

                    if (compareZoomMode === 'sync') {
                        // 同步模式：所有图片一起移动
                        const deltaX = pos.x - startX;
                        const deltaY = pos.y - startY;
                        const currentState = compareStates[imageKey];
                        const offsetX = deltaX - currentState.x;
                        const offsetY = deltaY - currentState.y;

                        compareImages.forEach(img => {
                            const key = `${img.file.name}_${img.file.size}`;
                            const state = compareStates[key];
                            state.x += offsetX;
                            state.y += offsetY;
                            updateCompareTransform(key);
                        });
                    } else {
                        // 独立模式：只移动当前图片
                        const state = compareStates[imageKey];
                        state.x = pos.x - startX;
                        state.y = pos.y - startY;
                        updateCompareTransform(imageKey);
                    }
                }
            }

            // 结束拖拽
            function endDrag() {
                isDragging = false;
                wrapper.classList.remove('dragging');
            }

            // 鼠标事件
            wrapper.addEventListener('mousedown', startDrag);
            wrapper.addEventListener('mousemove', moveDrag);
            wrapper.addEventListener('mouseup', endDrag);
            wrapper.addEventListener('mouseleave', endDrag);

            // 触摸事件
            wrapper.addEventListener('touchstart', startDrag, { passive: false });
            wrapper.addEventListener('touchmove', moveDrag, { passive: false });
            wrapper.addEventListener('touchend', endDrag);
            wrapper.addEventListener('touchcancel', endDrag);
        }

        // ESC键关闭对比模态框
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const compareModal = document.getElementById('compareModal');
                if (compareModal.classList.contains('active')) {
                    closeCompareModal();
                }

                const reportModal = document.getElementById('reportModal');
                if (reportModal.classList.contains('active')) {
                    closeReport();
                }
            }
        });

        // ==================== 报告功能 ====================

        // 归纳相似评论
        function groupSimilarComments(comments) {
            if (comments.length === 0) return [];

            const groups = [];
            const processed = new Set();

            comments.forEach((item, index) => {
                if (processed.has(index)) return;

                const similarItems = [item];
                processed.add(index);

                // 查找相似的评论
                for (let i = index + 1; i < comments.length; i++) {
                    if (processed.has(i)) continue;

                    const similarity = calculateSimilarity(item.comment, comments[i].comment);
                    // 相似度超过60%归为一组
                    if (similarity > 0.6) {
                        similarItems.push(comments[i]);
                        processed.add(i);
                    }
                }

                groups.push({
                    representative: item.comment,
                    items: similarItems
                });
            });

            // 按组内数量降序排列
            return groups.sort((a, b) => b.items.length - a.items.length);
        }

        // 计算两个字符串的相似度（简化版Levenshtein距离）
        function calculateSimilarity(str1, str2) {
            str1 = str1.toLowerCase().trim();
            str2 = str2.toLowerCase().trim();

            if (str1 === str2) return 1;
            if (str1.length === 0 || str2.length === 0) return 0;

            // 计算公共子串
            let longer = str1.length > str2.length ? str1 : str2;
            let shorter = str1.length > str2.length ? str2 : str1;

            // 如果较短的字符串包含在较长的字符串中
            if (longer.includes(shorter)) {
                return shorter.length / longer.length;
            }

            // 计算编辑距离
            const editDistance = levenshteinDistance(str1, str2);
            const maxLength = Math.max(str1.length, str2.length);
            return 1 - editDistance / maxLength;
        }

        // Levenshtein距离算法
        function levenshteinDistance(str1, str2) {
            const matrix = [];

            for (let i = 0; i <= str2.length; i++) {
                matrix[i] = [i];
            }

            for (let j = 0; j <= str1.length; j++) {
                matrix[0][j] = j;
            }

            for (let i = 1; i <= str2.length; i++) {
                for (let j = 1; j <= str1.length; j++) {
                    if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }

            return matrix[str2.length][str1.length];
        }

        // 辅助函数：获取图片的评分（根据评分模式）
        function getRatingForImage(imageKey, folderName = null) {
            if (!ratings[imageKey]) return null;

            let ratingData = null;

            if (ratingMode === 'single') {
                // 单一评分模式：使用主文件夹的评分
                const targetFolderIndex = mainFolderIndex !== -1 ? mainFolderIndex : 0;
                const targetFolderName = folders[targetFolderIndex] ? folders[targetFolderIndex].name : '';
                ratingData = ratings[imageKey][targetFolderName];
            } else {
                // 多维评分模式：使用指定文件夹或第一个文件夹的评分
                if (folderName) {
                    ratingData = ratings[imageKey][folderName];
                } else {
                    // 如果没有指定文件夹，使用第一个有评分的文件夹
                    const folderNames = Object.keys(ratings[imageKey]);
                    if (folderNames.length > 0) {
                        ratingData = ratings[imageKey][folderNames[0]];
                    }
                }
            }

            // 兼容新旧数据格式
            return typeof ratingData === 'string' ? ratingData : (ratingData?.rating || null);
        }

        // 生成报告（完全参考备份版本）
        function generateReport() {
            console.log('====== 生成报告函数被调用 ======');
            console.log('allImages 数量:', allImages ? allImages.length : 'undefined');

            const modal = document.getElementById('reportModal');
            const container = document.getElementById('reportContainer');

            console.log('modal 元素:', modal);
            console.log('container 元素:', container);

            // 统计数据
            const total = allImages.length;
            console.log('total:', total);
            let liked = [], neutral = [], disliked = [], unrated = [];

            // 收集评论
            let goodComments = []; // 喜欢的评论
            let badComments = []; // 一般+不喜欢的评论

            allImages.forEach(file => {
                const imageKey = `${file.name}_${file.size}`;
                const folderName = file.folderName || '';

                // 获取评分（根据评分模式）
                let ratingData = null;
                if (ratings[imageKey]) {
                    if (ratingMode === 'single') {
                        // 单一评分模式：统计主文件夹的评分
                        const targetFolderIndex = mainFolderIndex !== -1 ? mainFolderIndex : 0;
                        const targetFolderName = folders[targetFolderIndex] ? folders[targetFolderIndex].name : '';
                        ratingData = ratings[imageKey][targetFolderName];
                    } else {
                        // 多维评分模式：统计所有文件夹的评分
                        ratingData = ratings[imageKey][folderName];
                    }
                }

                // 兼容新旧数据格式
                const rating = typeof ratingData === 'string' ? ratingData : (ratingData?.rating || null);
                const comment = typeof ratingData === 'object' ? (ratingData?.comment || '') : '';

                if (rating === 'like') {
                    liked.push(file);
                    if (comment) {
                        goodComments.push({ file: file.name, comment: comment });
                    }
                } else if (rating === 'neutral') {
                    neutral.push(file);
                    if (comment) {
                        badComments.push({ file: file.name, comment: comment });
                    }
                } else if (rating === 'dislike') {
                    disliked.push(file);
                    if (comment) {
                        badComments.push({ file: file.name, comment: comment });
                    }
                } else {
                    unrated.push(file);
                }
            });

            const likedPercent = total > 0 ? Math.round((liked.length / total) * 100) : 0;
            const neutralPercent = total > 0 ? Math.round((neutral.length / total) * 100) : 0;
            const dislikedPercent = total > 0 ? Math.round((disliked.length / total) * 100) : 0;
            const unratedPercent = total > 0 ? Math.round((unrated.length / total) * 100) : 0;

            // 计算 Goodcase 和 Badcase 百分比
            const goodcaseCount = liked.length;
            const badcaseCount = neutral.length + disliked.length;
            const ratedTotal = goodcaseCount + badcaseCount;
            const goodcasePercent = ratedTotal > 0 ? Math.round((goodcaseCount / ratedTotal) * 100) : 0;
            const badcasePercent = ratedTotal > 0 ? Math.round((badcaseCount / ratedTotal) * 100) : 0;

            console.log('统计完成:', { liked: liked.length, neutral: neutral.length, disliked: disliked.length, unrated: unrated.length });
            console.log('Goodcase:', goodcasePercent + '%', 'Badcase:', badcasePercent + '%');
            console.log('goodComments 数量:', goodComments.length);
            console.log('badComments 数量:', badComments.length);

            // 归纳相似评论
            console.log('开始归纳评论...');
            const groupedGoodComments = groupSimilarComments(goodComments);
            const groupedBadComments = groupSimilarComments(badComments);
            console.log('评论归纳完成:', { groupedGoodComments: groupedGoodComments.length, groupedBadComments: groupedBadComments.length });

            // 获取父文件夹名字
            let parentFolderName = currentFolderName;
            if (folders.length > 0) {
                const firstFolder = folders[0];
                // 如果有 fullPath，从中提取父文件夹名
                if (firstFolder.fullPath) {
                    const pathParts = firstFolder.fullPath.split('/');
                    // 获取第一级路径作为父文件夹名
                    parentFolderName = pathParts[0] || currentFolderName;
                } else if (firstFolder.name) {
                    // 如果没有 fullPath，直接使用 name
                    parentFolderName = firstFolder.name;
                }
            }

            // 生成报告HTML
            let reportHTML = `
                <div class="report-edit-toolbar">
                    <button class="edit-btn" onclick="addTextBlock()" title="添加文本块">
                        <span>📝</span> 添加文本
                    </button>
                    <button class="edit-btn" onclick="addImageBlock()" title="添加图片">
                        <span>🖼️</span> 添加图片
                    </button>
                    <button class="edit-btn" onclick="toggleDragMode()" id="dragModeBtn" title="切换拖拽模式">
                        <span>✋</span> 拖拽模式
                    </button>
                </div>

                <div class="report-header">
                    <div class="report-folder-name" contenteditable="true">${parentFolderName}</div>
                    <div class="report-subtitle" contenteditable="true">图片评分报告 · 共 ${total} 张图片</div>
                </div>

                ${ratedTotal > 0 ? `
                <div class="report-case-summary">
                    <div class="case-column goodcase ${goodcasePercent >= 98 ? 'perfect' : (goodcasePercent >= 90 ? 'excellent' : '')}">
                        <div class="case-header">
                            <span class="case-label">✨ Goodcase${goodcasePercent >= 98 ? ' <span class="perfect-badge">完美</span>' : (goodcasePercent >= 90 ? ' <span class="excellent-badge">优秀</span>' : '')}</span>
                            <span class="case-percentage" contenteditable="true">${goodcasePercent}%</span>
                        </div>
                        <div class="case-details">
                            <div class="detail-item like">
                                <span class="detail-label">😍 喜欢</span>
                                <span class="detail-stats">
                                    <span class="detail-percentage" contenteditable="true">${likedPercent}%</span>
                                    <span class="detail-count" contenteditable="true">${liked.length}张</span>
                                </span>
                            </div>
                        </div>
                    </div>

                    <div class="case-divider"></div>

                    <div class="case-column badcase ${badcasePercent > 50 ? 'high-risk' : ''}">
                        <div class="case-header">
                            <span class="case-label">⚠️ Badcase${badcasePercent > 50 ? ' <span class="risk-badge">高风险</span>' : ''}</span>
                            <span class="case-percentage" contenteditable="true">${badcasePercent}%</span>
                        </div>
                        <div class="case-details">
                            <div class="detail-row">
                                <div class="detail-item neutral">
                                    <span class="detail-label">😐 一般</span>
                                    <span class="detail-stats">
                                        <span class="detail-percentage" contenteditable="true">${neutralPercent}%</span>
                                        <span class="detail-count" contenteditable="true">${neutral.length}张</span>
                                    </span>
                                </div>
                                <div class="detail-item dislike">
                                    <span class="detail-label">😢 不喜欢</span>
                                    <span class="detail-stats">
                                        <span class="detail-percentage" contenteditable="true">${dislikedPercent}%</span>
                                        <span class="detail-count" contenteditable="true">${disliked.length}张</span>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                ${unrated.length > 0 ? `
                <div class="report-unrated-section">
                    <span class="unrated-label">⭕ 未评分</span>
                    <span class="unrated-stats">
                        <span class="unrated-percentage" contenteditable="true">${unratedPercent}%</span>
                        <span class="unrated-count" contenteditable="true">${unrated.length}张</span>
                    </span>
                </div>
                ` : ''}
                ` : ''}
            `;

            // 添加评论归纳部分
            if (groupedGoodComments.length > 0 || groupedBadComments.length > 0) {
                reportHTML += `<div class="report-section" style="margin-top: 30px;">
                    <div class="report-section-title" style="margin-bottom: 20px;">
                        <span class="report-section-icon">💬</span>
                        <span contenteditable="true">文本评价归纳</span>
                    </div>`;

                // Goodcase 评论
                if (groupedGoodComments.length > 0) {
                    reportHTML += `
                        <div style="background: linear-gradient(135deg, rgba(168, 191, 168, 0.1) 0%, rgba(196, 217, 196, 0.1) 100%); border: 2px solid var(--color-like); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                            <h3 contenteditable="true" style="color: var(--color-like); margin: 0 0 16px 0; font-size: 1.2rem; font-weight: 600;">
                                ✨ Goodcase - 喜欢的评价
                            </h3>`;

                    groupedGoodComments.forEach((group, index) => {
                        reportHTML += `
                            <div style="margin-bottom: 24px; padding: 12px; background: var(--bg-card); border-radius: 8px; border-left: 4px solid var(--color-like);">
                                <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">
                                    "<span contenteditable="true">${group.representative}</span>" <span contenteditable="true" style="color: var(--text-muted); font-weight: 400; font-size: 0.9rem;">(${group.items.length}张)</span>
                                </div>
                                <div class="report-image-list" id="goodcase-group-${index}" style="margin-top: 12px;"></div>
                            </div>`;
                    });

                    reportHTML += `</div>`;
                }

                // Badcase 评论
                if (groupedBadComments.length > 0) {
                    reportHTML += `
                        <div style="background: linear-gradient(135deg, rgba(212, 165, 181, 0.1) 0%, rgba(229, 196, 208, 0.1) 100%); border: 2px solid var(--color-dislike); border-radius: 12px; padding: 20px;">
                            <h3 contenteditable="true" style="color: var(--color-dislike); margin: 0 0 16px 0; font-size: 1.2rem; font-weight: 600;">
                                ⚠️ Badcase - 一般/不喜欢的评价
                            </h3>`;

                    groupedBadComments.forEach((group, index) => {
                        reportHTML += `
                            <div style="margin-bottom: 24px; padding: 12px; background: var(--bg-card); border-radius: 8px; border-left: 4px solid var(--color-dislike);">
                                <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">
                                    "<span contenteditable="true">${group.representative}</span>" <span contenteditable="true" style="color: var(--text-muted); font-weight: 400; font-size: 0.9rem;">(${group.items.length}张)</span>
                                </div>
                                <div class="report-image-list" id="badcase-group-${index}" style="margin-top: 12px;"></div>
                            </div>`;
                    });

                    reportHTML += `</div>`;
                }

                reportHTML += `</div>`;
            }

            console.log('HTML 生成完成，准备设置到 container');
            console.log('生成的 HTML 长度:', reportHTML.length);
            console.log('HTML 前500字符:', reportHTML.substring(0, 500));
            container.innerHTML = reportHTML;
            console.log('HTML 已设置到 container');
            console.log('container.children 数量:', container.children.length);
            console.log('第一个子元素:', container.children[0]);

            // 渲染 Goodcase 图片
            console.log('开始渲染 Goodcase 图片...');
            if (groupedGoodComments.length > 0) {
                groupedGoodComments.forEach((group, index) => {
                    // 根据文件名找到对应的文件对象
                    const groupFiles = group.items.map(item => {
                        return allImages.find(file => file.name === item.file);
                    }).filter(f => f); // 过滤掉未找到的

                    renderReportImages(`goodcase-group-${index}`, groupFiles);
                });
            }

            // 渲染 Badcase 图片
            if (groupedBadComments.length > 0) {
                groupedBadComments.forEach((group, index) => {
                    // 根据文件名找到对应的文件对象
                    const groupFiles = group.items.map(item => {
                        return allImages.find(file => file.name === item.file);
                    }).filter(f => f); // 过滤掉未找到的

                    renderReportImages(`badcase-group-${index}`, groupFiles);
                });
            }

            console.log('准备显示 modal');

            // 隐藏主页容器
            const mainContainer = document.querySelector('.container');
            if (mainContainer) {
                mainContainer.style.display = 'none';
                console.log('主页容器已隐藏');
            }

            modal.classList.add('active');
            document.body.style.overflow = 'hidden';

            // 强制滚动到顶部
            modal.scrollTop = 0;
            window.scrollTo(0, 0);

            // 检查报告容器的位置和大小
            console.log('reportContainer 位置:', {
                offsetTop: container.offsetTop,
                offsetHeight: container.offsetHeight,
                scrollHeight: container.scrollHeight
            });
            console.log('modal 的 scrollTop:', modal.scrollTop);
            console.log('modal 的 scrollHeight:', modal.scrollHeight);

            console.log('====== 报告生成完成 ======');
        }

        // 渲染报告中的图片列表
        async function renderReportImages(containerId, images) {
            const container = document.getElementById(containerId);
            if (!container) return;

            for (let fileIndex = 0; fileIndex < images.length; fileIndex++) {
                const file = images[fileIndex];
                const imageKey = `${file.name}_${file.size}`;
                const item = document.createElement('div');
                item.className = 'report-image-item';
                const itemId = `${containerId}-img-${fileIndex}`;

                if (isRawFile(file)) {
                    // 检查缓存
                    if (imageCache[imageKey]) {
                        item.innerHTML = `
                            <div class="report-image-thumb">
                                <img src="${imageCache[imageKey]}" alt="${file.name}" id="${itemId}" onclick="openReportImageModal('${itemId}')" title="点击放大">
                                <button class="report-image-replace-btn" onclick="event.stopPropagation(); replaceReportImage('${itemId}')" title="替换图片">🔄</button>
                            </div>
                            <div class="report-image-filename" contenteditable="true" title="${file.name}">${file.name}</div>
                        `;
                        container.appendChild(item);
                    } else {
                        // 先显示加载占位符
                        item.innerHTML = `
                            <div class="report-image-thumb">
                                <div style="color: var(--text-muted);">正在提取RAW预览...</div>
                            </div>
                            <div class="report-image-filename" contenteditable="true" title="${file.name}">${file.name}</div>
                        `;
                        container.appendChild(item);

                        // 尝试提取RAW预览
                        const previewUrl = await extractRawPreview(file);
                        if (previewUrl) {
                            imageCache[imageKey] = previewUrl;
                            item.innerHTML = `
                                <div class="report-image-thumb">
                                    <img src="${previewUrl}" alt="${file.name}" id="${itemId}" onclick="openReportImageModal('${itemId}')" title="点击放大">
                                    <button class="report-image-replace-btn" onclick="event.stopPropagation(); replaceReportImage('${itemId}')" title="替换图片">🔄</button>
                                </div>
                                <div class="report-image-filename" contenteditable="true" title="${file.name}">${file.name}</div>
                            `;
                        } else {
                            // 无法提取，显示图标
                            const ext = file.name.split('.').pop().toUpperCase();
                            item.innerHTML = `
                                <div class="report-image-thumb">
                                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center;">
                                        <div style="font-size: 3rem; opacity: 0.6;">📷</div>
                                        <div style="font-size: 0.9rem; color: var(--primary-purple); margin-top: 8px;">${ext}</div>
                                    </div>
                                </div>
                                <div class="report-image-filename" contenteditable="true" title="${file.name}">${file.name}</div>
                            `;
                        }
                    }
                } else {
                    // 普通图片
                    if (imageCache[imageKey]) {
                        item.innerHTML = `
                            <div class="report-image-thumb">
                                <img src="${imageCache[imageKey]}" alt="${file.name}" id="${itemId}" onclick="openReportImageModal('${itemId}')" title="点击放大">
                                <button class="report-image-replace-btn" onclick="event.stopPropagation(); replaceReportImage('${itemId}')" title="替换图片">🔄</button>
                            </div>
                            <div class="report-image-filename" contenteditable="true" title="${file.name}">${file.name}</div>
                        `;
                        container.appendChild(item);
                    } else {
                        // 先显示占位符
                        item.innerHTML = `
                            <div class="report-image-thumb">
                                <div style="color: var(--text-muted);">加载中...</div>
                            </div>
                            <div class="report-image-filename" contenteditable="true" title="${file.name}">${file.name}</div>
                        `;
                        container.appendChild(item);

                        // 读取图片
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            imageCache[imageKey] = e.target.result;
                            item.innerHTML = `
                                <div class="report-image-thumb">
                                    <img src="${e.target.result}" alt="${file.name}" id="${itemId}" onclick="openReportImageModal('${itemId}')" title="点击放大">
                                    <button class="report-image-replace-btn" onclick="event.stopPropagation(); replaceReportImage('${itemId}')" title="替换图片">🔄</button>
                                </div>
                                <div class="report-image-filename" contenteditable="true" title="${file.name}">${file.name}</div>
                            `;
                        };
                        reader.readAsDataURL(file);
                    }
                }
            }
        }

        // 以下是旧的复杂报告代码，已注释掉
        /*
            // 二级：喜欢（仅出现一次，不分页）
            if (groupedLikeComments.length > 0) {
                reportHTML += `
                    <div class="report-section" id="likeSection">
                        <h2 style="color: #34d399; margin: 0 0 48px 0; font-size: 2rem; font-weight: 600; letter-spacing: -0.02em; border-bottom: 1px solid rgba(16, 185, 129, 0.2); padding-bottom: 16px;">
                            <span style="font-size: 1.5rem; margin-right: 12px;">👍</span>
                            <span contenteditable="true">喜欢</span>
                            <span style="margin: 0 16px; opacity: 0.3; font-size: 1.25rem;">·</span>
                            <span contenteditable="true" style="font-size: 1.125rem; color: #9B8FA5; font-weight: 500;">喜欢的评价</span>
                        </h2>
                        <div class="report-groups-container" id="likeGroups">`;

                // 三级：按评论分组（重复最多的靠前）- 文本标签只出现一次，可拖拽排序
                groupedLikeComments.forEach((group, index) => {
                    reportHTML += `
                        <div class="draggable-report-group" draggable="true" data-group-index="${index}" style="margin-bottom: 64px; page-break-inside: avoid; position: relative;">
                            <div class="drag-handle" style="position: absolute; left: -32px; top: 8px; cursor: grab; font-size: 1.25rem; opacity: 0.3; user-select: none;" title="拖拽排序">⋮⋮</div>
                            <div style="margin-bottom: 32px;">
                                <h3 style="font-weight: 400; color: #4A4550; margin: 0 0 8px 0; font-size: 1.25rem; line-height: 1.6; letter-spacing: -0.01em;">
                                    "<span contenteditable="true">${group.representative}</span>"
                                </h3>
                                <div style="color: #34d399; font-weight: 400; font-size: 0.875rem; opacity: 0.8; letter-spacing: 0.02em;">
                                    ${group.items.length} 张图片
                                </div>
                            </div>
                            <div class="report-image-grid-wallpaper" id="like-group-${index}"></div>
                        </div>`;
                });

                reportHTML += `
                        </div>

                        <!-- 喜欢 自定义图片区域容器 -->
                        <div id="likeCustomSections"></div>

                        <!-- 喜欢 新增图片按钮 -->
                        <button class="add-image-section-btn" onclick="showImageLayoutConfig('like')" style="margin-top: 32px;">
                            <span style="font-size: 1.5rem;">➕</span>
                            <span>新增图片区域</span>
                        </button>
                    </div>`;
            }

            // 二级：一般（仅出现一次）
            if (groupedNeutralComments.length > 0) {
                reportHTML += `
                    <div class="report-section" id="neutralSection" style="page-break-before: always;">
                        <h2 style="color: #fbbf24; margin: 0 0 48px 0; font-size: 2rem; font-weight: 600; letter-spacing: -0.02em; border-bottom: 1px solid rgba(245, 158, 11, 0.2); padding-bottom: 16px;">
                            <span style="font-size: 1.5rem; margin-right: 12px;">😐</span>
                            <span contenteditable="true">一般</span>
                            <span style="margin: 0 16px; opacity: 0.3; font-size: 1.25rem;">·</span>
                            <span contenteditable="true" style="font-size: 1.125rem; color: #9B8FA5; font-weight: 500;">一般的评价</span>
                        </h2>
                        <div class="report-groups-container" id="neutralGroups">`;

                // 三级：按评论分组（重复最多的靠前）- 文本标签只出现一次，可拖拽排序
                groupedNeutralComments.forEach((group, index) => {
                    reportHTML += `
                        <div class="draggable-report-group" draggable="true" data-group-index="${index}" style="margin-bottom: 64px; page-break-inside: avoid; position: relative;">
                            <div class="drag-handle" style="position: absolute; left: -32px; top: 8px; cursor: grab; font-size: 1.25rem; opacity: 0.3; user-select: none;" title="拖拽排序">⋮⋮</div>
                            <div style="margin-bottom: 32px;">
                                <h3 style="font-weight: 400; color: #4A4550; margin: 0 0 8px 0; font-size: 1.25rem; line-height: 1.6; letter-spacing: -0.01em;">
                                    "<span contenteditable="true">${group.representative}</span>"
                                </h3>
                                <div style="color: #fbbf24; font-weight: 400; font-size: 0.875rem; opacity: 0.8; letter-spacing: 0.02em;">
                                    ${group.items.length} 张图片
                                </div>
                            </div>
                            <div class="report-image-grid-wallpaper" id="neutral-group-${index}"></div>
                        </div>`;
                });

                reportHTML += `
                        </div>

                        <!-- 一般 自定义图片区域容器 -->
                        <div id="neutralCustomSections"></div>

                        <!-- 一般 新增图片按钮 -->
                        <button class="add-image-section-btn" onclick="showImageLayoutConfig('neutral')" style="margin-top: 32px;">
                            <span style="font-size: 1.5rem;">➕</span>
                            <span>新增图片区域</span>
                        </button>
                    </div>`;
            }

            // 二级：不喜欢（仅出现一次）
            if (groupedDislikeComments.length > 0) {
                reportHTML += `
                    <div class="report-section" id="dislikeSection" style="page-break-before: always;">
                        <h2 style="color: #f87171; margin: 0 0 48px 0; font-size: 2rem; font-weight: 600; letter-spacing: -0.02em; border-bottom: 1px solid rgba(239, 68, 68, 0.2); padding-bottom: 16px;">
                            <span style="font-size: 1.5rem; margin-right: 12px;">👎</span>
                            <span contenteditable="true">不喜欢</span>
                            <span style="margin: 0 16px; opacity: 0.3; font-size: 1.25rem;">·</span>
                            <span contenteditable="true" style="font-size: 1.125rem; color: #9B8FA5; font-weight: 500;">不喜欢的评价</span>
                        </h2>
                        <div class="report-groups-container" id="dislikeGroups">`;

                // 三级：按评论分组（重复最多的靠前）- 文本标签只出现一次，可拖拽排序
                groupedDislikeComments.forEach((group, index) => {
                    reportHTML += `
                        <div class="draggable-report-group" draggable="true" data-group-index="${index}" style="margin-bottom: 64px; page-break-inside: avoid; position: relative;">
                            <div class="drag-handle" style="position: absolute; left: -32px; top: 8px; cursor: grab; font-size: 1.25rem; opacity: 0.3; user-select: none;" title="拖拽排序">⋮⋮</div>
                            <div style="margin-bottom: 32px;">
                                <h3 style="font-weight: 400; color: #4A4550; margin: 0 0 8px 0; font-size: 1.25rem; line-height: 1.6; letter-spacing: -0.01em;">
                                    "<span contenteditable="true">${group.representative}</span>"
                                </h3>
                                <div style="color: #f87171; font-weight: 400; font-size: 0.875rem; opacity: 0.8; letter-spacing: 0.02em;">
                                    ${group.items.length} 张图片
                                </div>
                            </div>
                            <div class="report-image-grid-wallpaper" id="dislike-group-${index}"></div>
                        </div>`;
                });

                reportHTML += `
                        </div>

                        <!-- 不喜欢 自定义图片区域容器 -->
                        <div id="dislikeCustomSections"></div>

                        <!-- 不喜欢 新增图片按钮 -->
                        <button class="add-image-section-btn" onclick="showImageLayoutConfig('dislike')" style="margin-top: 32px;">
                            <span style="font-size: 1.5rem;">➕</span>
                            <span>新增图片区域</span>
                        </button>
                    </div>`;
            }

            // 作者签名区域
            reportHTML += `
                <div style="margin-top: 96px; padding-top: 48px; border-top: 1px solid rgba(155, 143, 165, 0.15); page-break-inside: avoid;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                        <div>
                            <div style="font-size: 0.75rem; color: #9B8FA5; letter-spacing: 0.05em; text-transform: uppercase; margin-bottom: 8px;">
                                Reviewed By
                            </div>
                            <div contenteditable="true" style="font-size: 1.125rem; color: #4A4550; font-weight: 400; border-bottom: 1px solid rgba(155, 143, 165, 0.3); padding: 8px 0; min-width: 240px; outline: none;">
                                签名
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 0.75rem; color: #9B8FA5; letter-spacing: 0.05em; text-transform: uppercase; margin-bottom: 8px;">
                                Date
                            </div>
                            <div contenteditable="true" style="font-size: 1rem; color: #6A5F74; font-weight: 300;">
                                ${new Date().toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric' })}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 新增图片配置界面（全局共享） -->
                <div class="image-layout-config" id="imageLayoutConfig">
                    <div class="config-row">
                        <span class="config-label">每行图片数：</span>
                        <input type="number" class="config-input" id="imagesPerRow" min="1" max="4" value="2">
                        <span style="font-size: 0.8rem; color: #9B8FA5; margin-left: 8px;">（1-4张）</span>
                    </div>
                    <div class="config-row">
                        <span class="config-label">行数：</span>
                        <input type="number" class="config-input" id="numberOfRows" min="1" max="10" value="1">
                        <span style="font-size: 0.8rem; color: #9B8FA5; margin-left: 8px;">（1-10行）</span>
                    </div>
                    <div class="config-buttons">
                        <button class="config-btn config-btn-cancel" onclick="cancelAddImageSection()">取消</button>
                        <button class="config-btn config-btn-confirm" onclick="confirmAddImageSection()">确认添加</button>
                    </div>
                </div>
            `;
        */

        // 初始化报告分组的拖拽排序
        function initializeReportGroupDragSort() {
            const containers = ['likeGroups', 'neutralGroups', 'dislikeGroups'];

            containers.forEach(containerId => {
                const container = document.getElementById(containerId);
                if (!container) return;

                const draggableGroups = container.querySelectorAll('.draggable-report-group');
                let draggedElement = null;

                draggableGroups.forEach(group => {
                    group.addEventListener('dragstart', function(e) {
                        draggedElement = this;
                        this.style.opacity = '0.4';
                        e.dataTransfer.effectAllowed = 'move';
                    });

                    group.addEventListener('dragend', function(e) {
                        this.style.opacity = '1';
                        draggedElement = null;
                    });

                    group.addEventListener('dragover', function(e) {
                        if (e.preventDefault) {
                            e.preventDefault();
                        }
                        e.dataTransfer.dropEffect = 'move';

                        if (draggedElement && draggedElement !== this) {
                            const rect = this.getBoundingClientRect();
                            const midpoint = rect.top + rect.height / 2;
                            if (e.clientY < midpoint) {
                                container.insertBefore(draggedElement, this);
                            } else {
                                container.insertBefore(draggedElement, this.nextSibling);
                            }
                        }
                        return false;
                    });

                    group.addEventListener('dragenter', function(e) {
                        if (draggedElement && draggedElement !== this) {
                            this.style.borderTop = '2px solid #A8BFA8';
                        }
                    });

                    group.addEventListener('dragleave', function(e) {
                        this.style.borderTop = '';
                    });

                    group.addEventListener('drop', function(e) {
                        if (e.stopPropagation) {
                            e.stopPropagation();
                        }
                        this.style.borderTop = '';
                        return false;
                    });
                });
            });
        }

        // 渲染报告中的图片列表
        function renderReportImages(containerId, images) {
            const container = document.getElementById(containerId);
            if (!container) return;

            for (let fileIndex = 0; fileIndex < images.length; fileIndex++) {
                const file = images[fileIndex];
                const imageKey = `${file.name}_${file.size}`;
                const item = document.createElement('div');
                item.className = 'report-image-item';
                const itemId = `${containerId}-img-${fileIndex}`;

                if (isRawFile(file)) {
                    // 检查缓存
                    if (imageCache[imageKey]) {
                        item.innerHTML = `
                            <div class="report-image-thumb">
                                <img src="${imageCache[imageKey]}" alt="${file.name}" id="${itemId}" onclick="openReportImageModal('${itemId}')" title="点击放大">
                                <button class="report-image-replace-btn" onclick="event.stopPropagation(); replaceReportImage('${itemId}')" title="替换图片">🔄</button>
                            </div>
                            <div class="report-image-filename" contenteditable="true" title="${file.name}">${file.name}</div>
                        `;
                        container.appendChild(item);
                    } else {
                        // 先显示加载占位符
                        item.innerHTML = `
                            <div class="report-image-thumb">
                                <div style="color: var(--text-muted);">正在提取RAW预览...</div>
                            </div>
                            <div class="report-image-filename" contenteditable="true" title="${file.name}">${file.name}</div>
                        `;
                        container.appendChild(item);

                        // 异步加载（非阻塞）
                        extractRawPreview(file).then(previewUrl => {
                            if (previewUrl) {
                                imageCache[imageKey] = previewUrl;
                                item.innerHTML = `
                                    <div class="report-image-thumb">
                                        <img src="${previewUrl}" alt="${file.name}" id="${itemId}" onclick="openReportImageModal('${itemId}')" title="点击放大">
                                        <button class="report-image-replace-btn" onclick="event.stopPropagation(); replaceReportImage('${itemId}')" title="替换图片">🔄</button>
                                    </div>
                                    <div class="report-image-filename" contenteditable="true" title="${file.name}">${file.name}</div>
                                `;
                            } else {
                                // 无法提取，显示图标
                                const ext = file.name.split('.').pop().toUpperCase();
                                item.innerHTML = `
                                    <div class="report-image-thumb">
                                        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center;">
                                            <div style="font-size: 3rem; opacity: 0.6;">📷</div>
                                            <div style="font-size: 0.9rem; color: var(--primary-purple); margin-top: 8px;">${ext}</div>
                                        </div>
                                    </div>
                                    <div class="report-image-filename" contenteditable="true" title="${file.name}">${file.name}</div>
                                `;
                            }
                        });
                    }
                } else {
                    // 普通图片
                    if (imageCache[imageKey]) {
                        item.innerHTML = `
                            <div class="report-image-thumb">
                                <img src="${imageCache[imageKey]}" alt="${file.name}" id="${itemId}" onclick="openReportImageModal('${itemId}')" title="点击放大">
                                <button class="report-image-replace-btn" onclick="event.stopPropagation(); replaceReportImage('${itemId}')" title="替换图片">🔄</button>
                            </div>
                            <div class="report-image-filename" contenteditable="true" title="${file.name}">${file.name}</div>
                        `;
                        container.appendChild(item);
                    } else {
                        // 先显示占位符
                        item.innerHTML = `
                            <div class="report-image-thumb">
                                <div style="color: var(--text-muted);">加载中...</div>
                            </div>
                            <div class="report-image-filename" contenteditable="true" title="${file.name}">${file.name}</div>
                        `;
                        container.appendChild(item);

                        // 读取图片
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            imageCache[imageKey] = e.target.result;
                            item.innerHTML = `
                                <div class="report-image-thumb">
                                    <img src="${e.target.result}" alt="${file.name}" id="${itemId}" onclick="openReportImageModal('${itemId}')" title="点击放大">
                                    <button class="report-image-replace-btn" onclick="event.stopPropagation(); replaceReportImage('${itemId}')" title="替换图片">🔄</button>
                                </div>
                                <div class="report-image-filename" contenteditable="true" title="${file.name}">${file.name}</div>
                            `;
                        };
                        reader.readAsDataURL(file);
                    }
                }
            }
        }

        // 渲染带评论的图片列表（Wallpaper* 风格）
        function renderReportImagesWithComments(containerId, comments, allImages) {
            const container = document.getElementById(containerId);
            if (!container) return;

            for (let commentIndex = 0; commentIndex < comments.length; commentIndex++) {
                const commentData = comments[commentIndex];
                const fileName = commentData.file;
                const comment = commentData.comment;

                // 在 allImages 中查找对应的文件对象
                const file = allImages.find(f => f.name === fileName);
                if (!file) continue;

                const imageKey = `${file.name}_${file.size}`;
                const item = document.createElement('div');
                item.className = 'report-image-with-comment';
                const itemId = `${containerId}-img-${commentIndex}`;

                // 创建基础结构
                const visualDiv = document.createElement('div');
                visualDiv.className = 'report-image-with-comment-visual';

                const contentDiv = document.createElement('div');
                contentDiv.className = 'report-image-with-comment-content';
                contentDiv.innerHTML = `
                    <div class="report-image-with-comment-filename" contenteditable="true">${file.name}</div>
                    <div class="report-image-with-comment-text" contenteditable="true">${comment}</div>
                `;

                if (isRawFile(file)) {
                    // RAW 文件处理
                    if (imageCache[imageKey]) {
                        visualDiv.innerHTML = `
                            <img src="${imageCache[imageKey]}" alt="${file.name}" id="${itemId}" onclick="openReportImageModal('${itemId}')" title="点击放大">
                        `;
                    } else {
                        visualDiv.innerHTML = `<div style="color: var(--text-muted); font-size: 0.875rem;">正在提取RAW预览...</div>`;

                        // 异步加载（非阻塞）
                        extractRawPreview(file).then(previewUrl => {
                            if (previewUrl) {
                                imageCache[imageKey] = previewUrl;
                                visualDiv.innerHTML = `
                                    <img src="${previewUrl}" alt="${file.name}" id="${itemId}" onclick="openReportImageModal('${itemId}')" title="点击放大">
                                `;
                            } else {
                                const ext = file.name.split('.').pop().toUpperCase();
                                visualDiv.innerHTML = `
                                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center;">
                                        <div style="font-size: 3rem; opacity: 0.4;">📷</div>
                                        <div style="font-size: 0.75rem; color: #9B8FA5; margin-top: 8px; letter-spacing: 0.1em;">${ext}</div>
                                    </div>
                                `;
                            }
                        });
                    }
                } else {
                    // 普通图片
                    if (imageCache[imageKey]) {
                        visualDiv.innerHTML = `
                            <img src="${imageCache[imageKey]}" alt="${file.name}" id="${itemId}" onclick="openReportImageModal('${itemId}')" title="点击放大">
                        `;
                    } else {
                        visualDiv.innerHTML = `<div style="color: var(--text-muted); font-size: 0.875rem;">加载中...</div>`;

                        // 异步加载
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            imageCache[imageKey] = e.target.result;
                            visualDiv.innerHTML = `
                                <img src="${e.target.result}" alt="${file.name}" id="${itemId}" onclick="openReportImageModal('${itemId}')" title="点击放大">
                            `;
                        };
                        reader.readAsDataURL(file);
                    }
                }

                item.appendChild(visualDiv);
                item.appendChild(contentDiv);
                container.appendChild(item);
            }
        }

        // 渲染图片网格（Wallpaper* 风格 - 评论只出现一次）
        function renderReportImageGrid(containerId, comments, allImages) {
            const container = document.getElementById(containerId);
            if (!container) return;

            for (let commentIndex = 0; commentIndex < comments.length; commentIndex++) {
                const commentData = comments[commentIndex];
                const fileName = commentData.file;

                // 在 allImages 中查找对应的文件对象
                const file = allImages.find(f => f.name === fileName);
                if (!file) continue;

                const imageKey = `${file.name}_${file.size}`;
                const item = document.createElement('div');
                item.className = 'report-image-grid-item';
                const itemId = `${containerId}-img-${commentIndex}`;

                // 创建图片容器
                const visualDiv = document.createElement('div');
                visualDiv.className = 'report-image-grid-visual';

                // 创建文件名
                const filenameDiv = document.createElement('div');
                filenameDiv.className = 'report-image-grid-filename';
                filenameDiv.contentEditable = 'true';
                filenameDiv.textContent = file.name;

                if (isRawFile(file)) {
                    // RAW 文件处理
                    if (imageCache[imageKey]) {
                        visualDiv.innerHTML = `
                            <img src="${imageCache[imageKey]}" alt="${file.name}" id="${itemId}" onclick="openReportImageModal('${itemId}')" title="点击放大">
                            <button class="report-image-grid-replace-btn" onclick="event.stopPropagation(); replaceReportImage('${itemId}')" title="替换图片">🔄</button>
                        `;
                    } else {
                        visualDiv.innerHTML = `<div style="color: var(--text-muted); font-size: 0.75rem;">正在提取RAW预览...</div>`;

                        // 异步加载（非阻塞）
                        extractRawPreview(file).then(previewUrl => {
                            if (previewUrl) {
                                imageCache[imageKey] = previewUrl;
                                visualDiv.innerHTML = `
                                    <img src="${previewUrl}" alt="${file.name}" id="${itemId}" onclick="openReportImageModal('${itemId}')" title="点击放大">
                                    <button class="report-image-grid-replace-btn" onclick="event.stopPropagation(); replaceReportImage('${itemId}')" title="替换图片">🔄</button>
                                `;
                            } else {
                                const ext = file.name.split('.').pop().toUpperCase();
                                visualDiv.innerHTML = `
                                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center;">
                                        <div style="font-size: 2.5rem; opacity: 0.4;">📷</div>
                                        <div style="font-size: 0.7rem; color: #9B8FA5; margin-top: 8px; letter-spacing: 0.1em;">${ext}</div>
                                    </div>
                                `;
                            }
                        });
                    }
                } else {
                    // 普通图片
                    if (imageCache[imageKey]) {
                        visualDiv.innerHTML = `
                            <img src="${imageCache[imageKey]}" alt="${file.name}" id="${itemId}" onclick="openReportImageModal('${itemId}')" title="点击放大">
                            <button class="report-image-grid-replace-btn" onclick="event.stopPropagation(); replaceReportImage('${itemId}')" title="替换图片">🔄</button>
                        `;
                    } else {
                        visualDiv.innerHTML = `<div style="color: var(--text-muted); font-size: 0.75rem;">加载中...</div>`;

                        // 异步加载
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            imageCache[imageKey] = e.target.result;
                            visualDiv.innerHTML = `
                                <img src="${e.target.result}" alt="${file.name}" id="${itemId}" onclick="openReportImageModal('${itemId}')" title="点击放大">
                                <button class="report-image-grid-replace-btn" onclick="event.stopPropagation(); replaceReportImage('${itemId}')" title="替换图片">🔄</button>
                            `;
                        };
                        reader.readAsDataURL(file);
                    }
                }

                item.appendChild(visualDiv);
                item.appendChild(filenameDiv);
                container.appendChild(item);
            }
        }

        // 报告中点击图片预览
        function openReportImagePreview(imageSrc, imageName) {
            const modal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');

            if (!modal || !modalImage) {
                console.error('图片查看模态框未找到');
                return;
            }

            modalImage.src = imageSrc;
            modal.classList.add('active');

            // 等待图片加载完成后计算最佳初始缩放
            modalImage.onload = function() {
                const imgWidth = modalImage.naturalWidth;
                const imgHeight = modalImage.naturalHeight;
                const viewportWidth = window.innerWidth;
                const viewportHeight = window.innerHeight;

                // 计算图片宽高比
                const imgRatio = imgWidth / imgHeight;
                const viewportRatio = viewportWidth / viewportHeight;

                // 如果图片更宽（横向图片），让它优先填满宽度
                if (imgRatio > viewportRatio) {
                    // 横向图片，计算填满95%宽度所需的缩放
                    const targetWidth = viewportWidth * 0.95;
                    const naturalDisplayWidth = Math.min(imgWidth, viewportWidth * 0.95);
                    currentZoom = targetWidth / naturalDisplayWidth;
                } else {
                    // 纵向或方形图片，保持默认
                    currentZoom = 1;
                }

                currentX = 0;
                currentY = 0;
                updateTransform();
            };

            // 重置缩放和位置（图片加载前）
            currentZoom = 1;
            currentX = 0;
            currentY = 0;
            updateTransform();
        }

        // 打印报告/导出PDF
        function printReport() {
            window.print();
        }

        // 关闭报告
        function closeReport() {
            const modal = document.getElementById('reportModal');
            modal.classList.remove('active');
            document.body.style.overflow = 'auto';

            // 恢复主页容器显示
            const mainContainer = document.querySelector('.container');
            if (mainContainer) {
                mainContainer.style.display = 'block';
            }
        }

        // 初始化图片拖拽排序
        function initImageDragSort(container) {
            let draggedElement = null;

            const items = container.querySelectorAll('.report-image-item-draggable');

            items.forEach(item => {
                item.addEventListener('dragstart', function(e) {
                    draggedElement = this;
                    this.style.opacity = '0.5';
                    this.style.cursor = 'grabbing';
                });

                item.addEventListener('dragend', function(e) {
                    this.style.opacity = '1';
                    this.style.cursor = 'grab';
                });

                item.addEventListener('dragover', function(e) {
                    if (e.preventDefault) {
                        e.preventDefault();
                    }
                    e.dataTransfer.dropEffect = 'move';

                    if (draggedElement && draggedElement !== this) {
                        const rect = this.getBoundingClientRect();
                        const midpoint = rect.left + rect.width / 2;
                        if (e.clientX < midpoint) {
                            container.insertBefore(draggedElement, this);
                        } else {
                            container.insertBefore(draggedElement, this.nextSibling);
                        }
                    }
                    return false;
                });

                item.addEventListener('drop', function(e) {
                    if (e.stopPropagation) {
                        e.stopPropagation();
                    }
                    return false;
                });
            });
        }

        // 新增图片到报告
        function addReportImageSection(sectionType) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.multiple = true;
            input.onchange = (e) => {
                const files = Array.from(e.target.files);
                if (files.length === 0) return;

                const containerId = sectionType === 'goodcase' ? 'goodcaseContainer' : 'badcaseContainer';
                const container = document.getElementById(containerId);

                if (!container) {
                    console.error('容器未找到:', containerId);
                    Toast.error('报告容器未找到，请刷新页面重试', '错误');
                    return;
                }

                // 移除"暂无"提示
                const emptyMessage = container.querySelector('p');
                if (emptyMessage && emptyMessage.textContent.includes('暂无')) {
                    emptyMessage.remove();
                }

                // 创建新的图片组
                const groupDiv = document.createElement('div');
                groupDiv.style.cssText = 'margin-bottom: 64px; page-break-inside: avoid;';

                const groupId = `${containerId}-custom-${Date.now()}`;

                groupDiv.innerHTML = `
                    <div style="margin-bottom: 24px;">
                        <h3 style="font-weight: 500; color: #4A4550; margin: 0 0 8px 0; font-size: 1.125rem; line-height: 1.6;">
                            "<span contenteditable="true" style="outline: none;">新增图片</span>"
                        </h3>
                        <div style="color: #9B8FA5; font-size: 0.875rem;">
                            ${files.length} 张图片
                        </div>
                    </div>
                    <div class="report-image-grid" id="${groupId}" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;"></div>
                `;

                container.appendChild(groupDiv);

                // 渲染图片
                const imageGrid = document.getElementById(groupId);
                files.forEach((file, index) => {
                    const uniqueId = `${groupId}-img-${index}`;
                    const imgDiv = document.createElement('div');
                    imgDiv.className = 'report-image-item-draggable';
                    imgDiv.draggable = true;
                    imgDiv.dataset.imageId = uniqueId;
                    imgDiv.style.cssText = 'border-radius: 8px; overflow: visible; background: #f3f4f6; aspect-ratio: 4/3; position: relative; cursor: grab;';

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const url = e.target.result;
                        imgDiv.innerHTML = `
                            <img src="${url}"
                                 alt="${file.name}"
                                 id="${uniqueId}"
                                 style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;"
                                 onclick="openReportImagePreview('${url.replace(/'/g, "\\'")}', '${file.name.replace(/'/g, "\\'")}')"
                                 title="点击查看大图: ${file.name}">
                            <div class="report-image-actions" style="position: absolute; top: 8px; right: 8px; display: flex; gap: 4px; opacity: 0; transition: opacity 0.2s;">
                                <button onclick="event.stopPropagation(); replaceReportImageById('${uniqueId}')"
                                        style="padding: 6px 10px; background: rgba(139, 92, 246, 0.9); color: white; border: none; border-radius: 6px; font-size: 12px; cursor: pointer; backdrop-filter: blur(4px);"
                                        title="替换图片">🔄</button>
                                <button onclick="event.stopPropagation(); deleteReportImage('${uniqueId}')"
                                        style="padding: 6px 10px; background: rgba(239, 68, 68, 0.9); color: white; border: none; border-radius: 6px; font-size: 12px; cursor: pointer; backdrop-filter: blur(4px);"
                                        title="删除图片">🗑️</button>
                            </div>
                        `;

                        // 鼠标悬停显示操作按钮
                        imgDiv.addEventListener('mouseenter', () => {
                            const actions = imgDiv.querySelector('.report-image-actions');
                            if (actions) actions.style.opacity = '1';
                        });
                        imgDiv.addEventListener('mouseleave', () => {
                            const actions = imgDiv.querySelector('.report-image-actions');
                            if (actions) actions.style.opacity = '0';
                        });
                    };
                    reader.readAsDataURL(file);

                    imageGrid.appendChild(imgDiv);
                });

                // 初始化拖拽
                setTimeout(() => {
                    initImageDragSort(imageGrid);
                }, 100);
            };
            input.click();
        }

        // 替换报告中的图片（通过ID）
        function replaceReportImageById(imageId) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const img = document.getElementById(imageId);
                if (!img) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    img.src = event.target.result;
                    img.alt = file.name;
                    // 更新onclick事件
                    img.onclick = () => openReportImagePreview(event.target.result, file.name);
                };
                reader.readAsDataURL(file);
            };
            input.click();
        }

        // 删除报告中的图片
        function deleteReportImage(imageId) {
            if (!confirm('确定要删除这张图片吗？')) return;

            const img = document.getElementById(imageId);
            if (!img) return;

            // 找到父容器并删除
            const imgContainer = img.closest('.report-image-item-draggable');
            if (imgContainer) {
                imgContainer.remove();
            }
        }

        // 切换报告主题
        let reportTheme = 'light'; // 默认浅色主题
        function toggleReportTheme() {
            const modal = document.getElementById('reportModal');
            if (reportTheme === 'light') {
                modal.classList.add('dark-theme');
                reportTheme = 'dark';
            } else {
                modal.classList.remove('dark-theme');
                reportTheme = 'light';
            }
        }

        // 显示新增图片配置界面
        // 当前正在配置的section（goodcase 或 badcase）
        let currentConfigSection = 'goodcase';

        function showImageLayoutConfig(sectionType = 'goodcase') {
            currentConfigSection = sectionType;
            const config = document.getElementById('imageLayoutConfig');
            config.classList.add('active');
            config.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // 取消新增图片
        function cancelAddImageSection() {
            const config = document.getElementById('imageLayoutConfig');
            config.classList.remove('active');
        }

        // 确认新增图片区域
        function confirmAddImageSection() {
            const imagesPerRow = parseInt(document.getElementById('imagesPerRow').value) || 2;
            const numberOfRows = parseInt(document.getElementById('numberOfRows').value) || 1;

            // 验证输入
            if (imagesPerRow < 1 || imagesPerRow > 4) {
                Toast.warning('每行图片数必须在1-4之间', '输入错误');
                return;
            }
            if (numberOfRows < 1 || numberOfRows > 10) {
                Toast.warning('行数必须在1-10之间', '输入错误');
                return;
            }

            // 根据当前section确定容器
            const containerId = currentConfigSection === 'goodcase' ? 'goodcaseCustomSections' : 'badcaseCustomSections';
            const container = document.getElementById(containerId);
            if (!container) {
                console.error('未找到自定义图片容器:', containerId);
                Toast.error('未找到自定义图片容器', '错误');
                return;
            }

            const sectionId = `custom-section-${currentConfigSection}-${Date.now()}`;

            // 创建自定义图片区域
            const section = document.createElement('div');
            section.className = 'custom-image-section';
            section.id = sectionId;

            let sectionHTML = `
                <button class="custom-section-delete-btn" onclick="deleteImageSection('${sectionId}')" title="删除此区域">✕</button>
            `;

            // 生成多行图片网格
            for (let row = 0; row < numberOfRows; row++) {
                sectionHTML += `
                    <div class="custom-image-row" style="grid-template-columns: repeat(${imagesPerRow}, 1fr);">
                `;

                for (let col = 0; col < imagesPerRow; col++) {
                    const imageId = `${sectionId}-img-${row}-${col}`;
                    sectionHTML += `
                        <div class="custom-image-item" id="${imageId}" onclick="selectCustomImage('${imageId}')">
                            <div class="custom-image-placeholder">📷</div>
                        </div>
                    `;
                }

                sectionHTML += `</div>`;
            }

            section.innerHTML = sectionHTML;
            container.appendChild(section);

            // 隐藏配置界面
            cancelAddImageSection();

            // 滚动到新添加的区域
            section.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // 删除图片区域
        function deleteImageSection(sectionId) {
            if (confirm('确定要删除这个图片区域吗？')) {
                const section = document.getElementById(sectionId);
                if (section) {
                    section.remove();
                }
            }
        }

        // 选择并插入自定义图片
        async function selectCustomImage(imageId) {
            try {
                const [fileHandle] = await window.showOpenFilePicker({
                    types: [{
                        description: 'Images',
                        accept: {
                            'image/*': ['.png', '.jpg', '.jpeg', '.gif', '.webp', '.bmp']
                        }
                    }],
                    multiple: false
                });

                const file = await fileHandle.getFile();
                const imageUrl = URL.createObjectURL(file);

                const imageItem = document.getElementById(imageId);
                if (imageItem) {
                    imageItem.innerHTML = `
                        <img src="${imageUrl}" alt="${file.name}">
                        <div class="report-image-grid-replace-btn" onclick="event.stopPropagation(); selectCustomImage('${imageId}')" style="display: none; position: absolute; top: 8px; right: 8px; width: 32px; height: 32px; background: rgba(0, 0, 0, 0.7); border: 2px solid white; border-radius: 8px; color: white; font-size: 1rem; align-items: center; justify-content: center; z-index: 10; cursor: pointer;">
                            🔄
                        </div>
                    `;

                    // 添加悬停显示替换按钮
                    imageItem.onmouseenter = () => {
                        const btn = imageItem.querySelector('.report-image-grid-replace-btn');
                        if (btn) btn.style.display = 'flex';
                    };
                    imageItem.onmouseleave = () => {
                        const btn = imageItem.querySelector('.report-image-grid-replace-btn');
                        if (btn) btn.style.display = 'none';
                    };
                }
            } catch (err) {
                if (err.name !== 'AbortError') {
                    console.error('选择图片失败:', err);
                }
            }
        }

        // 打开帮助
        function openHelp() {
            const modal = document.getElementById('helpModal');
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        // 关闭帮助
        function closeHelp() {
            const modal = document.getElementById('helpModal');
            modal.classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        // 打开报告图片放大查看
        function openReportImageModal(imgId) {
            const img = document.getElementById(imgId);
            if (!img) return;

            const modal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');

            modalImage.src = img.src;
            modal.classList.add('active');

            // 等待图片加载完成后计算最佳初始缩放
            modalImage.onload = function() {
                const imgWidth = modalImage.naturalWidth;
                const imgHeight = modalImage.naturalHeight;
                const viewportWidth = window.innerWidth;
                const viewportHeight = window.innerHeight;

                // 计算图片宽高比
                const imgRatio = imgWidth / imgHeight;
                const viewportRatio = viewportWidth / viewportHeight;

                // 如果图片更宽（横向图片），让它优先填满宽度
                if (imgRatio > viewportRatio) {
                    // 横向图片，计算填满95%宽度所需的缩放
                    const targetWidth = viewportWidth * 0.95;
                    const naturalDisplayWidth = Math.min(imgWidth, viewportWidth * 0.95);
                    currentZoom = targetWidth / naturalDisplayWidth;
                } else {
                    // 纵向或方形图片，保持默认
                    currentZoom = 1;
                }

                currentX = 0;
                currentY = 0;
                updateTransform();
            };

            // 重置缩放和位置（图片加载前）
            currentZoom = 1;
            currentX = 0;
            currentY = 0;
            updateTransform();

            // 阻止body滚动
            document.body.style.overflow = 'hidden';
        }

        // 替换报告中的图片
        function replaceReportImage(imgId) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = document.getElementById(imgId);
                    if (img) {
                        img.src = event.target.result;
                    }
                };
                reader.readAsDataURL(file);
            };
            input.click();
        }

        // 导出文件分类列表
        function exportFileList() {
            // 统计数据
            const total = allImages.length;
            let liked = [], neutral = [], disliked = [], unrated = [];

            allImages.forEach(file => {
                const imageKey = `${file.name}_${file.size}`;
                const folderName = file.folderName || '';

                // 获取评分（根据评分模式）
                let rating = null;
                if (ratings[imageKey]) {
                    if (ratingMode === 'single') {
                        // 单一评分模式：使用主文件夹的评分
                        const targetFolderIndex = mainFolderIndex !== -1 ? mainFolderIndex : 0;
                        const targetFolderName = folders[targetFolderIndex] ? folders[targetFolderIndex].name : '';
                        rating = ratings[imageKey][targetFolderName];
                    } else {
                        // 多维评分模式：使用当前文件夹的评分
                        rating = ratings[imageKey][folderName];
                    }
                }

                if (rating === 'like') {
                    liked.push(file.name);
                } else if (rating === 'neutral') {
                    neutral.push(file.name);
                } else if (rating === 'dislike') {
                    disliked.push(file.name);
                } else {
                    unrated.push(file.name);
                }
            });

            // 生成文本格式报告
            let textContent = `图片评分分类报告
文件夹：${currentFolderName}
生成时间：${new Date().toLocaleString('zh-CN')}
总图片数：${total}

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📁 建议文件夹结构：

${currentFolderName}/
├── 👍 喜欢/ (${liked.length}张)
├── 😐 一般/ (${neutral.length}张)
└── 👎 不喜欢/ (${disliked.length}张)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

👍 喜欢的图片 (${liked.length}张)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
`;

            if (liked.length > 0) {
                liked.forEach((name, index) => {
                    textContent += `${index + 1}. ${name}\n`;
                });
            } else {
                textContent += '（无）\n';
            }

            textContent += `
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

😐 一般的图片 (${neutral.length}张)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
`;

            if (neutral.length > 0) {
                neutral.forEach((name, index) => {
                    textContent += `${index + 1}. ${name}\n`;
                });
            } else {
                textContent += '（无）\n';
            }

            textContent += `
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

👎 不喜欢的图片 (${disliked.length}张)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
`;

            if (disliked.length > 0) {
                disliked.forEach((name, index) => {
                    textContent += `${index + 1}. ${name}\n`;
                });
            } else {
                textContent += '（无）\n';
            }

            textContent += `
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📝 使用说明：

1. 在原文件夹中创建三个子文件夹：
   - "👍 喜欢" 或 "喜欢"
   - "😐 一般" 或 "一般"
   - "👎 不喜欢" 或 "不喜欢"

2. 根据上方列表，将对应的图片文件移动到相应文件夹中

3. 建议先复制文件而不是移动，以防万一需要恢复

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

生成工具：Lightbox - 专业影像甄选台
`;

            // 创建并下载文本文件
            const blob = new Blob([textContent], { type: 'text/plain;charset=utf-8' });
            const link = document.createElement('a');
            const fileName = `${currentFolderName}_文件分类列表_${new Date().toISOString().slice(0, 10)}.txt`;
            link.download = fileName;
            link.href = URL.createObjectURL(blob);
            link.click();
            URL.revokeObjectURL(link.href);

            // 同时生成JSON格式
            const jsonData = {
                folderName: currentFolderName,
                generatedAt: new Date().toISOString(),
                total: total,
                statistics: {
                    liked: liked.length,
                    neutral: neutral.length,
                    disliked: disliked.length,
                    unrated: unrated.length
                },
                categories: {
                    liked: liked,
                    neutral: neutral,
                    disliked: disliked,
                    unrated: unrated
                }
            };

            const jsonBlob = new Blob([JSON.stringify(jsonData, null, 2)], { type: 'application/json' });
            const jsonLink = document.createElement('a');
            const jsonFileName = `${currentFolderName}_文件分类数据_${new Date().toISOString().slice(0, 10)}.json`;
            jsonLink.download = jsonFileName;
            jsonLink.href = URL.createObjectURL(jsonBlob);
            jsonLink.click();
            URL.revokeObjectURL(jsonLink.href);

            Toast.success('已导出文件分类列表（TXT和JSON格式）\n请根据列表手动整理文件到对应文件夹', '导出成功', 5000);
        }

        // 导出为Confluence格式
        function exportToConfluence() {
            try {
                // 获取报告容器中的内容
                const reportContainer = document.getElementById('reportContainer');
                if (!reportContainer) {
                    Toast.error('无法找到报告内容', '导出失败');
                    return;
                }

                // 提取报告数据
                const folderName = reportContainer.querySelector('.report-folder-name')?.textContent || currentFolderName;
                const subtitle = reportContainer.querySelector('.report-subtitle')?.textContent || '';

                // 统计数据
                const total = allImages.length;
                let liked = [], neutral = [], disliked = [], unrated = [];

                allImages.forEach(file => {
                    const imageKey = `${file.name}_${file.size}`;
                    const folderName = file.folderName || '';

                    let rating = null;
                    if (ratings[imageKey]) {
                        if (ratingMode === 'single') {
                            const targetFolderIndex = mainFolderIndex !== -1 ? mainFolderIndex : 0;
                            const targetFolderName = folders[targetFolderIndex] ? folders[targetFolderIndex].name : '';
                            rating = ratings[imageKey][targetFolderName];
                        } else {
                            rating = ratings[imageKey][folderName];
                        }
                    }

                    if (rating === 'like') {
                        liked.push(file.name);
                    } else if (rating === 'neutral') {
                        neutral.push(file.name);
                    } else if (rating === 'dislike') {
                        disliked.push(file.name);
                    } else {
                        unrated.push(file.name);
                    }
                });

                const ratedTotal = liked.length + neutral.length + disliked.length;
                const goodcasePercent = ratedTotal > 0 ? Math.round((liked.length / ratedTotal) * 100) : 0;
                const badcasePercent = ratedTotal > 0 ? Math.round(((neutral.length + disliked.length) / ratedTotal) * 100) : 0;
                const likedPercent = ratedTotal > 0 ? Math.round((liked.length / ratedTotal) * 100) : 0;
                const neutralPercent = ratedTotal > 0 ? Math.round((neutral.length / ratedTotal) * 100) : 0;
                const dislikedPercent = ratedTotal > 0 ? Math.round((disliked.length / ratedTotal) * 100) : 0;
                const unratedPercent = total > 0 ? Math.round((unrated.length / total) * 100) : 0;

                // 生成Markdown格式的周报
                const today = new Date();
                const dateStr = `${today.getFullYear()}/${String(today.getMonth() + 1).padStart(2, '0')}/${String(today.getDate()).padStart(2, '0')}`;

                let mdContent = `# 📊【${folderName}】进度报告\n\n`;
                mdContent += `> **报告周期**: ${dateStr}\n`;
                mdContent += `> **评分数据**: 共 ${total} 张图片\n\n`;
                mdContent += `---\n\n`;

                // 整体通过率
                mdContent += `## 📈 整体通过率\n\n`;
                mdContent += `| 指标 | 通过率 | 说明 |\n`;
                mdContent += `|------|--------|------|\n`;
                mdContent += `| **GoodCase通过率** | ${goodcasePercent}% | 测试集数量：${liked.length}张 |\n`;
                mdContent += `| **BadCase占比** | ${badcasePercent}% | 问题数量：${neutral.length + disliked.length}张 |\n\n`;
                mdContent += `---\n\n`;

                // 1. 当前进度
                mdContent += `## 1️⃣ 当前进度\n\n`;
                mdContent += `**阶段**: <mark>数据阶段 / 效果迭代阶段 / 客户端验收阶段 / 待上线</mark>\n\n`;
                mdContent += `**项目状态**:\n`;
                mdContent += `- 当前版本: vX.X\n`;
                mdContent += `- 完成情况: XX%\n`;
                mdContent += `- 预计交付: ${dateStr}\n\n`;
                mdContent += `---\n\n`;

                // 2. 研发中的效果进展
                mdContent += `## 2️⃣ 研发中的效果进展\n\n`;

                // GoodCase
                mdContent += `### ✅ GoodCase 展示\n\n`;
                mdContent += `> 如前几周已展示且差异不大可省略\n\n`;
                if (liked.length > 0) {
                    mdContent += `**通过率**: ${goodcasePercent}% (${liked.length}/${ratedTotal}张)\n\n`;
                    mdContent += `#### 案例1: [场景名称]\n`;
                    mdContent += `- **优化内容**: 简述本次优化的功能点\n`;
                    mdContent += `- **效果展示**:\n\n`;
                    mdContent += `| 原图 | 结果图 |\n`;
                    mdContent += `|------|--------|\n`;
                    mdContent += `| ![原图](path/to/image.jpg) | ![结果图](path/to/result.jpg) |\n\n`;
                    mdContent += `**说明**: 描述优化效果\n\n`;
                } else {
                    mdContent += `暂无GoodCase数据\n\n`;
                }
                mdContent += `---\n\n`;

                // BadCase
                mdContent += `### ❌ BadCase & 下一步计划\n\n`;
                if (neutral.length > 0 || disliked.length > 0) {
                    mdContent += `**Badcase占比**: ${badcasePercent}% (${neutral.length + disliked.length}/${ratedTotal}张)\n`;
                    mdContent += `- **一般**: ${neutralPercent}% (${neutral.length}张)\n`;
                    mdContent += `- **不喜欢**: ${dislikedPercent}% (${disliked.length}张)\n\n`;

                    mdContent += `#### 🔴 P0 问题（影响上线）\n\n`;
                    mdContent += `##### 问题1: [问题简述]\n`;
                    mdContent += `- **问题描述**: 详细描述问题现象\n`;
                    mdContent += `- **影响范围**: 占比XX%，影响XXX场景\n`;
                    mdContent += `- **对比展示**:\n\n`;
                    mdContent += `| 原图 | 当前结果（有问题） | 期望效果 |\n`;
                    mdContent += `|------|-------------------|----------|\n`;
                    mdContent += `| ![原图](path/to/image.jpg) | ![问题图](path/to/bad.jpg) | ![期望图](path/to/expected.jpg) |\n\n`;
                    mdContent += `**问题分析**:\n`;
                    mdContent += `- 具体问题点：\n`;
                    mdContent += `- 可能原因：\n\n`;
                    mdContent += `**下一步计划**:\n`;
                    mdContent += `- [ ] 调整XXX参数\n`;
                    mdContent += `- [ ] 优化XXX算法\n`;
                    mdContent += `- [ ] 预计完成时间：${dateStr}\n\n`;
                    mdContent += `---\n\n`;

                    mdContent += `#### ⚠️ 当前卡点\n`;
                    mdContent += `1. **卡点1**: 描述卡点内容\n`;
                    mdContent += `   - **影响**: 说明影响范围\n`;
                    mdContent += `   - **解决方案**: 说明计划如何解决\n\n`;
                } else {
                    mdContent += `暂无BadCase数据\n\n`;
                }
                mdContent += `---\n\n`;

                // 3. 性能情况
                mdContent += `## 3️⃣ 性能情况\n\n`;
                mdContent += `| 指标 | 当前值 | 目标值 | 说明 |\n`;
                mdContent += `|------|--------|--------|------|\n`;
                mdContent += `| **处理速度** | XXms/张 | XXms/张 | 测试设备：XXX |\n`;
                mdContent += `| **内存占用** | XXX MB | XXX MB | 峰值内存 |\n\n`;
                mdContent += `**性能优化进展**:\n`;
                mdContent += `- ✅ 已完成：XXX优化\n`;
                mdContent += `- 🔄 进行中：XXX优化\n\n`;
                mdContent += `---\n\n`;

                // 4. 竞品对比
                mdContent += `## 4️⃣ 竞品对比\n\n`;
                mdContent += `### 竞品A\n\n`;
                mdContent += `| 对比维度 | 我们 | 竞品A | 差异说明 |\n`;
                mdContent += `|---------|------|-------|---------||\n`;
                mdContent += `| **整体效果** | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | 说明差异 |\n\n`;
                mdContent += `**优势**:\n`;
                mdContent += `- ✅ XXX方面表现更好\n\n`;
                mdContent += `**待提升**:\n`;
                mdContent += `- ⚠️ XXX方面仍有差距\n\n`;
                mdContent += `---\n\n`;

                // 提取自定义文本块
                const customTextBlocks = reportContainer.querySelectorAll('.custom-text-block');
                if (customTextBlocks.length > 0) {
                    mdContent += `## 📝 补充说明\n\n`;
                    customTextBlocks.forEach((block) => {
                        const title = block.querySelector('.custom-text-title')?.textContent.trim();
                        const content = block.querySelector('.custom-text-content')?.textContent.trim();
                        if (title || content) {
                            if (title) {
                                mdContent += `### ${title}\n\n`;
                            }
                            if (content) {
                                mdContent += `${content}\n\n`;
                            }
                        }
                    });
                    mdContent += `---\n\n`;
                }

                // 下周计划
                mdContent += `## 📋 下周计划\n\n`;
                mdContent += `- [ ] P0问题解决：XXX\n`;
                mdContent += `- [ ] 优化方向：XXX\n`;
                mdContent += `- [ ] 测试验证：XXX\n\n`;
                mdContent += `---\n\n`;

                // 统计数据
                mdContent += `## 📊 数据统计\n\n`;
                mdContent += `- **总图片数**: ${total}张\n`;
                mdContent += `- **已评分**: ${ratedTotal}张 (${Math.round(ratedTotal/total*100)}%)\n`;
                mdContent += `- **未评分**: ${unrated.length}张\n`;
                mdContent += `- **生成时间**: ${new Date().toLocaleString('zh-CN')}\n`;
                mdContent += `- **生成工具**: Lightbox - 专业影像甄选台\n`;

                // 下载MD文件
                const blob = new Blob([mdContent], { type: 'text/markdown;charset=utf-8' });
                const link = document.createElement('a');
                const fileName = `📊【${folderName}】项目进度报告_${today.getFullYear()}${String(today.getMonth() + 1).padStart(2, '0')}${String(today.getDate()).padStart(2, '0')}.md`;
                link.download = fileName;
                link.href = URL.createObjectURL(blob);
                link.click();
                URL.revokeObjectURL(link.href);

                Toast.success('周报MD文件已下载\n可上传到Confluence或直接编辑', '导出成功', 3000);

            } catch (error) {
                console.error('导出Confluence格式时出错:', error);
                Toast.error('导出失败: ' + error.message, '错误');
            }
        }

        // 导出评分图片到文件夹（ZIP格式）
        async function exportRatedImages() {
            try {
                // 检查是否有图片
                if (!allImages || allImages.length === 0) {
                    Toast.warning('请先加载图片', '提示');
                    return;
                }

                // 检查JSZip是否加载
                if (typeof JSZip === 'undefined') {
                    Toast.error('ZIP库未加载，请刷新页面重试', '错误');
                    return;
                }

                // 显示进度提示
                const progressDiv = document.createElement('div');
                progressDiv.id = 'exportProgress';
                progressDiv.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: rgba(10, 10, 31, 0.95);
                    color: white;
                    padding: 40px 60px;
                    border-radius: 12px;
                    z-index: 999999;
                    text-align: center;
                    box-shadow: 0 8px 32px rgba(139, 92, 246, 0.4);
                    border: 2px solid rgba(139, 92, 246, 0.3);
                `;
                progressDiv.innerHTML = `
                    <div style="font-size: 48px; margin-bottom: 20px;">📦</div>
                    <div style="font-size: 20px; font-weight: 600; margin-bottom: 12px;">正在打包图片...</div>
                    <div id="exportProgressText" style="font-size: 14px; color: #a78bfa;">准备中...</div>
                `;
                document.body.appendChild(progressDiv);

                const updateProgress = (text) => {
                    const progressText = document.getElementById('exportProgressText');
                    if (progressText) progressText.textContent = text;
                };

                // 分类图片
                const likedFiles = [];
                const neutralFiles = [];
                const dislikedFiles = [];

                updateProgress('正在分类图片...');

                allImages.forEach(file => {
                    const imageKey = `${file.name}_${file.size}`;
                    const folderName = file.folderName || (folders.length > 0 ? folders[0].name : '');

                    // 获取评分
                    let ratingData = null;
                    if (ratings[imageKey]) {
                        if (ratingMode === 'single') {
                            const targetFolderIndex = mainFolderIndex !== -1 ? mainFolderIndex : 0;
                            const targetFolderName = folders[targetFolderIndex] ? folders[targetFolderIndex].name : '';
                            ratingData = ratings[imageKey][targetFolderName];
                        } else {
                            ratingData = ratings[imageKey][folderName];
                        }
                    }

                    const rating = typeof ratingData === 'string' ? ratingData : (ratingData?.rating || null);

                    if (rating === 'like') {
                        likedFiles.push(file);
                    } else if (rating === 'neutral') {
                        neutralFiles.push(file);
                    } else if (rating === 'dislike') {
                        dislikedFiles.push(file);
                    }
                });

                // 检查是否有评分的图片
                const totalRated = likedFiles.length + neutralFiles.length + dislikedFiles.length;
                if (totalRated === 0) {
                    document.body.removeChild(progressDiv);
                    Toast.info('没有已评分的图片\n请先对图片进行评分（喜欢/一般/不喜欢）', '提示');
                    return;
                }

                // 创建ZIP
                updateProgress(`找到 ${totalRated} 张已评分图片，正在创建ZIP...`);
                const zip = new JSZip();

                // 添加文件到ZIP的辅助函数
                const addFilesToZip = async (files, folderName, progressPrefix) => {
                    if (files.length === 0) return;

                    const folder = zip.folder(folderName);

                    for (let i = 0; i < files.length; i++) {
                        const file = files[i];
                        updateProgress(`${progressPrefix} ${i + 1}/${files.length}: ${file.name}`);

                        // 检查缓存
                        const imageKey = `${file.name}_${file.size}`;
                        let blob;

                        if (imageCache[imageKey]) {
                            // 从缓存的base64转换为blob
                            const response = await fetch(imageCache[imageKey]);
                            blob = await response.blob();
                        } else {
                            // 直接使用原始文件
                            blob = file;
                        }

                        folder.file(file.name, blob);
                    }
                };

                // 添加喜欢的图片
                if (likedFiles.length > 0) {
                    await addFilesToZip(likedFiles, '1-喜欢 Like', '打包喜欢的图片');
                }

                // 添加一般的图片
                if (neutralFiles.length > 0) {
                    await addFilesToZip(neutralFiles, '2-一般 Neutral', '打包一般的图片');
                }

                // 添加不喜欢的图片
                if (dislikedFiles.length > 0) {
                    await addFilesToZip(dislikedFiles, '3-不喜欢 Dislike', '打包不喜欢的图片');
                }

                // 生成ZIP文件
                updateProgress('正在生成ZIP文件...');
                const content = await zip.generateAsync({
                    type: 'blob',
                    compression: 'DEFLATE',
                    compressionOptions: { level: 6 }
                }, (metadata) => {
                    const percent = metadata.percent.toFixed(0);
                    updateProgress(`压缩中... ${percent}%`);
                });

                // 下载ZIP文件
                updateProgress('准备下载...');
                const zipFileName = `${currentFolderName || '图片评分'}_分类导出_${new Date().toISOString().slice(0, 10).replace(/-/g, '')}.zip`;
                const link = document.createElement('a');
                link.download = zipFileName;
                link.href = URL.createObjectURL(content);
                link.click();
                URL.revokeObjectURL(link.href);

                // 移除进度提示
                document.body.removeChild(progressDiv);

                // 显示成功消息
                Toast.success(`导出成功！文件名：${zipFileName}\n喜欢：${likedFiles.length}张 | 一般：${neutralFiles.length}张 | 不喜欢：${dislikedFiles.length}张\n总计：${totalRated}张图片`, '导出成功', 6000);

            } catch (error) {
                console.error('导出文件夹时出错:', error);
                const progressDiv = document.getElementById('exportProgress');
                if (progressDiv) {
                    document.body.removeChild(progressDiv);
                }
                Toast.error('导出失败：' + error.message + '\n请检查浏览器控制台获取详情', '导出失败', 6000);
            }
        }

        // ==================== 文件夹选择模态框功能 ====================

        // 记录勾选顺序的计数器
        let checkOrder = 0;

        // 打开文件夹选择模态框
        function openFolderSelectModal() {
            const modal = document.getElementById('folderSelectModal');
            const list = document.getElementById('folderSelectList');
            const selectAllCheckbox = document.getElementById('selectAllFolders');

            // 清空列表
            list.innerHTML = '';
            selectAllCheckbox.checked = false;
            checkOrder = 0; // 重置勾选顺序计数器

            // 生成文件夹列表
            pendingFolders.forEach((folder, index) => {
                const item = document.createElement('div');
                item.className = 'folder-select-item';
                item.onclick = function(e) {
                    if (e.target.type !== 'checkbox') {
                        const checkbox = this.querySelector('.folder-select-checkbox');
                        checkbox.checked = !checkbox.checked;

                        // 记录勾选顺序
                        if (checkbox.checked) {
                            checkbox.dataset.order = ++checkOrder;
                        } else {
                            delete checkbox.dataset.order;
                        }

                        updateFolderSelectItem(this, checkbox.checked);
                        updateConfirmButton();
                    }
                };

                item.innerHTML = `
                    <input type="checkbox" class="folder-select-checkbox" id="folder_${index}"
                           onchange="if(this.checked) { this.dataset.order = ++checkOrder; } else { delete this.dataset.order; } updateFolderSelectItem(this.parentElement, this.checked); updateConfirmButton();">
                    <div class="folder-select-info">
                        <div class="folder-select-name" title="${folder.name}">${folder.name}</div>
                        <div class="folder-select-count">${folder.images.length} 张图片</div>
                    </div>
                `;

                list.appendChild(item);
            });

            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
            updateConfirmButton();
        }

        // 关闭文件夹选择模态框
        function closeFolderSelectModal() {
            const modal = document.getElementById('folderSelectModal');
            modal.classList.remove('active');
            document.body.style.overflow = 'auto';
            pendingFolders = [];
        }

        // 更新文件夹选择项的样式
        function updateFolderSelectItem(item, checked) {
            if (checked) {
                item.classList.add('selected');
            } else {
                item.classList.remove('selected');
            }
        }

        // 切换全选
        function toggleSelectAllFolders(checked) {
            const checkboxes = document.querySelectorAll('.folder-select-checkbox');
            const items = document.querySelectorAll('.folder-select-item');

            checkboxes.forEach((checkbox, index) => {
                checkbox.checked = checked;
                updateFolderSelectItem(items[index], checked);
            });

            updateConfirmButton();
        }

        // 更新确认按钮状态
        function updateConfirmButton() {
            const checkboxes = document.querySelectorAll('.folder-select-checkbox');
            const selectedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
            const confirmBtn = document.getElementById('confirmFolderSelectBtn');

            if (selectedCount > 0) {
                confirmBtn.disabled = false;
                confirmBtn.textContent = `添加选中的 ${selectedCount} 个文件夹`;
            } else {
                confirmBtn.disabled = true;
                confirmBtn.textContent = '请至少选择一个文件夹';
            }
        }

        // 确认选择文件夹
        function confirmFolderSelection() {
            const checkboxes = document.querySelectorAll('.folder-select-checkbox');
            let addedCount = 0;

            // 收集已选中的文件夹，并按照勾选顺序排序
            const selectedFolders = [];
            checkboxes.forEach((checkbox, index) => {
                if (checkbox.checked) {
                    const folder = pendingFolders[index];
                    const order = parseInt(checkbox.dataset.order || '0');
                    selectedFolders.push({ folder, order });
                }
            });

            // 按照勾选顺序排序
            selectedFolders.sort((a, b) => a.order - b.order);

            // 按顺序添加文件夹
            selectedFolders.forEach(({ folder }) => {
                // 检查是否已经添加过该文件夹
                if (folders.some(f => f.name === folder.name)) {
                    console.log(`文件夹"${folder.name}"已存在，跳过`);
                    return;
                }

                folders.push({
                    name: folder.name,
                    fullPath: folder.fullPath,
                    files: folder.files,
                    images: folder.images
                });

                addedCount++;
                console.log(`已添加文件夹: ${folder.name} (${folder.images.length} 张图片)`);
            });

            // 更新文件夹列表显示
            updateFolderList();

            // 关闭模态框
            closeFolderSelectModal();

            // 显示成功消息
            if (addedCount > 0) {
                Toast.success(`成功添加 ${addedCount} 个文件夹`, '添加成功');
            }

            // 批量添加后，快速添加模式下继续
            if (isQuickAddMode) {
                setTimeout(() => {
                    document.getElementById('folderInput').click();
                }, 100);
            }
        }

        // ==================== 快速连续添加模式 ====================

        // 启动/关闭快速添加模式
        function quickAddMode() {
            isQuickAddMode = !isQuickAddMode;
            const btn = document.getElementById('quickAddBtn');

            if (isQuickAddMode) {
                btn.textContent = '⏸️ 结束连续添加';
                btn.classList.remove('btn-quick-add');
                btn.classList.add('btn-clear-folders');

                Toast.info('快速连续添加模式已启动\n每次选择后会自动弹出下一次选择\n点击"结束连续添加"按钮退出', '快速添加模式', 5000);

                // 自动触发第一次选择
                setTimeout(() => {
                    document.getElementById('folderInput').click();
                }, 100);
            } else {
                btn.textContent = '⚡ 快速连续添加';
                btn.classList.remove('btn-clear-folders');
                btn.classList.add('btn-quick-add');
            }
        }

        // 监听文件选择对话框的取消操作
        let lastInputChangeTime = 0;
        document.getElementById('folderInput').addEventListener('cancel', function() {
            if (isQuickAddMode) {
                isQuickAddMode = false;
                const btn = document.getElementById('quickAddBtn');
                btn.textContent = '⚡ 快速连续添加';
                btn.classList.remove('btn-clear-folders');
                btn.classList.add('btn-quick-add');
            }
        });

        // ==================== 截图功能 ====================

        // 截取当前页面显示的图片区域
        async function takeScreenshot() {
            const gallery = document.getElementById('gallery');

            if (!gallery || gallery.children.length === 0) {
                Toast.warning('请先加载图片后再截图', '提示');
                return;
            }

            try {
                // 显示加载提示
                const loadingMsg = document.createElement('div');
                loadingMsg.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: rgba(0, 0, 0, 0.8);
                    color: white;
                    padding: 20px 40px;
                    border-radius: 10px;
                    font-size: 1.2rem;
                    z-index: 10000;
                `;
                loadingMsg.textContent = '正在生成截图...';
                document.body.appendChild(loadingMsg);

                // 获取所有图片卡片
                const cards = gallery.querySelectorAll('.image-card');
                const cardCount = cards.length;

                // 计算画布尺寸（根据卡片数量自适应布局）
                const cols = cardCount >= 3 ? 3 : cardCount; // 最多3列
                const rows = Math.ceil(cardCount / cols);

                const cardWidth = 600;  // 每张卡片的宽度
                const cardHeight = 700; // 每张卡片的高度（包括标题）
                const gap = 20; // 卡片间距
                const padding = 40; // 边距

                const canvasWidth = cols * cardWidth + (cols - 1) * gap + padding * 2;
                const canvasHeight = rows * cardHeight + (rows - 1) * gap + padding * 2;

                // 创建画布
                const canvas = document.createElement('canvas');
                canvas.width = canvasWidth;
                canvas.height = canvasHeight;
                const ctx = canvas.getContext('2d');

                // 设置背景色
                ctx.fillStyle = '#fafafa';
                ctx.fillRect(0, 0, canvasWidth, canvasHeight);

                // 绘制每张图片卡片
                let cardsProcessed = 0;
                for (let i = 0; i < cardCount; i++) {
                    const card = cards[i];
                    const img = card.querySelector('img');
                    const imageName = card.querySelector('.image-name');
                    const folderTag = card.querySelector('.folder-tag');

                    const col = i % cols;
                    const row = Math.floor(i / cols);
                    const x = padding + col * (cardWidth + gap);
                    const y = padding + row * (cardHeight + gap);

                    // 绘制卡片背景
                    ctx.fillStyle = '#ffffff';
                    ctx.shadowColor = 'rgba(0, 0, 0, 0.1)';
                    ctx.shadowBlur = 10;
                    ctx.shadowOffsetX = 0;
                    ctx.shadowOffsetY = 2;
                    roundRect(ctx, x, y, cardWidth, cardHeight, 12);
                    ctx.fill();
                    ctx.shadowBlur = 0;

                    // 绘制图片（如果存在）
                    if (img && img.src) {
                        await new Promise((resolve) => {
                            const tempImg = new Image();
                            tempImg.crossOrigin = 'anonymous';
                            tempImg.onload = () => {
                                // 图片区域
                                const imgAreaHeight = cardHeight - 80;
                                const imgX = x + 10;
                                const imgY = y + 10;
                                const imgWidth = cardWidth - 20;
                                const imgHeight = imgAreaHeight - 20;

                                // 计算图片缩放比例（保持比例，完整显示）
                                const scale = Math.min(imgWidth / tempImg.width, imgHeight / tempImg.height);
                                const scaledWidth = tempImg.width * scale;
                                const scaledHeight = tempImg.height * scale;

                                // 居中绘制
                                const drawX = imgX + (imgWidth - scaledWidth) / 2;
                                const drawY = imgY + (imgHeight - scaledHeight) / 2;

                                ctx.drawImage(tempImg, drawX, drawY, scaledWidth, scaledHeight);
                                resolve();
                            };
                            tempImg.onerror = () => resolve(); // 图片加载失败也继续
                            tempImg.src = img.src;
                        });
                    }

                    // 绘制文件夹标签（如果存在）
                    if (folderTag) {
                        ctx.fillStyle = '#8b5cf6';
                        ctx.font = 'bold 14px -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif';
                        const tagText = folderTag.textContent;
                        const tagWidth = ctx.measureText(tagText).width + 20;
                        roundRect(ctx, x + 10, y + 10, tagWidth, 28, 6);
                        ctx.fill();
                        ctx.fillStyle = '#ffffff';
                        ctx.fillText(tagText, x + 20, y + 28);
                    }

                    // 绘制图片名称
                    if (imageName) {
                        ctx.fillStyle = '#374151';
                        ctx.font = '14px -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif';
                        const nameText = imageName.textContent;
                        const maxWidth = cardWidth - 40;

                        // 文本过长时截断
                        let displayText = nameText;
                        if (ctx.measureText(displayText).width > maxWidth) {
                            while (ctx.measureText(displayText + '...').width > maxWidth && displayText.length > 0) {
                                displayText = displayText.slice(0, -1);
                            }
                            displayText += '...';
                        }

                        ctx.fillText(displayText, x + 20, y + cardHeight - 30);
                    }

                    cardsProcessed++;
                }

                // 移除加载提示
                document.body.removeChild(loadingMsg);

                // 转换为blob并下载
                canvas.toBlob((blob) => {
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');

                    // 生成文件名（包含日期时间）
                    const now = new Date();
                    const timestamp = now.toISOString().replace(/[:.]/g, '-').slice(0, -5);
                    const folderInfo = folders.length > 1 ? `多文件夹对比_${folders.length}个` : '单文件夹';
                    link.download = `图片对比_${folderInfo}_${timestamp}.png`;

                    link.href = url;
                    link.click();

                    // 清理URL对象
                    setTimeout(() => URL.revokeObjectURL(url), 100);

                    // 显示成功提示
                    const successMsg = document.createElement('div');
                    successMsg.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
                        color: white;
                        padding: 15px 25px;
                        border-radius: 8px;
                        font-size: 1rem;
                        z-index: 10000;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                    `;
                    successMsg.textContent = '✅ 截图已保存！';
                    document.body.appendChild(successMsg);

                    setTimeout(() => {
                        document.body.removeChild(successMsg);
                    }, 3000);
                }, 'image/png');

            } catch (error) {
                console.error('截图失败:', error);
                Toast.error('截图失败：' + error.message, '截图失败');
            }
        }

        // 辅助函数：绘制圆角矩形
        function roundRect(ctx, x, y, width, height, radius) {
            ctx.beginPath();
            ctx.moveTo(x + radius, y);
            ctx.lineTo(x + width - radius, y);
            ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
            ctx.lineTo(x + width, y + height - radius);
            ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
            ctx.lineTo(x + radius, y + height);
            ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
            ctx.lineTo(x, y + radius);
            ctx.quadraticCurveTo(x, y, x + radius, y);
            ctx.closePath();
        }

        // 轮换对比图片顺序（Q键功能 - 临时调整顺序）
        function cycleCompareImages() {
            if (compareImages.length <= 1) return; // 只有一张图片或没有图片时不需要轮换

            // 第一次按Q键时，保存原始对比图片顺序
            if (!originalCompareImages) {
                originalCompareImages = [...compareImages];
            }

            // 把第一张图片移到最后（从前往后轮换）
            const firstImage = compareImages.shift();
            compareImages.push(firstImage);

            // 重建compareSelection
            compareSelection.clear();
            compareImages.forEach(img => {
                const imageKey = `${img.file.name}_${img.file.size}`;
                compareSelection.add(imageKey);
            });

            // 重新打开对比模态框以刷新显示
            openCompareModal();
        }

        // 恢复原始对比图片（松开Q键时调用）
        function restoreOriginalCompareImages() {
            if (!originalCompareImages || originalCompareImages.length === 0) return;

            // 恢复原始对比图片
            compareImages = [...originalCompareImages];

            // 重建compareSelection
            compareSelection.clear();
            compareImages.forEach(img => {
                const imageKey = `${img.file.name}_${img.file.size}`;
                compareSelection.add(imageKey);
            });

            // 清空原始对比图片的保存
            originalCompareImages = null;

            // 重新打开对比模态框以刷新显示
            if (compareImages.length > 0) {
                openCompareModal();
            }
        }

        // 轮换文件夹顺序（多文件夹模式下的Q键功能）
        function cycleFoldersOrder() {
            if (folders.length <= 1) return; // 只有一个文件夹或没有文件夹时不需要轮换

            // 第一次按Q键时，保存原始文件夹顺序
            if (!originalFoldersOrder) {
                originalFoldersOrder = [...folders];
            }

            // 把第一个文件夹移到最后（从前往后轮换）
            const firstFolder = folders.shift();
            folders.push(firstFolder);

            // 重新显示图片
            displayImages();
            updateFolderList();
        }

        // 恢复原始文件夹顺序（松开Q键时调用）
        function restoreOriginalFoldersOrder() {
            if (!originalFoldersOrder || originalFoldersOrder.length === 0) return;

            // 恢复原始文件夹顺序
            folders = [...originalFoldersOrder];

            // 清空原始文件夹顺序的保存
            originalFoldersOrder = null;

            // 重新显示图片
            displayImages();
            updateFolderList();
        }

        // 全局键盘快捷键
        document.addEventListener('keydown', (e) => {
            // 检查是否在输入框中
            const isInputFocused = document.activeElement.tagName === 'INPUT' ||
                                  document.activeElement.tagName === 'TEXTAREA' ||
                                  document.activeElement.isContentEditable;

            // 如果在输入框中，不处理快捷键
            if (isInputFocused) return;

            const compareModal = document.getElementById('compareModal');
            const isCompareModalOpen = compareModal && compareModal.classList.contains('active');

            // 空格键：下一页/组
            if (e.key === ' ' || e.code === 'Space') {
                e.preventDefault(); // 防止页面滚动
                if (!isCompareModalOpen) {
                    nextPage();
                }
                return;
            }

            // A键：上一页/组
            if (e.key === 'a' || e.key === 'A') {
                e.preventDefault();
                if (!isCompareModalOpen) {
                    prevPage();
                }
                return;
            }

            // S键：截图保存
            if (e.key === 's' || e.key === 'S') {
                e.preventDefault();
                takeScreenshot();
                return;
            }

            // Q键：轮换顺序（按住预览）
            if (e.key === 'q' || e.key === 'Q') {
                e.preventDefault();
                if (!isQKeyPressed) {
                    isQKeyPressed = true;
                    if (isCompareModalOpen) {
                        // 在对比模态框中：轮换对比图片顺序
                        cycleCompareImages();
                    } else if (folders.length > 1) {
                        // 在主页面的多文件夹模式：轮换文件夹顺序
                        cycleFoldersOrder();
                    }
                }
                return;
            }

            // Ctrl/Cmd键：在对比模式下临时切换到独立缩放
            if ((e.ctrlKey || e.metaKey) && !isCtrlCmdPressed) {
                isCtrlCmdPressed = true;
                if (isCompareModalOpen && compareZoomMode === 'sync' && !manualIndividualMode) {
                    compareZoomMode = 'individual';
                    updateCompareModeIndicator();
                }
            }
        });

        // 监听键盘松开事件（用于Q键恢复原始顺序和Ctrl/Cmd键恢复同步模式）
        document.addEventListener('keyup', (e) => {
            // Q键松开：恢复原始顺序
            if (e.key === 'q' || e.key === 'Q') {
                if (isQKeyPressed) {
                    isQKeyPressed = false;
                    const compareModal = document.getElementById('compareModal');
                    const isCompareModalOpen = compareModal && compareModal.classList.contains('active');

                    if (isCompareModalOpen) {
                        // 恢复对比图片顺序
                        restoreOriginalCompareImages();
                    } else if (originalFoldersOrder) {
                        // 恢复文件夹顺序
                        restoreOriginalFoldersOrder();
                    }
                }
                return;
            }

            // Ctrl/Cmd键松开：恢复同步缩放模式
            if ((e.key === 'Control' || e.key === 'Meta') && isCtrlCmdPressed) {
                isCtrlCmdPressed = false;
                const compareModal = document.getElementById('compareModal');
                const isCompareModalOpen = compareModal && compareModal.classList.contains('active');

                if (isCompareModalOpen && !manualIndividualMode) {
                    compareZoomMode = 'sync';
                    compareFocusedImage = null;
                    updateCompareModeIndicator();
                    // 移除所有聚焦样式
                    document.querySelectorAll('.compare-image-wrapper').forEach(w => {
                        w.classList.remove('focused');
                    });
                }
                return;
            }
        });

        // ESC键关闭模态框
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                // 关闭帮助模态框
                const helpModal = document.getElementById('helpModal');
                if (helpModal.classList.contains('active')) {
                    closeHelp();
                    return;
                }

                // 关闭文件夹选择模态框
                const folderSelectModal = document.getElementById('folderSelectModal');
                if (folderSelectModal.classList.contains('active')) {
                    closeFolderSelectModal();
                }
            }
        });

        // ==================== 报告编辑功能 ====================
        let isDragModeActive = false;
        let draggedElement = null;

        // 添加文本块
        function addTextBlock() {
            try {
                const container = document.getElementById('reportContainer');
                if (!container) {
                    console.error('reportContainer 未找到');
                    alert('无法添加文本块：报告容器未找到');
                    return;
                }

                const textBlock = document.createElement('div');
                textBlock.className = 'draggable-block';
                textBlock.draggable = false;
                textBlock.innerHTML = `
                    <button class="delete-btn" onclick="deleteBlock(this)">🗑️ 删除</button>
                    <span class="drag-handle">⋮⋮</span>
                    <div class="custom-text-block">
                        <div class="custom-text-title" contenteditable="true"></div>
                        <div class="custom-text-content" contenteditable="true"></div>
                    </div>
                `;
                container.appendChild(textBlock);

                // 滚动到新添加的元素
                setTimeout(() => {
                    textBlock.scrollIntoView({ behavior: 'smooth', block: 'center' });

                    // 聚焦到标题编辑区
                    const titleDiv = textBlock.querySelector('.custom-text-title');
                    if (titleDiv) {
                        titleDiv.focus();
                    }
                }, 100);
            } catch (error) {
                console.error('添加文本块时出错:', error);
                alert('添加文本块失败: ' + error.message);
            }
        }

        // 添加图片块
        function addImageBlock() {
            try {
                const container = document.getElementById('reportContainer');
                if (!container) {
                    console.error('reportContainer 未找到');
                    alert('无法添加图片：报告容器未找到');
                    return;
                }

                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.multiple = true;

                input.onchange = function(e) {
                    const files = Array.from(e.target.files);

                    files.forEach(file => {
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            const imageBlock = document.createElement('div');
                            imageBlock.className = 'draggable-block';
                            imageBlock.draggable = false;
                            imageBlock.innerHTML = `
                                <button class="delete-btn" onclick="deleteBlock(this)">🗑️ 删除</button>
                                <span class="drag-handle">⋮⋮</span>
                                <div class="custom-image-block">
                                    <img src="${event.target.result}" alt="${file.name}">
                                </div>
                                <div class="custom-text-block" contenteditable="true" style="margin-top: 12px; min-height: 40px;">
                                    ${file.name}
                                </div>
                            `;
                            container.appendChild(imageBlock);

                            // 滚动到新添加的图片
                            setTimeout(() => {
                                imageBlock.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            }, 100);
                        };
                        reader.readAsDataURL(file);
                    });
                };

                input.click();
            } catch (error) {
                console.error('添加图片块时出错:', error);
                alert('添加图片失败: ' + error.message);
            }
        }

        // 切换拖拽模式
        function toggleDragMode() {
            isDragModeActive = !isDragModeActive;
            const btn = document.getElementById('dragModeBtn');
            const container = document.getElementById('reportContainer');

            if (isDragModeActive) {
                btn.classList.add('active');
                container.classList.add('drag-mode');
                enableDragMode();
            } else {
                btn.classList.remove('active');
                container.classList.remove('drag-mode');
                disableDragMode();
            }
        }

        // 启用拖拽模式
        function enableDragMode() {
            const blocks = document.querySelectorAll('.draggable-block');
            blocks.forEach(block => {
                block.draggable = true;
                block.classList.add('drag-mode');

                block.addEventListener('dragstart', handleDragStart);
                block.addEventListener('dragend', handleDragEnd);
                block.addEventListener('dragover', handleDragOver);
                block.addEventListener('drop', handleDrop);
            });
        }

        // 禁用拖拽模式
        function disableDragMode() {
            const blocks = document.querySelectorAll('.draggable-block');
            blocks.forEach(block => {
                block.draggable = false;
                block.classList.remove('drag-mode');

                block.removeEventListener('dragstart', handleDragStart);
                block.removeEventListener('dragend', handleDragEnd);
                block.removeEventListener('dragover', handleDragOver);
                block.removeEventListener('drop', handleDrop);
            });
        }

        // 拖拽开始
        function handleDragStart(e) {
            if (!e.dataTransfer) return;
            draggedElement = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
        }

        // 拖拽结束
        function handleDragEnd(e) {
            this.classList.remove('dragging');

            // 移除所有 over 类
            document.querySelectorAll('.draggable-block').forEach(block => {
                block.classList.remove('drag-over');
            });
        }

        // 拖拽经过
        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';

            if (this !== draggedElement) {
                this.classList.add('drag-over');
            }

            return false;
        }

        // 放下
        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }

            if (draggedElement !== this) {
                const parent = this.parentNode;
                const draggedIndex = Array.from(parent.children).indexOf(draggedElement);
                const targetIndex = Array.from(parent.children).indexOf(this);

                if (draggedIndex < targetIndex) {
                    parent.insertBefore(draggedElement, this.nextSibling);
                } else {
                    parent.insertBefore(draggedElement, this);
                }
            }

            this.classList.remove('drag-over');
            return false;
        }

        // 删除块
        function deleteBlock(btn) {
            const block = btn.closest('.draggable-block');
            if (confirm('确定要删除这个内容块吗？')) {
                block.remove();
            }
        }
    </script>
</body>
</html>
